<!DOCTYPE html>
<!-- Quiz Application v1.11 -->
<!-- Latest updates: Rebuilt flashcard system, improved layout, compact progress panel -->
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìù Quiz Application v1.11</title>

    <!-- ========== PWA META TAGS ========== -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Quiz App">
    <link rel="apple-touch-icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect fill='%232563eb' width='512' height='512' rx='80'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-family='Arial' font-size='280' fill='white'%3Eüìù%3C/text%3E%3C/svg%3E">
    <meta name="description" content="Aplikacja quizowa z fiszkami, trybem nauki i ≈õledzeniem postƒôp√≥w">
    <meta name="application-name" content="Quiz App">

    <!-- Google Fonts - Typography Overhaul -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Newsreader:opsz,wght@6..72,400;6..72,600&family=JetBrains+Mono:wght@400;600&display=swap"
        rel="stylesheet">

    <style>
        /* ========== CSS VARIABLES - THEME SYSTEM ========== */
        :root {
            /* ========== TYPOGRAPHY ========== */
            /* Font Families */
            --font-body: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-display: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-question: 'Newsreader', Georgia, 'Times New Roman', serif;
            --font-mono: 'JetBrains Mono', 'Courier New', monospace;

            /* Type Scale (12px to 36px) */
            --text-xs: 0.75rem;
            /* 12px */
            --text-sm: 0.875rem;
            /* 14px */
            --text-base: 1rem;
            /* 16px */
            --text-lg: 1.125rem;
            /* 18px */
            --text-xl: 1.25rem;
            /* 20px */
            --text-2xl: 1.5rem;
            /* 24px */
            --text-3xl: 1.875rem;
            /* 30px */
            --text-4xl: 2.25rem;
            /* 36px */

            /* Font Weights */
            --font-normal: 400;
            --font-medium: 500;
            --font-semibold: 600;
            --font-bold: 700;

            /* Line Heights */
            --leading-tight: 1.25;
            --leading-normal: 1.5;
            --leading-relaxed: 1.75;

            /* ========== COLORS - CLASSIC THEME ========== */
            /* Primary Colors */
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;

            /* Background Colors - Warm Gray Scale */
            --bg-color: #fafafa;
            --bg-warm: #f5f5f0;
            --card-bg: #ffffff;
            --nav-bg: #2c2c2c;
            --nav-hover: #3a3a3a;

            /* Text Colors - Warm Tints */
            --text-primary: #1a1a1a;
            --text-secondary: #4a4a4a;
            --text-light: #6b6b6b;
            --text-muted: #9a9a9a;

            /* Border & Shadow */
            --border-color: #e0e0e0;
            --border-radius: 8px;
            --border-radius-large: 12px;

            /* Shadow System */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.08);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.09);

            /* Interactive States */
            --hover-lift: translateY(-2px);
            --active-press: scale(0.98);
            --transition-smooth: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);

            /* Learning State Colors */
            --state-mastered: #059669;
            /* Green - mastered */
            --state-learning: #d97706;
            /* Amber - learning */
            --state-new: #7c3aed;
            /* Purple - new */
            --state-failed: #dc2626;
            /* Red - failed */
            --state-neutral: #6b7280;
            /* Gray - neutral */

            /* Status Colors */
            --success-color: #059669;
            --danger-color: #dc2626;
            --warning-color: #d97706;
            --info-color: #0284c7;

            /* Button Colors */
            --btn-secondary-bg: #6b7280;

            /* Input Colors */
            --input-bg: #fafafa;
            --input-hover: #f0f0f0;
        }

        /* Modern Theme - PROFESSIONAL NEON (Refined) */
        [data-theme="modern"] {
            /* Primary Colors - Better Contrast */
            --primary-color: #a855f7;
            --primary-hover: #9333ea;
            --bg-color: #0f172a;
            --bg-warm: #1e293b;
            --card-bg: #1e293b;
            --nav-bg: #020617;
            --nav-hover: #1e293b;

            /* Text Colors - Improved Readability */
            --text-primary: #f8fafc;
            --text-secondary: #e2e8f0;
            --text-light: #cbd5e1;
            --text-muted: #94a3b8;

            /* Border & Shadow */
            --border-color: #334155;
            --border-radius: 12px;
            --border-radius-large: 16px;

            /* Shadow System with Glow */
            --shadow-xs: 0 1px 3px rgba(168, 85, 247, 0.1);
            --shadow-sm: 0 2px 6px rgba(168, 85, 247, 0.15);
            --shadow-md: 0 4px 12px rgba(168, 85, 247, 0.2);
            --shadow-lg: 0 10px 25px rgba(168, 85, 247, 0.25);
            --shadow-xl: 0 25px 50px rgba(168, 85, 247, 0.3);
            --glow-primary: 0 0 20px rgba(168, 85, 247, 0.4);
            --glow-success: 0 0 20px rgba(34, 197, 94, 0.4);
            --glow-danger: 0 0 20px rgba(239, 68, 68, 0.4);

            /* Learning State Colors - Neon Variants */
            --state-mastered: #22c55e;
            /* Bright Green */
            --state-learning: #f59e0b;
            /* Amber */
            --state-new: #a855f7;
            /* Purple */
            --state-failed: #ef4444;
            /* Red */
            --state-neutral: #64748b;
            /* Slate Gray */

            /* Status Colors */
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #06b6d4;

            /* Button Colors */
            --btn-secondary-bg: #475569;

            /* Input Colors */
            --input-bg: #1e293b;
            --input-hover: #334155;
        }

        /* Minimalist Theme - CLEAN & PROFESSIONAL */
        [data-theme="minimal"] {
            /* Primary Colors - Refined Black */
            --primary-color: #1c1917;
            /* Stone 900 - softer than pure black */
            --primary-hover: #292524;
            --bg-color: #fafaf9;
            /* Stone 50 */
            --bg-warm: #f5f5f4;
            --card-bg: #ffffff;
            --nav-bg: #1c1917;
            --nav-hover: #292524;

            /* Text Colors - High Contrast */
            --text-primary: #1c1917;
            --text-secondary: #44403c;
            --text-light: #78716c;
            --text-muted: #a8a29e;

            /* Border & Shadow */
            --border-color: #e7e5e4;
            --border-radius: 6px;
            --border-radius-large: 8px;

            /* Shadow System - Subtle */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 2px 6px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 8px 24px rgba(0, 0, 0, 0.12);

            /* Learning State Colors - Muted */
            --state-mastered: #059669;
            /* Green */
            --state-learning: #d97706;
            /* Amber */
            --state-new: #7c3aed;
            /* Purple */
            --state-failed: #dc2626;
            /* Red */
            --state-neutral: #78716c;
            /* Stone */

            /* Status Colors */
            --success-color: #059669;
            --danger-color: #dc2626;
            --warning-color: #d97706;
            --info-color: #0284c7;

            /* Button Colors */
            --btn-secondary-bg: #78716c;

            /* Input Colors */
            --input-bg: #fafaf9;
            --input-hover: #f5f5f4;
        }

        /* Questions section - minimal theme */
        [data-theme="minimal"] #questions-section .question-item div[style*="background"] {
            background: #f5f5f4 !important;
            border-color: #e7e5e4 !important;
        }

        /* Ordering questions - minimal theme */
        [data-theme="minimal"] .ordering-test-item {
            background: #f5f5f4;
            border-color: #e7e5e4;
        }

        [data-theme="minimal"] .ordering-test-row {
            background: #fafaf9;
            border-color: #e7e5e4;
        }

        [data-theme="minimal"] .ordering-test-row select {
            background: #ffffff;
            border-color: #e7e5e4;
            color: #1c1917;
        }

        [data-theme="minimal"] .ordering-test-step-text {
            color: #44403c;
        }

        [data-theme="minimal"] .ordering-test-step-text.used {
            color: #78716c;
        }

        /* Ordering instruction text - minimal theme */
        [data-theme="minimal"] .ordering-instruction {
            color: #44403c;
        }

        /* Ordering step number - minimal theme */
        [data-theme="minimal"] .ordering-step-number {
            color: #44403c;
        }

        /* Ordering correct sequence container - minimal theme */
        [data-theme="minimal"] .ordering-correct-sequence {
            background: #f5f5f4 !important;
            border-color: #e7e5e4 !important;
        }

        [data-theme="minimal"] .ordering-correct-sequence strong {
            color: #1c1917;
        }

        /* Preview placeholder - minimal theme */
        [data-theme="minimal"] .preview-placeholder {
            color: #78716c !important;
        }

        /* Question type label - minimal theme */
        [data-theme="minimal"] .question-type-label {
            color: #78716c !important;
        }

        /* Live preview - minimal theme */
        [data-theme="minimal"] .live-preview-content div[style*="background: #f8f9fa"],
        [data-theme="minimal"] .live-preview-content div[style*="background:#f8f9fa"] {
            background: #f5f5f4 !important;
            border-color: #e7e5e4 !important;
        }

        /* ========== BASE STYLES WITH CSS VARIABLES ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            font-size: var(--text-base);
            line-height: var(--leading-normal);
            font-weight: var(--font-normal);
            background: var(--bg-color);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: var(--font-display);
            font-weight: var(--font-semibold);
            line-height: var(--leading-tight);
            color: var(--text-primary);
        }

        h1 {
            font-size: var(--text-4xl);
            text-align: center;
            margin-bottom: 30px;
        }

        h2 {
            font-size: var(--text-3xl);
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        h3 {
            font-size: var(--text-2xl);
            margin-bottom: 16px;
        }

        h4 {
            font-size: var(--text-xl);
            margin-bottom: 14px;
        }

        p {
            margin-bottom: var(--text-base);
            line-height: var(--leading-relaxed);
        }

        /* Question text special styling */
        .question-text,
        .test-question .question-text,
        .flashcard-front .question-text,
        .flashcard-back .question-text {
            font-family: var(--font-question);
            font-size: var(--text-lg);
            line-height: var(--leading-relaxed);
            font-weight: var(--font-medium);
        }

        /* Monospace elements */
        .timer-display,
        code,
        pre,
        .mono-text {
            font-family: var(--font-mono);
        }

        /* Small text */
        small,
        .text-sm {
            font-size: var(--text-sm);
            color: var(--text-light);
        }

        /* Large text */
        .text-lg {
            font-size: var(--text-lg);
        }

        /* Muted text */
        .text-muted {
            color: var(--text-muted);
        }

        /* ========== MOTION & ANIMATIONS ========== */

        /* Smooth Transitions for Interactive Elements */
        button,
        .btn-primary,
        .btn-success,
        .btn-secondary,
        .btn-danger,
        .btn-warning {
            transition: var(--transition-smooth);
        }

        button:hover,
        .btn-primary:hover,
        .btn-success:hover,
        .btn-secondary:hover,
        .btn-danger:hover,
        .btn-warning:hover {
            transform: var(--hover-lift);
            box-shadow: var(--shadow-md);
        }

        button:active,
        .btn-primary:active,
        .btn-success:active,
        .btn-secondary:active,
        .btn-danger:active,
        .btn-warning:active {
            transform: var(--active-press);
            box-shadow: var(--shadow-sm);
        }

        /* Card Hover Effects */
        .question-item,
        .card,
        .test-question {
            transition: var(--transition-bounce);
        }

        .question-item:hover,
        .card:hover {
            transform: var(--hover-lift);
            box-shadow: var(--shadow-lg);
        }

        /* Keyframe Animations */
        @keyframes slideInLeft {
            from {
                transform: translateX(-30px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(30px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        @keyframes criticalPulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4);
            }

            50% {
                transform: scale(1.02);
                box-shadow: 0 0 0 8px rgba(220, 38, 38, 0);
            }
        }

        @keyframes fadeInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes staggerIn {
            from {
                transform: translateY(10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Staggered animation delays */
        .stagger-1 {
            animation-delay: 0.05s;
        }

        .stagger-2 {
            animation-delay: 0.1s;
        }

        .stagger-3 {
            animation-delay: 0.15s;
        }

        .stagger-4 {
            animation-delay: 0.2s;
        }

        .stagger-5 {
            animation-delay: 0.25s;
        }

        /* Enhanced Progress Bar with Shimmer */
        .progress-bar-shimmer {
            position: relative;
            overflow: hidden;
        }

        .progress-bar-shimmer::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.3),
                    transparent);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        /* Enhanced Toast Animations */
        .toast {
            animation: slideInRight 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toast.hiding {
            animation: slideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: background 0.2s;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: background 0.2s;
        }

        .btn-secondary {
            background: var(--btn-secondary-bg);
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: background 0.2s;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: background 0.2s;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-success:hover,
        .btn-secondary:hover,
        .btn-danger:hover,
        .btn-warning:hover {
            opacity: 0.9;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: inherit;
            background: var(--input-bg);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: 2px solid var(--primary-color);
            border-color: transparent;
        }

        .hidden {
            display: none;
        }

        /* ========== QUESTION ITEM - ENHANCED ========== */
        .question-item {
            background: var(--card-bg);
            padding: 32px;
            margin-bottom: 20px;
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--state-neutral);
            transition: var(--transition-bounce);
            position: relative;
        }

        .question-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .question-item.marked-for-review {
            border-left-color: var(--warning-color);
        }

        .question-item.mastered {
            border-left-color: var(--state-mastered);
        }

        .question-item.learning {
            border-left-color: var(--state-learning);
        }

        .question-item.failed {
            border-left-color: var(--state-failed);
        }

        /* Question number badge */
        .question-item::before {
            content: attr(data-question-number);
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--state-neutral);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            font-family: var(--font-mono);
        }

        .question-item p {
            font-family: var(--font-body);
            font-size: var(--text-base);
            line-height: var(--leading-relaxed);
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        /* Images in questions */
        .question-item img,
        .test-question img {
            max-width: 100%;
            max-height: 400px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            margin: 16px 0;
            object-fit: contain;
        }

        /* ========== NAVIGATION - ENHANCED ========== */
        nav {
            background: var(--nav-bg);
            padding: 8px 16px;
            margin-bottom: 24px;
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition-smooth);
        }

        nav button {
            background: transparent;
            color: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: var(--border-radius);
            font-family: var(--font-body);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }

        nav button::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--primary-color);
            transition: var(--transition-smooth);
            transform: translateX(-50%);
        }

        nav button:hover {
            background: var(--nav-hover);
            color: white;
            transform: translateY(-1px);
        }

        nav button:hover::before {
            width: 60%;
        }

        nav button.active {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        nav button.active::before {
            width: 80%;
            background: white;
        }

        /* Ukryj przyciski tylko dla administrator√≥w */
        .admin-only {
            display: none !important;
        }

        /* Poka≈º przyciski admina gdy u≈ºytkownik jest adminem */
        body.is-admin .admin-only {
            display: inline-block !important;
        }

        .test-question {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            transition: var(--transition-bounce);
        }

        .test-question h3,
        .test-question .question-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: var(--leading-relaxed);
            font-size: var(--text-lg);
            font-weight: var(--font-medium);
        }

        .test-question h3 div,
        .test-question h3 p,
        .test-question .question-text div,
        .test-question .question-text p {
            display: block;
            margin: 8px 0;
        }

        .test-question h3 ul,
        .test-question .question-text ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .test-question h3 li,
        .test-question .question-text li {
            margin: 4px 0;
        }

        /* Test Option - Enhanced with Staggered Animation */
        .test-option {
            background: var(--input-bg);
            padding: 14px 16px;
            margin: 8px 0;
            border-radius: var(--border-radius);
            cursor: pointer;
            border: 2px solid transparent;
            transition: var(--transition-smooth);
            animation: staggerIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) backwards;
            position: relative;
            overflow: hidden;
        }

        .test-option::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: var(--state-neutral);
            transition: var(--transition-smooth);
        }

        .test-option:hover {
            background: var(--input-hover);
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }

        .test-option:hover::before {
            background: var(--primary-color);
        }

        .test-option.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .test-option.selected::before {
            background: white;
        }

        .test-option.correct {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .test-option.correct::before {
            background: white;
        }

        .test-option.incorrect {
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        .test-option.incorrect::before {
            background: white;
        }

        .test-option.disabled {
            pointer-events: none;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .feedback-box {
            padding: 15px;
            margin: 15px 0;
            border-radius: var(--border-radius);
            font-weight: bold;
        }

        .feedback-correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback-incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .feedback-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .explanation-box {
            background: #e7f3ff;
            padding: 15px;
            margin: 15px 0;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
        }

        .explanation-box a {
            color: #0056b3;
            text-decoration: underline;
            font-weight: 500;
        }

        .explanation-box a:hover {
            color: #004494;
            text-decoration: none;
        }

        /* Related Questions Box */
        .related-questions {
            animation: fadeInUp 0.4s ease-out;
        }

        .related-questions h4 {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .related-questions ul li {
            transition: var(--transition-smooth);
        }

        .related-questions ul li:hover {
            background: var(--input-hover);
            border-radius: var(--border-radius);
            padding-left: 8px !important;
        }

        .practice-stats {
            background: var(--input-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            text-align: center;
        }

        /* ========== ANALYTICS & CHARTS ========== */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .analytics-card {
            background: var(--card-bg);
            border-radius: var(--border-radius-large);
            padding: 24px;
            box-shadow: var(--shadow-md);
            transition: var(--transition-smooth);
        }

        .analytics-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .analytics-card h3 {
            font-size: var(--text-lg);
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Simple bar chart using CSS */
        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 16px 0;
        }

        .bar-chart-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bar-chart-label {
            min-width: 120px;
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }

        .bar-chart-bar-container {
            flex: 1;
            height: 32px;
            background: var(--input-hover);
            border-radius: var(--border-radius);
            overflow: hidden;
            position: relative;
        }

        .bar-chart-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color) 0%, #4f46e5 100%);
            transition: width var(--transition-bounce);
            border-radius: var(--border-radius);
            position: relative;
        }

        .bar-chart-bar.low {
            background: linear-gradient(90deg, var(--danger-color) 0%, #ef4444 100%);
        }

        .bar-chart-bar.medium {
            background: linear-gradient(90deg, var(--warning-color) 0%, #f59e0b 100%);
        }

        .bar-chart-bar.high {
            background: linear-gradient(90deg, var(--success-color) 0%, #22c55e 100%);
        }

        .bar-chart-value {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            text-shadow: 0 0 4px rgba(255, 255, 255, 0.5);
        }

        /* Line chart placeholder */
        .line-chart {
            width: 100%;
            height: 200px;
            background: var(--input-hover);
            border-radius: var(--border-radius);
            position: relative;
            overflow: hidden;
            margin: 16px 0;
        }

        .line-chart svg {
            width: 100%;
            height: 100%;
        }

        /* Metric cards */
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
        }

        .metric-card {
            background: var(--bg-warm);
            padding: 16px;
            border-radius: var(--border-radius);
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .metric-value {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            font-family: var(--font-mono);
            color: var(--primary-color);
            margin: 8px 0;
        }

        .metric-label {
            font-size: var(--text-sm);
            color: var(--text-light);
        }

        .metric-trend {
            font-size: var(--text-xs);
            margin-top: 4px;
        }

        .metric-trend.up {
            color: var(--success-color);
        }

        .metric-trend.down {
            color: var(--danger-color);
        }

        .metric-trend.neutral {
            color: var(--text-muted);
        }

        /* Weak areas badges */
        .weak-area-badge {
            display: inline-block;
            padding: 6px 12px;
            margin: 4px;
            background: var(--danger-color);
            color: white;
            border-radius: var(--border-radius);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            animation: fadeInUp 0.3s ease-out;
        }

        .strong-area-badge {
            display: inline-block;
            padding: 6px 12px;
            margin: 4px;
            background: var(--success-color);
            color: white;
            border-radius: var(--border-radius);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            animation: fadeInUp 0.3s ease-out;
        }

        /* Progress over time chart */
        .progress-chart-container {
            margin: 16px 0;
            padding: 16px;
            background: var(--bg-warm);
            border-radius: var(--border-radius);
        }

        .progress-chart-message {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            text-align: center;
            margin-top: 12px;
        }

        /* ========== SPACED REPETITION SYSTEM (SRS) ========== */
        .srs-dashboard {
            background: linear-gradient(135deg, var(--primary-color) 0%, #4f46e5 100%);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius-large);
            margin-bottom: 20px;
            box-shadow: var(--shadow-lg);
        }

        .srs-dashboard h3 {
            color: white;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .srs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .srs-metric {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 16px;
            border-radius: var(--border-radius);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .srs-metric-value {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            margin: 8px 0;
        }

        .srs-metric-label {
            font-size: var(--text-xs);
            opacity: 0.9;
        }

        .srs-due-cards {
            background: var(--warning-color);
            color: white;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: var(--font-semibold);
            animation: pulse 2s infinite;
        }

        .srs-next-review {
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            font-size: var(--text-sm);
        }

        .srs-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .srs-button {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: var(--border-radius);
            font-size: var(--text-base);
            font-weight: var(--font-semibold);
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .srs-button.again {
            background: var(--danger-color);
            color: white;
        }

        .srs-button.hard {
            background: var(--warning-color);
            color: white;
        }

        .srs-button.good {
            background: var(--info-color);
            color: white;
        }

        .srs-button.easy {
            background: var(--success-color);
            color: white;
        }

        .srs-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .srs-button small {
            font-size: var(--text-xs);
            opacity: 0.8;
        }

        /* Notes system */
        .notes-container {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-warm);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--info-color);
        }

        .notes-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: var(--font-body);
            font-size: var(--text-base);
            resize: vertical;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: var(--transition-smooth);
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .notes-list {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .note-item {
            padding: 12px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            animation: fadeInUp 0.3s ease-out;
        }

        .note-item-content {
            font-size: var(--text-sm);
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .note-item-date {
            font-size: var(--text-xs);
            color: var(--text-muted);
            margin-top: 8px;
        }

        .note-item-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .note-item-actions button {
            padding: 4px 8px;
            font-size: var(--text-xs);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .note-item-delete {
            background: var(--danger-color);
            color: white;
        }

        .note-item-delete:hover {
            background: #dc2626;
        }

        /* Notes Modal */
        .notes-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }

        .notes-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        .notes-modal-content {
            position: relative;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
            animation: slideInUp 0.3s ease-out;
        }

        .notes-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .notes-modal-header h2 {
            margin: 0;
            font-size: var(--text-xl);
            color: var(--text-primary);
        }

        .notes-modal-close {
            background: none;
            border: none;
            font-size: 32px;
            color: var(--text-muted);
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: var(--transition-smooth);
        }

        .notes-modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .notes-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        /* Export section */
        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        .export-option {
            padding: 16px;
            background: var(--bg-warm);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .export-option:hover {
            border-color: var(--primary-color);
            background: var(--card-bg);
            transform: translateY(-2px);
        }

        .export-option h4 {
            margin: 8px 0 4px;
            color: var(--text-primary);
        }

        .export-option p {
            font-size: var(--text-sm);
            color: var(--text-light);
            margin: 0;
        }

        /* Progress Bar - Enhanced */
        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--input-hover);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        #progressBar {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color) 0%, var(--state-mastered) 100%);
            transition: width var(--transition-bounce);
            position: relative;
        }

        /* Progress Bar Shimmer Effect */
        #progressBar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.4),
                    transparent);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        ul.question-options {
            list-style: none;
            padding-left: 0;
        }

        ul.question-options li {
            padding: 5px 0;
        }

        .question-item p {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
        }

        /* Styles for detailed results view */
        .detailed-result-summary {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .detailed-result-summary h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .result-badge {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 8px;
            font-weight: bold;
        }

        .result-badge.score {
            background: #007bff;
            color: white;
            font-size: 1.5em;
        }

        .result-badge.correct {
            background: #28a745;
            color: white;
        }

        .result-badge.incorrect {
            background: #dc3545;
            color: white;
        }

        .result-badge.skipped {
            background: #ffc107;
            color: #333;
        }

        .question-review-item {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #6c757d;
        }

        .question-review-item.correct-answer {
            border-left-color: #28a745;
        }

        .question-review-item.incorrect-answer {
            border-left-color: #dc3545;
        }

        .question-review-item.skipped-answer {
            border-left-color: #ffc107;
        }

        .review-option {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            background: #f8f9fa;
            border: 2px solid transparent;
        }

        .review-option.user-selected {
            background: #e7f3ff;
            border-color: #007bff;
        }

        .review-option.correct-answer {
            background: #d4edda;
            border-color: #28a745;
        }

        .review-option.incorrect-selection {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .review-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .back-btn {
            margin-top: 20px;
        }

        /* Timer Styles - Enhanced */
        .test-timer {
            background: var(--card-bg);
            padding: 20px 24px;
            margin-bottom: 20px;
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-lg);
            text-align: center;
            font-size: var(--text-3xl);
            font-weight: var(--font-semibold);
            font-family: var(--font-mono);
            border: 3px solid var(--success-color);
            color: var(--success-color);
            transition: var(--transition-bounce);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .test-timer:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-xl);
        }

        .test-timer .timer-icon {
            font-size: var(--text-2xl);
        }

        /* Warning state - < 5 minutes */
        .test-timer.timer-warning {
            border-color: var(--warning-color);
            color: var(--warning-color);
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(245, 158, 6, 0.1) 100%);
        }

        .test-timer.timer-critical {
            border-color: var(--danger-color);
            color: var(--danger-color);
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(220, 38, 38, 0.15) 100%);
            animation: criticalPulse 1s infinite;
        }

        /* Pagination Styles */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            font-weight: bold;
            color: #495057;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f8f9fa;
        }

        .pagination-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .pagination-page-size {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .pagination-page-size select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Styles for categories and tags */
        .category-badge {
            display: inline-block;
            padding: 6px 12px;
            margin: 4px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: bold;
            background: #007bff;
            color: white;
        }

        .tag {
            display: inline-block;
            padding: 4px 10px;
            margin: 3px;
            border-radius: 4px;
            font-size: 0.8em;
            background: #e9ecef;
            color: #495057;
            border: 1px solid #dee2e6;
        }

        .category-stats {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .category-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }

        .category-stat-name {
            font-weight: bold;
            color: #333;
        }

        .category-stat-count {
            background: #007bff;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .tags-input-container {
            position: relative;
        }

        .tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .tag-item {
            display: inline-flex;
            align-items: center;
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .tag-item span {
            margin-right: 5px;
        }

        .tag-remove {
            cursor: pointer;
            font-weight: bold;
            margin-left: 5px;
        }

        .tag-remove:hover {
            color: #ffcccc;
        }

        /* WYSIWYG Editor Styles */
        .wysiwyg-container {
            margin-bottom: 15px;
        }

        .wysiwyg-toolbar {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            padding: 8px;
            display: flex;
            gap: 5px;
        }

        .wysiwyg-toolbar button {
            background: white;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .wysiwyg-toolbar button:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .wysiwyg-toolbar button:active {
            background: #dee2e6;
        }

        .wysiwyg-editor {
            border: 1px solid #ddd;
            border-radius: 0 0 5px 5px;
            padding: 12px;
            min-height: 120px;
            max-height: 300px;
            overflow-y: auto;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            background: white;
        }

        .wysiwyg-editor:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
        }

        .wysiwyg-editor ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .wysiwyg-editor li {
            margin: 4px 0;
        }

        /* Dynamic Options Styles */
        .option-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .option-row input[type="text"] {
            flex: 1;
            margin: 0;
        }

        .option-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .option-row label {
            margin: 0;
            font-size: 18px;
            color: #28a745;
            cursor: pointer;
            user-select: none;
        }

        .option-remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .option-remove-btn:hover {
            background: #c82333;
        }

        .add-option-btn {
            width: 100%;
            background: #28a745;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .add-option-btn:hover {
            background: #218838;
        }

        .add-option-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* Ordering Steps Styles */
        .ordering-step-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .ordering-step-number {
            font-weight: bold;
            color: #007bff;
            min-width: 30px;
            text-align: center;
        }

        .ordering-step-row input[type="text"] {
            flex: 1;
            margin: 0;
        }

        .ordering-step-actions {
            display: flex;
            gap: 5px;
        }

        .ordering-step-actions button {
            padding: 5px 10px;
            font-size: 14px;
        }

        .ordering-test-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .ordering-test-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .ordering-test-row select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            min-width: 80px;
        }

        .ordering-test-step-text {
            flex: 1;
            line-height: 1.5;
        }

        .ordering-test-step-text.used {
            color: #999;
            text-decoration: line-through;
        }

        /* Ordering instruction text */
        .ordering-instruction {
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }

        /* Ordering correct sequence container */
        .ordering-correct-sequence {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .ordering-correct-sequence strong {
            color: #333;
        }

        /* Preview placeholder */
        .preview-placeholder {
            color: #999;
            text-align: center;
            padding: 20px;
        }

        /* Question type label */
        .question-type-label {
            color: #666;
            margin-bottom: 10px;
        }

        /* Live Preview Styles */
        .live-preview-container {
            margin-top: 20px;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 8px;
            border: 2px dashed #ccc;
        }

        .live-preview-container h3,
        .live-preview-container .question-text {
            margin-bottom: 15px;
            color: #555;
            font-size: 16px;
            font-weight: normal;
        }

        .live-preview-content {
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .live-preview-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .live-preview-content li {
            margin: 4px 0;
        }

        /* ========== FISZKI - FLASHCARDS (REBUILT FROM SCRATCH) ========== */
        .flashcard-container {
            perspective: 1000px;
            width: 100%;
            max-width: 700px;
            margin: 30px auto;
            margin-bottom: 30px;
        }

        .flashcard {
            position: relative;
            width: 100%;
            min-height: 600px;
            transform-style: preserve-3d;
            -webkit-transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
            -webkit-transform: rotateY(180deg);
        }

        .flashcard-face {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            box-sizing: border-box;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        .flashcard-front {
            background: linear-gradient(135deg, var(--primary-color) 0%, #4f46e5 100%);
        }

        .flashcard-back {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            transform: rotateY(180deg);
            -webkit-transform: rotateY(180deg);
        }

        .flashcard-content {
            max-width: 600px;
            width: 100%;
            text-align: center;
            color: white;
        }

        .flashcard-content .question-text {
            font-family: var(--font-question);
            font-size: 19px;
            font-weight: var(--font-medium);
            line-height: var(--leading-relaxed);
            margin-bottom: 16px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .flashcard-content .question-text div,
        .flashcard-content .question-text p {
            display: block;
            margin: 8px 0;
        }

        .flashcard-content .question-text ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .flashcard-content .question-text li {
            margin: 4px 0;
        }

        /* Hint text */
        .flashcard-hint {
            margin-top: 24px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.25);
            border-radius: 8px;
            font-size: 14px;
            color: white;
            backdrop-filter: blur(10px);
        }

        /* Options on back of card */
        .flashcard-options {
            margin-top: 24px;
            width: 100%;
            max-width: 600px;
        }

        .flashcard-option {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            padding: 14px 18px;
            margin: 10px 0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .flashcard-option.correct {
            background: rgba(34, 197, 94, 0.95);
            border-color: rgba(255, 255, 255, 0.5);
            font-weight: 600;
        }

        .flashcard-option .option-number {
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.95);
            color: #059669;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 14px;
            font-weight: 700;
            font-family: monospace;
            font-size: 16px;
            flex-shrink: 0;
        }

        .flashcard-option.correct .option-number {
            background: #ffffff;
            color: #059669;
            font-weight: 800;
        }

        /* Rating buttons */
        .flashcard-rating {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            width: 100%;
            max-width: 600px;
        }

        .flashcard-rating button {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            transition: transform 0.2s;
        }

        .flashcard-rating button:active {
            transform: scale(0.95);
        }

        .btn-know {
            background: var(--success-color);
        }

        .btn-dont-know {
            background: var(--danger-color);
        }

        .srs-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            width: 100%;
        }

        .srs-button {
            padding: 12px 8px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            text-align: center;
        }

        .srs-button.again {
            background: #dc2626;
        }

        .srs-button.hard {
            background: #f59e0b;
        }

        .srs-button.good {
            background: #3b82f6;
        }

        .srs-button.easy {
            background: #10b981;
        }

        /* Progress bar */
        .flashcard-progress {
            background: var(--card-bg);
            padding: 12px;
            border-radius: 12px;
            margin-top: 12px;
            box-shadow: var(--shadow-md);
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .flashcard-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--input-hover);
            border-radius: 6px;
            overflow: hidden;
            margin: 8px 0;
        }

        .flashcard-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color) 0%, #4f46e5 100%);
            transition: width 0.3s;
        }

        /* Stats */
        .flashcard-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 12px;
            gap: 8px;
        }

        .flashcard-stat {
            text-align: center;
            padding: 8px 12px;
            background: var(--input-bg);
            border-radius: 8px;
        }

        .flashcard-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .flashcard-stat-label {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 2px;
        }

        /* Keyboard hints - compact */
        .flashcard-keyboard-hint {
            background: var(--card-bg);
            padding: 10px 16px;
            border-radius: 8px;
            margin-top: 16px;
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .flashcard-keyboard-hint kbd {
            background: var(--input-bg);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-family: monospace;
            font-size: 11px;
            font-weight: 600;
            margin: 0 2px;
            white-space: nowrap;
        }

        /* CSS VARIABLES dla Dark/Light mode */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #495057;
            --border-color: #dee2e6;
            --input-bg: #ffffff;
            --hover-bg: #f8f9fa;
        }

        body.dark-mode {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #f0f6fc;
            --text-secondary: #c9d1d9;
            --border-color: #30363d;
            --input-bg: #0d1117;
            --hover-bg: #21262d;
        }

        /* ========== DARK MODE ========== */
        body.dark-mode {
            background: #0d1117;
            color: #c9d1d9;
        }

        body.dark-mode .container {
            background: #161b22;
            border: 1px solid #30363d;
        }

        body.dark-mode h1,
        body.dark-mode h2,
        body.dark-mode h3,
        body.dark-mode h4 {
            color: #f0f6fc;
        }

        body.dark-mode .question-item {
            background: #21262d !important;
            color: #c9d1d9 !important;
            border: 1px solid #30363d !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* Override inline styles - bardzo agresywne */
        body.dark-mode div[style*="background"],
        body.dark-mode div[style*="background: #"],
        body.dark-mode div[style*="background:#"] {
            background: #21262d !important;
        }

        body.dark-mode .question-item>div>div[style*="background"] {
            background: #161b22 !important;
        }

        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background: #0d1117;
            color: #c9d1d9;
            border: 1px solid #30363d;
        }

        body.dark-mode input:focus,
        body.dark-mode select:focus,
        body.dark-mode textarea:focus {
            border-color: #58a6ff;
            background: #161b22;
            outline: none;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        body.dark-mode input::placeholder {
            color: #6e7681;
        }

        body.dark-mode .test-option {
            background: #161b22;
            border: 2px solid #30363d;
            color: #c9d1d9;
        }

        body.dark-mode .test-option:hover {
            background: #21262d;
            border-color: #58a6ff;
        }

        body.dark-mode .test-option.selected {
            background: #1f6feb;
            border-color: #1f6feb;
            color: #ffffff;
        }

        body.dark-mode .test-question .question-text {
            color: #f0f6fc;
        }

        body.dark-mode .category-badge {
            background: #1f6feb;
            color: #ffffff;
            border: 1px solid #388bfd;
        }

        body.dark-mode .tag {
            background: #21262d;
            color: #58a6ff;
            border: 1px solid #30363d;
        }

        body.dark-mode .explanation-box {
            background: #161b22;
            border: 1px solid #30363d;
            color: #c9d1d9;
        }

        body.dark-mode nav {
            background: #161b22;
            border-bottom: 2px solid #30363d;
        }

        body.dark-mode nav a {
            color: #8b949e;
        }

        body.dark-mode nav a:hover {
            background: #21262d;
            color: #c9d1d9;
        }

        body.dark-mode nav a.active {
            background: #1f6feb;
            color: #ffffff;
        }

        body.dark-mode .auth-container {
            background: #21262d;
            border: 1px solid #30363d;
        }

        body.dark-mode .wysiwyg-editor {
            background: #0d1117;
            color: #c9d1d9;
            border: 1px solid #30363d;
        }

        body.dark-mode .wysiwyg-toolbar button {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
        }

        body.dark-mode .wysiwyg-toolbar button:hover {
            background: #30363d;
            border-color: #58a6ff;
        }

        body.dark-mode .live-preview-content {
            background: #161b22;
            border: 1px solid #30363d;
        }

        /* Buttons in dark mode */
        body.dark-mode button {
            color: #c9d1d9;
        }

        body.dark-mode .btn-primary {
            background: #1f6feb;
            border-color: #388bfd;
            color: #ffffff;
        }

        body.dark-mode .btn-primary:hover {
            background: #388bfd;
        }

        body.dark-mode .btn-success {
            background: #238636;
            border-color: #2ea043;
            color: #ffffff;
        }

        body.dark-mode .btn-success:hover {
            background: #2ea043;
        }

        body.dark-mode .btn-danger {
            background: #da3633;
            border-color: #f85149;
            color: #ffffff;
        }

        body.dark-mode .btn-danger:hover {
            background: #f85149;
        }

        body.dark-mode .btn-warning {
            background: #d29922;
            border-color: #9a6700;
            color: #ffffff;
        }

        body.dark-mode .btn-warning:hover {
            background: #9a6700;
        }

        body.dark-mode .btn-secondary {
            background: #21262d;
            border-color: #30363d;
            color: #c9d1d9;
        }

        body.dark-mode .btn-secondary:hover {
            background: #30363d;
        }

        /* Stats and badges */
        body.dark-mode .question-options {
            color: #c9d1d9;
        }

        body.dark-mode strong {
            color: #f0f6fc;
        }

        /* Stats containers */
        body.dark-mode .category-stats {
            background: #21262d;
            border: 1px solid #30363d;
            padding: 15px;
            border-radius: 8px;
        }

        body.dark-mode .category-stat-item {
            background: #0d1117;
            border: 1px solid #30363d;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.dark-mode .category-stat-item:hover {
            background: #161b22;
            border-color: #58a6ff;
        }

        body.dark-mode .category-stat-name {
            color: #f0f6fc;
            font-weight: 500;
        }

        body.dark-mode .category-stat-count {
            color: #58a6ff;
            font-weight: bold;
            font-size: 1.1em;
        }

        /* Dashboard stats */
        body.dark-mode .dashboard-stats h3 {
            color: #f0f6fc;
            border-bottom: 2px solid #30363d;
            padding-bottom: 10px;
        }

        /* Main dashboard question items */
        body.dark-mode #dashboard-section .question-item {
            background: #21262d;
            border: 1px solid #30363d;
        }

        body.dark-mode #dashboard-section .question-item h2 {
            color: #f0f6fc;
            border-bottom: 1px solid #30363d;
            padding-bottom: 8px;
        }

        body.dark-mode #dashboard-section .question-item p {
            color: #c9d1d9;
            font-size: 1.1em;
            margin: 8px 0;
        }

        body.dark-mode #dashboard-section .question-item strong {
            color: #58a6ff;
        }

        /* Flashcards */
        body.dark-mode #flashcard {
            background: #21262d;
            border: 2px solid #30363d;
        }

        body.dark-mode #flashcard-question {
            color: #f0f6fc;
        }

        body.dark-mode #flashcard-answer-question {
            color: #c9d1d9;
        }

        body.dark-mode .flashcard-option {
            background: #161b22;
            border: 1px solid #30363d;
        }

        body.dark-mode .flashcard-option .option-number {
            background: rgba(255, 255, 255, 0.95);
            color: #059669;
        }

        body.dark-mode .flashcard-option.correct {
            background: #238636;
            border-color: #2ea043;
            color: #ffffff;
        }

        body.dark-mode .flashcard-option.correct .option-number {
            background: #ffffff;
            color: #059669;
        }

        /* Results */
        body.dark-mode #results-section .question-item {
            background: #21262d;
            border: 2px solid #30363d;
        }

        body.dark-mode .result-item {
            background: #0d1117;
            border: 2px solid #30363d;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }

        body.dark-mode .result-item:hover {
            background: #161b22;
            border-color: #58a6ff;
        }

        body.dark-mode .result-item h3 {
            color: #f0f6fc;
        }

        body.dark-mode .result-item p {
            color: #c9d1d9;
        }

        body.dark-mode .result-item strong {
            color: #58a6ff;
        }

        body.dark-mode .detailed-result-item {
            background: #0d1117;
            border: 2px solid #30363d;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }

        body.dark-mode .detailed-result-item:hover {
            background: #161b22;
            border-color: #58a6ff;
        }

        body.dark-mode .detailed-result-summary {
            background: #21262d;
            border: 2px solid #30363d;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
        }

        body.dark-mode .detailed-result-summary h3 {
            color: #f0f6fc;
            border-bottom: 2px solid #58a6ff;
            padding-bottom: 10px;
        }

        body.dark-mode .detailed-result-summary p {
            color: #c9d1d9;
        }

        /* Progress bars */
        body.dark-mode #test-progress-bar {
            background: #30363d;
        }

        body.dark-mode #test-progress-fill {
            background: #1f6feb;
        }

        /* List styling */
        body.dark-mode ul,
        body.dark-mode ol {
            color: #c9d1d9;
        }

        body.dark-mode li {
            color: #c9d1d9;
        }

        /* Better visibility for small text */
        body.dark-mode small {
            color: #8b949e;
        }

        /* Links */
        body.dark-mode a {
            color: #58a6ff;
        }

        body.dark-mode a:hover {
            color: #79c0ff;
        }

        /* Formularze i inputy */
        body.dark-mode form {
            color: #c9d1d9;
        }

        body.dark-mode label {
            color: #f0f6fc;
            font-weight: 500;
        }

        body.dark-mode ::placeholder {
            color: #6e7681;
        }

        /* Sekcje */
        body.dark-mode #practice-section,
        body.dark-mode #test-section,
        body.dark-mode #flashcards-section {
            color: #c9d1d9;
        }

        /* Practice mode */
        body.dark-mode #practice-interface {
            background: #161b22;
            border: 1px solid #30363d;
        }

        body.dark-mode #practice-question h3 {
            color: #f0f6fc;
        }

        body.dark-mode #practice-feedback {
            background: #0d1117;
            border: 2px solid #30363d;
        }

        body.dark-mode #practice-feedback.correct {
            background: #1a3f1a;
            border-color: #238636;
        }

        body.dark-mode #practice-feedback.incorrect {
            background: #3d1a1a;
            border-color: #da3633;
        }

        /* Test mode */
        body.dark-mode #test-interface {
            background: #161b22;
            border: 1px solid #30363d;
        }

        body.dark-mode #test-progress-container {
            background: #0d1117;
            border: 1px solid #30363d;
        }

        /* Test i practice options */
        body.dark-mode .practice-option,
        body.dark-mode .test-option-div {
            background: #0d1117;
            border: 2px solid #30363d;
            color: #c9d1d9;
        }

        body.dark-mode .practice-option:hover,
        body.dark-mode .test-option-div:hover {
            background: #161b22;
            border-color: #58a6ff;
        }

        body.dark-mode .practice-option.selected {
            background: #1f6feb;
            border-color: #1f6feb;
            color: #ffffff;
        }

        /* Formularz dodawania pyta≈Ñ */
        body.dark-mode #add-question-form {
            background: #21262d;
            border: 1px solid #30363d;
            padding: 20px;
            border-radius: 8px;
        }

        body.dark-mode #add-question-form h3 {
            color: #f0f6fc;
            border-bottom: 2px solid #30363d;
            padding-bottom: 10px;
        }

        body.dark-mode #add-question-form .form-group {
            margin-bottom: 15px;
        }

        body.dark-mode #add-question-form .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        body.dark-mode #live-preview {
            background: #0d1117;
            border: 2px solid #30363d;
            border-radius: 8px;
            padding: 15px;
        }

        body.dark-mode #live-preview h3,
        body.dark-mode #live-preview .question-text {
            color: #f0f6fc;
            border-bottom: 1px solid #30363d;
            padding-bottom: 8px;
            font-weight: normal;
        }

        body.dark-mode #live-preview div[style*="background: #f8f9fa"],
        body.dark-mode #live-preview div[style*="background:#f8f9fa"] {
            background: #161b22 !important;
            border: 1px solid #30363d;
        }

        /* Options w formularzu */
        body.dark-mode #options-container input[type="text"] {
            background: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 8px 12px;
        }

        body.dark-mode #options-container input[type="text"]:focus {
            border-color: #58a6ff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        /* Checkboxy w formularzu */
        body.dark-mode input[type="checkbox"] {
            accent-color: #58a6ff;
        }

        /* Tag input */
        body.dark-mode .tags-input-container {
            background: #0d1117;
            border: 1px solid #30363d;
        }

        body.dark-mode .tag-item {
            background: #1f6feb;
            color: #ffffff;
            border: none;
        }

        body.dark-mode .tag-remove {
            color: #ffffff;
        }

        /* Datalist */
        body.dark-mode datalist {
            background: #21262d;
            border: 1px solid #30363d;
        }

        body.dark-mode datalist option {
            background: #161b22;
            color: #c9d1d9;
        }

        /* Import/Eksport boxes */
        body.dark-mode #questions-section .question-item div[style*="background"] {
            background: #21262d !important;
            border: 1px solid #30363d;
        }

        body.dark-mode #questions-section .question-item>div[style*="background"] h4 {
            color: #f0f6fc;
        }

        /* Admin panel */
        body.dark-mode #admin-section .question-item {
            background: #21262d;
            border: 1px solid #30363d;
        }

        body.dark-mode #admin-section .question-item h3 {
            color: #f0f6fc;
        }

        body.dark-mode #admin-users-list {
            background: #161b22;
            border: 1px solid #30363d;
        }

        /* User items w adminie */
        body.dark-mode .user-item {
            background: #0d1117;
            border: 1px solid #30363d;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
        }

        body.dark-mode .user-item h4 {
            color: #f0f6fc;
        }

        body.dark-mode .user-item p {
            color: #c9d1d9;
        }

        /* Toggle section - collapsible headers */
        body.dark-mode .question-item>div[style*="cursor: pointer"] {
            background: #21262d;
            border: 1px solid #30363d;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        body.dark-mode .question-item>div[style*="cursor: pointer"]:hover {
            background: #30363d;
            border-color: #58a6ff;
        }

        body.dark-mode .question-item>div[style*="cursor: pointer"] h2,
        body.dark-mode .question-item>div[style*="cursor: pointer"] h3 {
            color: #f0f6fc;
            margin: 0;
        }

        /* Global dark mode improvements */
        body.dark-mode .question-item p {
            color: #c9d1d9;
        }

        body.dark-mode .question-item div[style*="white-space"] {
            color: #c9d1d9;
        }

        /* Answer lists */
        body.dark-mode .question-options li {
            color: #c9d1d9;
            padding: 4px 0;
        }

        body.dark-mode .question-options li[style*="green"] {
            color: #3fb950;
        }

        /* Hidden class fix */
        body.dark-mode .hidden {
            display: none !important;
        }

        /* Alerts replacement */
        body.dark-mode div[style*="background: white"] {
            background: #21262d !important;
            border: 1px solid #30363d !important;
            color: #c9d1d9 !important;
        }

        body.dark-mode div[style*="background: #f8f9fa"],
        body.dark-mode div[style*="background: #e7f3ff"],
        body.dark-mode div[style*="background: #fff3cd"],
        body.dark-mode div[style*="background: #d4edda"] {
            background: #21262d !important;
            border: 1px solid #30363d !important;
        }

        body.dark-mode div[style*="border-left: 4px solid"] {
            border-left-width: 4px !important;
        }

        /* Feedback boxes - dark mode */
        body.dark-mode .feedback-box {
            background: #161b22;
            border: 1px solid #30363d;
            color: #c9d1d9;
        }

        body.dark-mode .feedback-correct {
            background: #0d3620;
            color: #3fb950;
            border: 1px solid #238636;
        }

        body.dark-mode .feedback-incorrect {
            background: #3d1515;
            color: #f85149;
            border: 1px solid #da3633;
        }

        body.dark-mode .feedback-info {
            background: #0c2d6b;
            color: #58a6ff;
            border: 1px solid #1f6feb;
        }

        /* Feedback boxes with inline styles - dark mode */
        body.dark-mode .feedback-box[style*="background: #fff3cd"],
        body.dark-mode .feedback-box[style*="background:#fff3cd"],
        body.dark-mode .feedback-box[style*="background: #f8d7da"],
        body.dark-mode .feedback-box[style*="background:#f8d7da"],
        body.dark-mode .feedback-box[style*="background: #d1ecf1"],
        body.dark-mode .feedback-box[style*="background:#d1ecf1"],
        body.dark-mode .feedback-box[style*="background: #d4edda"],
        body.dark-mode .feedback-box[style*="background:#d4edda"] {
            background: #161b22 !important;
            border: 1px solid #30363d !important;
            color: #c9d1d9 !important;
        }

        body.dark-mode .feedback-box[style*="color: #856404"],
        body.dark-mode .feedback-box[style*="color:#856404"] {
            color: #c9d1d9 !important;
        }

        body.dark-mode .feedback-box[style*="color: #721c24"],
        body.dark-mode .feedback-box[style*="color:#721c24"] {
            color: #f85149 !important;
        }

        body.dark-mode .feedback-box[style*="color: #0c5460"],
        body.dark-mode .feedback-box[style*="color:#0c5460"] {
            color: #58a6ff !important;
        }

        /* Review status badges - dark mode */
        body.dark-mode .review-status {
            background: #161b22;
            border: 1px solid #30363d;
        }

        body.dark-mode .review-status[style*="background: #ffc107"],
        body.dark-mode .review-status[style*="background:#ffc107"] {
            background: #854d0e !important;
            color: #fbbf24 !important;
            border: 1px solid #a16207 !important;
        }

        body.dark-mode .review-status[style*="background: #28a745"],
        body.dark-mode .review-status[style*="background:#28a745"] {
            background: #238636 !important;
            color: #3fb950 !important;
            border: 1px solid #2ea043 !important;
        }

        body.dark-mode .review-status[style*="background: #dc3545"],
        body.dark-mode .review-status[style*="background:#dc3545"] {
            background: #da3633 !important;
            color: #f85149 !important;
            border: 1px solid #f85149 !important;
        }

        body.dark-mode .review-status[style*="color: #333"],
        body.dark-mode .review-status[style*="color:#333"] {
            color: #c9d1d9 !important;
        }

        /* Small text color overrides */
        body.dark-mode small[style*="color: #666"],
        body.dark-mode small[style*="color:#666"] {
            color: #8b949e !important;
        }

        /* Light gray text color overrides */
        body.dark-mode [style*="color: #999"],
        body.dark-mode [style*="color:#999"] {
            color: #c9d1d9 !important;
        }

        /* Medium gray text color overrides */
        body.dark-mode [style*="color: #666"],
        body.dark-mode [style*="color:#666"] {
            color: #8b949e !important;
        }

        /* Bootstrap gray color overrides */
        body.dark-mode [style*="color: #6c757d"],
        body.dark-mode [style*="color:#6c757d"] {
            color: #8b949e !important;
        }

        /* Notes modal dark mode */
        body.dark-mode .notes-modal-content {
            background: #161b22;
            border-color: #30363d;
        }

        body.dark-mode .notes-modal-header {
            border-bottom-color: #30363d;
        }

        body.dark-mode .notes-modal-header h2 {
            color: #f0f6fc;
        }

        body.dark-mode .notes-modal-close {
            color: #8b949e;
        }

        body.dark-mode .notes-modal-close:hover {
            background: #30363d;
            color: #c9d1d9;
        }

        body.dark-mode .notes-modal-body {
            background: #161b22;
        }

        /* Pagination dark mode */
        body.dark-mode .pagination-container {
            background: #161b22;
            border: 1px solid #30363d;
        }

        body.dark-mode .pagination-info {
            color: #c9d1d9;
        }

        body.dark-mode .pagination-btn {
            background: #21262d;
            border-color: #30363d;
            color: #c9d1d9;
        }

        body.dark-mode .pagination-btn:hover:not(:disabled) {
            background: #1f6feb;
            border-color: #1f6feb;
            color: #ffffff;
        }

        body.dark-mode .pagination-btn:disabled {
            background: #161b22;
        }

        body.dark-mode .pagination-btn.active {
            background: #1f6feb;
            border-color: #1f6feb;
            color: #ffffff;
        }

        body.dark-mode .pagination-page-size {
            background: #161b22;
            border: 1px solid #30363d;
        }

        body.dark-mode .pagination-page-size select {
            background: #0d1117;
            border-color: #30363d;
            color: #c9d1d9;
        }

        /* Metric cards dark mode */
        body.dark-mode .metric-card {
            background: #161b22;
            border-color: #30363d;
        }

        body.dark-mode .metric-label {
            color: #8b949e;
        }

        body.dark-mode .metric-trend.neutral {
            color: #6e7681;
        }

        /* Badges dark mode */
        body.dark-mode .weak-area-badge,
        body.dark-mode .strong-area-badge {
            background: #21262d;
            border-color: #30363d;
        }

        /* Export option dark mode */
        body.dark-mode .export-option {
            background: #161b22;
            border-color: #30363d;
        }

        body.dark-mode .export-option:hover {
            background: #21262d;
            border-color: #1f6feb;
        }

        /* Practice stats dark mode */
        body.dark-mode .practice-stats {
            background: #161b22;
            border: 1px solid #30363d;
        }

        /* Ordering questions dark mode */
        body.dark-mode .ordering-test-item {
            background: #161b22;
            border-color: #30363d;
        }

        body.dark-mode .ordering-test-row {
            background: #21262d;
            border-color: #30363d;
        }

        body.dark-mode .ordering-test-row select {
            background: #0d1117;
            border-color: #30363d;
            color: #c9d1d9;
        }

        body.dark-mode .ordering-test-step-text {
            color: #c9d1d9;
        }

        body.dark-mode .ordering-test-step-text.used {
            color: #6e7681;
        }

        /* Ordering instruction text */
        body.dark-mode .ordering-instruction {
            color: #c9d1d9;
        }

        /* Ordering step number */
        body.dark-mode .ordering-step-number {
            color: #c9d1d9;
        }

        /* Ordering correct sequence container */
        body.dark-mode .ordering-correct-sequence {
            background: #161b22 !important;
            border-color: #30363d !important;
        }

        body.dark-mode .ordering-correct-sequence strong {
            color: #c9d1d9;
        }

        /* Preview placeholder */
        body.dark-mode .preview-placeholder {
            color: #6e7681 !important;
        }

        /* Question type label */
        body.dark-mode .question-type-label {
            color: #8b949e !important;
        }

        /* AGRESYWNE OVERRIDES - nadpisuje inline styles */
        body.dark-mode [style*="background: white"] {
            background: #21262d !important;
        }

        body.dark-mode [style*="background:#fff"],
        body.dark-mode [style*="background: #fff"] {
            background: #21262d !important;
        }

        body.dark-mode [style*="background:rgb(255, 255, 255)"] {
            background: #21262d !important;
        }

        body.dark-mode [style*="background-color: white"] {
            background-color: #21262d !important;
        }

        body.dark-mode [style*="background-color:#fff"],
        body.dark-mode [style*="background-color: #fff"] {
            background-color: #21262d !important;
        }

        /* Overriding colored backgrounds */
        body.dark-mode [style*="background: #f8f9fa"],
        body.dark-mode [style*="background:#f8f9fa"] {
            background: #21262d !important;
        }

        body.dark-mode [style*="background: #e7f3ff"],
        body.dark-mode [style*="background:#e7f3ff"] {
            background: #161b22 !important;
        }

        body.dark-mode [style*="background: #fff3cd"],
        body.dark-mode [style*="background:#fff3cd"] {
            background: #21262d !important;
        }

        body.dark-mode [style*="background: #d4edda"],
        body.dark-mode [style*="background:#d4edda"] {
            background: #161b22 !important;
        }

        /* Override inline text colors */
        body.dark-mode [style*="color: #000"] {
            color: #c9d1d9 !important;
        }

        body.dark-mode [style*="color: #333"] {
            color: #c9d1d9 !important;
        }

        body.dark-mode [style*="color: #000000"] {
            color: #c9d1d9 !important;
        }

        body.dark-mode [style*="color: rgb(0, 0, 0)"] {
            color: #c9d1d9 !important;
        }

        /* All paragraphs in dark mode */
        body.dark-mode p {
            color: #c9d1d9;
        }

        body.dark-mode .question-item>p {
            color: #c9d1d9;
        }

        /* Setup sections */
        body.dark-mode #test-setup,
        body.dark-mode #practice-setup,
        body.dark-mode #flashcard-setup {
            background: #21262d;
            border: 1px solid #30363d;
            padding: 20px;
            border-radius: 8px;
        }

        body.dark-mode #test-setup h2,
        body.dark-mode #practice-setup h2,
        body.dark-mode #flashcard-setup h2 {
            color: #f0f6fc;
            border-bottom: 2px solid #30363d;
            padding-bottom: 10px;
        }

        body.dark-mode #test-setup p,
        body.dark-mode #practice-setup p,
        body.dark-mode #flashcard-setup p {
            color: #8b949e;
        }

        /* Dark mode toggle button */
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #ffffff;
            border: 3px solid #007bff;
            border-radius: 12px;
            width: 60px;
            height: 60px;
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .dark-mode-toggle:hover {
            background: #f0f6fc;
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 123, 255, 0.3);
        }

        .dark-mode-toggle:active {
            transform: scale(0.95);
        }

        body.dark-mode .dark-mode-toggle {
            background: #21262d;
            border-color: #58a6ff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        body.dark-mode .dark-mode-toggle:hover {
            background: #30363d;
            box-shadow: 0 6px 16px rgba(88, 166, 255, 0.4);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }

        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #007bff;
            animation: slideIn 0.3s ease-out;
            min-width: 300px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .toast.success {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .toast.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .toast.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .toast.info {
            border-left-color: #007bff;
            background: #d1ecf1;
        }

        .toast-message {
            flex: 1;
            word-wrap: break-word;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.6;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: inherit;
        }

        .toast-close:hover {
            opacity: 1;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        body.dark-mode .toast {
            background: #21262d;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        body.dark-mode .toast.success {
            background: #1e3a25;
        }

        body.dark-mode .toast.error {
            background: #3a1e1e;
        }

        body.dark-mode .toast.warning {
            background: #3a2e00;
        }

        body.dark-mode .toast.info {
            background: #1e2a3a;
        }

        /* ========== NEON THEME SPECIAL EFFECTS ========== */
        [data-theme="modern"] .btn-primary {
            background: linear-gradient(135deg, #ff00ff 0%, #00ffff 100%);
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
            border: 2px solid #ff00ff;
            animation: neonPulse 2s ease-in-out infinite;
            color: #000000;
            font-weight: bold;
        }

        [data-theme="modern"] .btn-primary:hover {
            background: linear-gradient(135deg, #ff33ff 0%, #33ffff 100%);
            box-shadow: 0 0 25px rgba(255, 0, 255, 0.8);
            transform: scale(1.05);
            color: #000000;
        }

        /* Success button - zielony neon */
        [data-theme="modern"] .btn-success {
            background: linear-gradient(135deg, #00ff88 0%, #00ffcc 100%);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
            border: 2px solid #00ff88;
            color: #000000;
            font-weight: bold;
        }

        [data-theme="modern"] .btn-success:hover {
            background: linear-gradient(135deg, #33ffaa 0%, #33ffee 100%);
            box-shadow: 0 0 25px rgba(0, 255, 136, 0.8);
            transform: scale(1.05);
        }

        /* Danger button - czerwony neon */
        [data-theme="modern"] .btn-danger {
            background: linear-gradient(135deg, #ff4444 0%, #ff6666 100%);
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
            border: 2px solid #ff4444;
            color: #ffffff;
            font-weight: bold;
        }

        [data-theme="modern"] .btn-danger:hover {
            background: linear-gradient(135deg, #ff6666 0%, #ff8888 100%);
            box-shadow: 0 0 25px rgba(255, 68, 68, 0.8);
            transform: scale(1.05);
            color: #ffffff;
        }

        /* Warning button - ≈º√≥≈Çty neon */
        [data-theme="modern"] .btn-warning {
            background: linear-gradient(135deg, #ffcc00 0%, #ffee44 100%);
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.5);
            border: 2px solid #ffcc00;
            color: #000000;
            font-weight: bold;
        }

        [data-theme="modern"] .btn-warning:hover {
            background: linear-gradient(135deg, #ffdd33 0%, #ffff66 100%);
            box-shadow: 0 0 25px rgba(255, 204, 0, 0.8);
            transform: scale(1.05);
        }

        /* Secondary button - niebieski neon */
        [data-theme="modern"] .btn-secondary {
            background: linear-gradient(135deg, #4488ff 0%, #66aaff 100%);
            box-shadow: 0 0 15px rgba(68, 136, 255, 0.5);
            border: 2px solid #4488ff;
            color: #ffffff;
            font-weight: bold;
        }

        [data-theme="modern"] .btn-secondary:hover {
            background: linear-gradient(135deg, #66aaff 0%, #88bbff 100%);
            box-shadow: 0 0 25px rgba(68, 136, 255, 0.8);
            transform: scale(1.05);
        }

        /* Info button - cyjan neon */
        [data-theme="modern"] .btn-info {
            background: linear-gradient(135deg, #00ddee 0%, #00ffff 100%);
            box-shadow: 0 0 15px rgba(0, 221, 238, 0.5);
            border: 2px solid #00ddee;
            color: #000000;
            font-weight: bold;
        }

        [data-theme="modern"] .btn-info:hover {
            background: linear-gradient(135deg, #33eef0 0%, #33ffff 100%);
            box-shadow: 0 0 25px rgba(0, 221, 238, 0.8);
            transform: scale(1.05);
        }

        [data-theme="modern"] .question-item {
            background: linear-gradient(145deg, #1a1f3a 0%, #252b4a 100%);
            border: 1px solid rgba(255, 0, 255, 0.3);
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.2), inset 0 0 30px rgba(0, 255, 255, 0.05);
        }

        [data-theme="modern"] nav {
            background: linear-gradient(90deg, #0f0f1e 0%, #1a1a2e 50%, #0f0f1e 100%);
            border: 2px solid rgba(255, 0, 255, 0.5);
            box-shadow: 0 0 25px rgba(255, 0, 255, 0.4);
        }

        [data-theme="modern"] nav button {
            color: #ffffff;
            font-weight: 500;
        }

        [data-theme="modern"] nav button.active {
            background: linear-gradient(135deg, #ff00ff 0%, #00ffff 100%);
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.8);
            color: #000000;
            font-weight: bold;
        }

        [data-theme="modern"] .test-option {
            background: linear-gradient(145deg, #2a3050 0%, #1f2845 100%);
            border: 2px solid rgba(255, 0, 255, 0.5);
            color: #ffffff;
            transition: all 0.3s ease;
        }

        [data-theme="modern"] .test-option:hover {
            background: linear-gradient(145deg, #353d60 0%, #2a3050 100%);
            border-color: rgba(255, 0, 255, 0.8);
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.5);
            color: #ffffff;
        }

        [data-theme="modern"] .test-option.selected {
            background: linear-gradient(135deg, #ff00ff 0%, #00ffff 100%);
            box-shadow: 0 0 25px rgba(255, 0, 255, 0.8);
            color: #000000;
            font-weight: bold;
        }

        [data-theme="modern"] .progress-bar {
            background: linear-gradient(90deg, #252b4a 0%, #1a1f3a 100%);
            border: 2px solid rgba(255, 0, 255, 0.4);
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5);
        }

        [data-theme="modern"] #progressBar {
            background: linear-gradient(90deg, #ff00ff 0%, #00ffff 100%);
            box-shadow: 0 0 25px rgba(255, 0, 255, 0.8), 0 0 35px rgba(0, 255, 255, 0.4);
        }

        [data-theme="modern"] h1 {
            background: linear-gradient(90deg, #ff00ff, #00ffff, #ff00ff);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: textShine 3s linear infinite;
        }

        @keyframes neonPulse {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
            }

            50% {
                box-shadow: 0 0 25px rgba(255, 0, 255, 0.8), 0 0 35px rgba(0, 255, 255, 0.4);
            }
        }

        @keyframes textShine {
            to {
                background-position: 200% center;
            }
        }

        /* Lepsza czytelno≈õƒá dla wszystkich tekst√≥w w motywie modern */
        [data-theme="modern"] .question-item h2,
        [data-theme="modern"] .question-item h3,
        [data-theme="modern"] .question-item h4 {
            color: #ffffff;
        }

        [data-theme="modern"] .question-item p,
        [data-theme="modern"] .question-item strong {
            color: #e8f0ff;
        }

        [data-theme="modern"] .form-group label {
            color: #ffffff;
        }

        [data-theme="modern"] .test-question h3,
        [data-theme="modern"] .test-question .question-text {
            color: #ffffff !important;
        }

        /* SEKCJA PYTA≈É - poprawa ciemnego t≈Ça */
        [data-theme="modern"] #questions-section .question-item {
            background: linear-gradient(145deg, #252b4a 0%, #1a1f3a 100%) !important;
            border: 1px solid rgba(255, 0, 255, 0.4) !important;
        }

        [data-theme="modern"] #questions-section .question-item div[style*="background"] {
            background: #2a3055 !important;
            border: 1px solid rgba(255, 0, 255, 0.3) !important;
        }

        [data-theme="modern"] #questions-section .question-item h4 {
            color: #ffffff !important;
        }

        [data-theme="modern"] #questions-section .question-item p {
            color: #e8f0ff !important;
        }

        /* AGRESYWNE NADPISANIE dla wszystkich tekst√≥w w sekcji pyta≈Ñ */
        [data-theme="modern"] #questions-section .question-item *,
        [data-theme="modern"] #questions-section .question-item p *,
        [data-theme="modern"] #questions-section .question-item span *,
        [data-theme="modern"] #questions-section .question-item div * {
            color: #ffffff !important;
        }

        [data-theme="modern"] #questions-section .question-item p {
            color: #ffffff !important;
        }

        [data-theme="modern"] #questions-section .question-item .question-text {
            color: #ffffff !important;
        }

        [data-theme="modern"] #questions-section .question-item .question-text * {
            color: #ffffff !important;
        }

        /* Opcje odpowiedzi w sekcji pyta≈Ñ */
        [data-theme="modern"] #questions-section .question-item li,
        [data-theme="modern"] #questions-section .question-item ol li {
            color: #ffffff !important;
        }

        /* Wyja≈õnienia i dodatkowe pola - ciemny tekst na jasnym tle */
        [data-theme="modern"] #questions-section .explanation-box,
        [data-theme="modern"] #questions-section .question-item>div[style*="background: #d4edda"],
        [data-theme="modern"] #questions-section .question-item>div[style*="background: #e7f3ff"],
        [data-theme="modern"] #questions-section .question-item>div[style*="background: #f8f9fa"] {
            background: #2a3055 !important;
            border: 1px solid rgba(255, 0, 255, 0.3) !important;
        }

        [data-theme="modern"] #questions-section .explanation-box *,
        [data-theme="modern"] #questions-section .explanation-box p,
        [data-theme="modern"] #questions-section .explanation-box strong,
        [data-theme="modern"] #questions-section .explanation-box b {
            color: #c8d8ff !important;
        }

        [data-theme="modern"] #questions-section .question-item>div[style*="background"] p,
        [data-theme="modern"] #questions-section .question-item>div[style*="background"] span,
        [data-theme="modern"] #questions-section .question-item>div[style*="background"] strong {
            color: #1a1a2e !important;
        }

        [data-theme="modern"] #questions-section .category-badge,
        [data-theme="modern"] #questions-section .tag {
            background: rgba(255, 0, 255, 0.2) !important;
            color: #ffffff !important;
            border: 1px solid rgba(255, 0, 255, 0.4);
        }

        /* Paginacja w sekcji pyta≈Ñ */
        [data-theme="modern"] .pagination-container {
            background: linear-gradient(145deg, #252b4a 0%, #1a1f3a 100%) !important;
            border: 1px solid rgba(255, 0, 255, 0.4) !important;
        }

        [data-theme="modern"] .pagination-btn {
            background: #353d60 !important;
            color: #ffffff !important;
            border: 1px solid rgba(255, 0, 255, 0.4) !important;
        }

        [data-theme="modern"] .pagination-btn:hover {
            background: #455080 !important;
            border-color: rgba(255, 0, 255, 0.8) !important;
        }

        [data-theme="modern"] .pagination-btn.active {
            background: linear-gradient(135deg, #ff00ff 0%, #00ffff 100%) !important;
            color: #000000 !important;
            font-weight: bold !important;
        }

        /* Pagination page size - modern theme */
        [data-theme="modern"] .pagination-page-size {
            background: #2d285a !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
            border-radius: 8px !important;
            padding: 10px 16px !important;
            box-shadow: 0 4px 12px rgba(255, 0, 255, 0.15);
        }

        [data-theme="modern"] .pagination-page-size label {
            color: #ffffff !important;
            font-weight: 500;
            margin-right: 8px;
        }

        [data-theme="modern"] .pagination-page-size select {
            background: linear-gradient(145deg, #1e1b4b 0%, #252b4a 100%) !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
            color: #ffffff !important;
            padding: 6px 12px !important;
            border-radius: 6px !important;
            cursor: pointer;
            font-weight: 500;
            box-shadow: 0 2px 6px rgba(255, 0, 255, 0.2);
        }

        [data-theme="modern"] .pagination-page-size select:hover {
            border-color: rgba(0, 255, 255, 0.6) !important;
            box-shadow: 0 2px 8px rgba(0, 255, 255, 0.25);
        }

        [data-theme="modern"] .pagination-page-size select:focus {
            border-color: rgba(0, 255, 255, 0.8) !important;
            box-shadow: 0 0 12px rgba(0, 255, 255, 0.4);
            outline: none !important;
        }

        [data-theme="modern"] .pagination-page-size select option {
            background: #1e1b4b !important;
            color: #ffffff !important;
        }

        /* ========== FORMULARZ PYTA≈É - MOTYW NEON ========== */
        /* Pola input, select, textarea */
        [data-theme="modern"] input[type="text"],
        [data-theme="modern"] input[type="password"],
        [data-theme="modern"] input[type="number"],
        [data-theme="modern"] input[type="file"],
        [data-theme="modern"] select,
        [data-theme="modern"] textarea {
            background: linear-gradient(145deg, #1a1f3a 0%, #252b4a 100%) !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
            color: #ffffff !important;
        }

        [data-theme="modern"] input[type="text"]:focus,
        [data-theme="modern"] input[type="password"]:focus,
        [data-theme="modern"] input[type="number"]:focus,
        [data-theme="modern"] select:focus,
        [data-theme="modern"] textarea:focus {
            border-color: rgba(0, 255, 255, 0.8) !important;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3) !important;
            outline: none !important;
        }

        [data-theme="modern"] input::placeholder,
        [data-theme="modern"] textarea::placeholder {
            color: rgba(255, 255, 255, 0.5) !important;
        }

        /* WYSIWYG Editor */
        [data-theme="modern"] .wysiwyg-container {
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
            border-radius: 8px !important;
            background: linear-gradient(145deg, #1a1f3a 0%, #252b4a 100%) !important;
        }

        [data-theme="modern"] .wysiwyg-toolbar {
            background: linear-gradient(90deg, #252b4a 0%, #1f2845 100%) !important;
            border-bottom: 2px solid rgba(255, 0, 255, 0.4) !important;
            padding: 8px !important;
        }

        [data-theme="modern"] .wysiwyg-toolbar button {
            background: rgba(255, 0, 255, 0.2) !important;
            border: 1px solid rgba(255, 0, 255, 0.5) !important;
            color: #ffffff !important;
            padding: 5px 10px !important;
            margin: 0 2px !important;
            border-radius: 4px !important;
        }

        [data-theme="modern"] .wysiwyg-toolbar button:hover {
            background: rgba(0, 255, 255, 0.3) !important;
            border-color: rgba(0, 255, 255, 0.8) !important;
        }

        [data-theme="modern"] .wysiwyg-editor {
            background: #1a1f3a !important;
            color: #ffffff !important;
            min-height: 100px !important;
            padding: 12px !important;
        }

        [data-theme="modern"] .wysiwyg-editor:focus {
            outline: none !important;
            box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.1) !important;
        }

        /* Form group labels */
        [data-theme="modern"] .form-group label {
            color: #ffffff !important;
            font-weight: 500 !important;
        }

        [data-theme="modern"] .form-group small,
        [data-theme="modern"] .form-group small[style*="color"] {
            color: rgba(255, 255, 255, 0.7) !important;
        }

        /* Tagi i kategorie */
        [data-theme="modern"] .tags-input-container {
            background: #1a1f3a !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
            border-radius: 8px !important;
            padding: 10px !important;
        }

        [data-theme="modern"] .tags-input-container input {
            background: transparent !important;
            border: none !important;
            color: #ffffff !important;
        }

        [data-theme="modern"] .tags-list {
            margin-top: 8px !important;
        }

        [data-theme="modern"] .tag {
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.3) 0%, rgba(0, 255, 255, 0.3) 100%) !important;
            border: 1px solid rgba(255, 0, 255, 0.5) !important;
            color: #ffffff !important;
            padding: 4px 10px !important;
            border-radius: 15px !important;
            margin: 3px !important;
            display: inline-block !important;
        }

        [data-theme="modern"] .tag button {
            background: transparent !important;
            border: none !important;
            color: #ff6666 !important;
            margin-left: 5px !important;
            cursor: pointer !important;
        }

        [data-theme="modern"] .tag button:hover {
            color: #ff8888 !important;
        }

        /* PodglƒÖd na ≈ºywo */
        [data-theme="modern"] .live-preview-container {
            background: linear-gradient(145deg, #1a1f3a 0%, #252b4a 100%) !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
            border-radius: 8px !important;
            padding: 15px !important;
            margin-top: 20px !important;
        }

        [data-theme="modern"] .live-preview-container h3 {
            color: #ffffff !important;
            margin-bottom: 10px !important;
        }

        [data-theme="modern"] .live-preview-content {
            background: #252b4a !important;
            border: 1px solid rgba(255, 0, 255, 0.3) !important;
            border-radius: 6px !important;
            padding: 15px !important;
            min-height: 80px !important;
        }

        [data-theme="modern"] .live-preview-content div[style*="background: #f8f9fa"],
        [data-theme="modern"] .live-preview-content div[style*="background:#f8f9fa"] {
            background: #1e1b4b !important;
            border: 1px solid rgba(255, 0, 255, 0.3) !important;
        }

        /* Add option button */
        [data-theme="modern"] .add-option-btn {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.3) 0%, rgba(0, 255, 204, 0.3) 100%) !important;
            border: 2px solid #00ff88 !important;
            color: #00ffcc !important;
            padding: 8px 16px !important;
            border-radius: 6px !important;
            margin-top: 10px !important;
            cursor: pointer !important;
        }

        [data-theme="modern"] .add-option-btn:hover {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.4) 0%, rgba(0, 255, 204, 0.4) 100%) !important;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.4) !important;
        }

        /* Option inputs */
        [data-theme="modern"] .option-input {
            background: #1a1f3a !important;
            border: 1px solid rgba(255, 0, 255, 0.3) !important;
            color: #ffffff !important;
            padding: 8px !important;
            border-radius: 4px !important;
            margin: 5px 0 !important;
        }

        [data-theme="modern"] .option-input:focus {
            border-color: rgba(0, 255, 255, 0.8) !important;
        }

        /* Sekcje w formularzu (import/export) */
        [data-theme="modern"] #questions-section .question-item>div[style*="background"] {
            background: #2a3055 !important;
            border: 1px solid rgba(255, 0, 255, 0.3) !important;
        }

        [data-theme="modern"] #questions-section .question-item>div[style*="background"] h4,
        [data-theme="modern"] #questions-section .question-item>div[style*="background"] label {
            color: #ffffff !important;
        }

        [data-theme="modern"] #questions-section .question-item>div[style*="background"] small {
            color: rgba(255, 255, 255, 0.7) !important;
        }

        /* Image preview */
        [data-theme="modern"] #imagePreview {
            border: 2px solid rgba(255, 0, 255, 0.5) !important;
            border-radius: 8px !important;
        }

        /* Ordering questions - modern theme */
        [data-theme="modern"] .ordering-test-item {
            background: #1e1b4b;
            border-color: rgba(255, 0, 255, 0.3);
        }

        [data-theme="modern"] .ordering-test-row {
            background: #2d285a;
            border-color: rgba(255, 0, 255, 0.2);
        }

        [data-theme="modern"] .ordering-test-row select {
            background: #1e1b4b;
            border-color: rgba(255, 0, 255, 0.4);
            color: #ffffff;
        }

        [data-theme="modern"] .ordering-test-step-text {
            color: #e2e8f0;
        }

        [data-theme="modern"] .ordering-test-step-text.used {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Ordering instruction text - modern theme */
        [data-theme="modern"] .ordering-instruction {
            color: #e2e8f0;
        }

        /* Ordering step number - modern theme */
        [data-theme="modern"] .ordering-step-number {
            color: #e2e8f0;
        }

        /* Ordering correct sequence container - modern theme */
        [data-theme="modern"] .ordering-correct-sequence {
            background: #2d285a !important;
            border: 1px solid rgba(255, 0, 255, 0.3) !important;
        }

        [data-theme="modern"] .ordering-correct-sequence strong {
            color: #ffffff;
        }

        /* Preview placeholder - modern theme */
        [data-theme="modern"] .preview-placeholder {
            color: rgba(255, 255, 255, 0.5) !important;
        }

        /* Question type label - modern theme */
        [data-theme="modern"] .question-type-label {
            color: rgba(255, 255, 255, 0.7) !important;
        }

        /* Practice stats container - modern theme */
        [data-theme="modern"] .practice-stats {
            background: linear-gradient(145deg, #1e1b4b 0%, #252b4a 100%) !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
        }

        [data-theme="modern"] .practice-stats h3 {
            color: #ffffff !important;
        }

        [data-theme="modern"] .practice-stats p {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        [data-theme="modern"] .practice-stats span {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        /* Bookmark and Notes buttons - modern theme */
        [data-theme="modern"] .bookmark-btn {
            background: transparent !important;
            border: 2px solid rgba(255, 0, 255, 0.6) !important;
            color: #ffffff !important;
        }

        [data-theme="modern"] .bookmark-btn:hover {
            background: rgba(255, 0, 255, 0.2) !important;
            border-color: rgba(255, 0, 255, 0.8) !important;
        }

        [data-theme="modern"] .bookmark-btn.active {
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%) !important;
            border-color: #ff9800 !important;
            color: #000000 !important;
        }

        [data-theme="modern"] .notes-btn {
            background: transparent !important;
            border: 2px solid rgba(255, 0, 255, 0.6) !important;
            color: #ffffff !important;
        }

        [data-theme="modern"] .notes-btn:hover {
            background: rgba(0, 255, 255, 0.2) !important;
            border-color: rgba(0, 255, 255, 0.8) !important;
        }

        /* ========== DASHBOARD - MOTYW NEON ========== */

        /* Category stats container - modern theme */
        [data-theme="modern"] #category-stats {
            background: linear-gradient(145deg, #1e1b4b 0%, #252b4a 100%) !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        [data-theme="modern"] #category-stats h3 {
            color: #ffffff !important;
            border-bottom: 2px solid rgba(255, 0, 255, 0.4) !important;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        /* Category progress container - modern theme */
        [data-theme="modern"] #category-progress {
            background: linear-gradient(145deg, #1e1b4b 0%, #252b4a 100%) !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        [data-theme="modern"] #category-progress h3 {
            color: #ffffff !important;
            border-bottom: 2px solid rgba(255, 0, 255, 0.4) !important;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        /* Category stat item - modern theme */
        [data-theme="modern"] .category-stat-item {
            background: #2d285a !important;
            border: 2px solid rgba(255, 0, 255, 0.3) !important;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition-smooth);
        }

        [data-theme="modern"] .category-stat-item:hover {
            background: #353060 !important;
            border-color: rgba(255, 0, 255, 0.6) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 0, 255, 0.2);
        }

        /* Category stat name - modern theme */
        [data-theme="modern"] .category-stat-name {
            color: #ffffff !important;
            font-weight: 600;
            font-size: var(--text-base);
        }

        /* Category stat count - modern theme */
        [data-theme="modern"] .category-stat-count {
            background: linear-gradient(135deg, #ff00ff 0%, #00ffff 100%) !important;
            color: #000000 !important;
            padding: 6px 14px;
            border-radius: 4px;
            font-size: 0.95em;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(255, 0, 255, 0.3);
        }

        /* Analytics grid - modern theme */
        [data-theme="modern"] .analytics-grid {
            gap: 25px !important;
            margin: 25px 0 !important;
        }

        /* Analytics card - modern theme */
        [data-theme="modern"] .analytics-card {
            background: linear-gradient(145deg, #1e1b4b 0%, #252b4a 100%) !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
            border-radius: 12px !important;
            padding: 24px !important;
            box-shadow: 0 8px 20px rgba(255, 0, 255, 0.15) !important;
            transition: var(--transition-smooth);
        }

        [data-theme="modern"] .analytics-card:hover {
            transform: translateY(-4px) !important;
            box-shadow: 0 12px 28px rgba(255, 0, 255, 0.25) !important;
            border-color: rgba(0, 255, 255, 0.6) !important;
        }

        /* Analytics card heading - modern theme */
        [data-theme="modern"] .analytics-card h3 {
            color: #ffffff !important;
            border-bottom: 2px solid rgba(255, 0, 255, 0.4) !important;
            padding-bottom: 12px;
            margin-bottom: 20px !important;
            font-size: var(--text-xl);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Analytics card content - modern theme */
        [data-theme="modern"] .analytics-card p,
        [data-theme="modern"] .analytics-card span,
        [data-theme="modern"] .analytics-card div,
        [data-theme="modern"] .analytics-card ul,
        [data-theme="modern"] .analytics-card li {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        [data-theme="modern"] .analytics-card strong {
            color: #00ffff !important;
        }

        /* Bar chart - modern theme */
        [data-theme="modern"] .bar-chart {
            background: #2d285a !important;
            border: 1px solid rgba(255, 0, 255, 0.3) !important;
            border-radius: 8px;
            padding: 15px;
        }

        [data-theme="modern"] .bar {
            background: linear-gradient(135deg, #ff00ff 0%, #00ffff 100%) !important;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(255, 0, 255, 0.3);
        }

        /* Progress metric - modern theme */
        [data-theme="modern"] .progress-metric {
            background: #2d285a !important;
            border: 1px solid rgba(255, 0, 255, 0.3) !important;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
        }

        [data-theme="modern"] .progress-metric .label {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        [data-theme="modern"] .progress-metric .value {
            color: #00ffff !important;
            font-weight: bold;
        }

        /* Weak/Strong areas - modern theme */
        [data-theme="modern"] .weak-area {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.2) 0%, rgba(220, 38, 38, 0.1) 100%) !important;
            border: 1px solid rgba(220, 38, 38, 0.4) !important;
            border-radius: 6px;
            padding: 10px 14px;
            margin: 8px 0;
        }

        [data-theme="modern"] .weak-area .category {
            color: #ff6b6b !important;
            font-weight: 600;
        }

        [data-theme="modern"] .strong-area {
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.2) 0%, rgba(5, 150, 105, 0.1) 100%) !important;
            border: 1px solid rgba(5, 150, 105, 0.4) !important;
            border-radius: 6px;
            padding: 10px 14px;
            margin: 8px 0;
        }

        [data-theme="modern"] .strong-area .category {
            color: #10b981 !important;
            font-weight: 600;
        }

        /* Learning insights - modern theme */
        [data-theme="modern"] .insight-item {
            background: #2d285a !important;
            border: 1px solid rgba(255, 0, 255, 0.3) !important;
            border-radius: 6px;
            padding: 12px 16px;
            margin: 10px 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        [data-theme="modern"] .insight-item .emoji {
            font-size: 1.5em;
            line-height: 1;
        }

        [data-theme="modern"] .insight-item .text {
            color: rgba(255, 255, 255, 0.9) !important;
            line-height: 1.6;
        }

        /* Dashboard section containers - modern theme */
        [data-theme="modern"] #dashboard-section .question-item {
            background: linear-gradient(145deg, #1e1b4b 0%, #252b4a 100%) !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
        }

        [data-theme="modern"] #dashboard-section .question-item h2 {
            color: #ffffff !important;
            border-bottom: 2px solid rgba(255, 0, 255, 0.4) !important;
            padding-bottom: 10px;
        }

        [data-theme="modern"] #dashboard-section .question-item p {
            color: rgba(255, 255, 255, 0.9) !important;
            font-size: 1.1em;
            margin: 10px 0;
        }

        [data-theme="modern"] #dashboard-section .question-item strong {
            color: #00ffff !important;
            font-weight: 600;
        }

        [data-theme="modern"] #dashboard-section .question-item span {
            color: #ffffff !important;
        }

        /* Study streak card - modern theme */
        [data-theme="modern"] .study-streak-card {
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%) !important;
            border: 2px solid rgba(255, 152, 0, 0.4) !important;
            color: #000000 !important;
            padding: 20px !important;
            border-radius: 12px !important;
            margin-bottom: 20px !important;
            box-shadow: 0 8px 20px rgba(255, 152, 0, 0.3) !important;
        }

        [data-theme="modern"] .study-streak-card div {
            color: #000000 !important;
        }

        [data-theme="modern"] .study-streak-card .emoji {
            font-size: 3em;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        /* ========== SZCZEG√ì≈ÅOWE WYNIKI - MOTYW NEON ========== */

        /* Detailed results section - modern theme */
        [data-theme="modern"] #detailed-results-section {
            background: linear-gradient(145deg, #1e1b4b 0%, #252b4a 100%) !important;
            border: none !important;
            padding: 20px;
        }

        /* Detailed result summary - modern theme */
        [data-theme="modern"] .detailed-result-summary {
            background: linear-gradient(145deg, #2d285a 0%, #353060 100%) !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
            border-radius: 12px !important;
            padding: 25px !important;
            margin-bottom: 25px !important;
            box-shadow: 0 8px 20px rgba(255, 0, 255, 0.15);
        }

        [data-theme="modern"] .detailed-result-summary h3 {
            color: #ffffff !important;
            border-bottom: 2px solid rgba(255, 0, 255, 0.4) !important;
            padding-bottom: 15px !important;
            margin-bottom: 20px !important;
        }

        [data-theme="modern"] .detailed-result-summary p {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        [data-theme="modern"] .detailed-result-summary .back-btn {
            background: #2d285a !important;
            border: 2px solid rgba(255, 0, 255, 0.6) !important;
            color: #ffffff !important;
        }

        [data-theme="modern"] .detailed-result-summary .back-btn:hover {
            background: #353060 !important;
            border-color: rgba(0, 255, 255, 0.8) !important;
        }

        /* Result badges - modern theme */
        [data-theme="modern"] .result-badge {
            padding: 10px 20px;
            border-radius: 8px !important;
            font-weight: 600;
            margin: 5px;
            display: inline-block;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        [data-theme="modern"] .result-badge.score {
            background: linear-gradient(135deg, #ff00ff 0%, #00ffff 100%) !important;
            color: #000000 !important;
            font-size: 2.5em !important;
            padding: 20px 40px !important;
            box-shadow: 0 8px 24px rgba(255, 0, 255, 0.4);
        }

        [data-theme="modern"] .result-badge.correct {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            color: #ffffff !important;
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        [data-theme="modern"] .result-badge.incorrect {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
            color: #ffffff !important;
            border: 1px solid rgba(220, 53, 69, 0.4);
        }

        [data-theme="modern"] .result-badge.skipped {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%) !important;
            color: #000000 !important;
            border: 1px solid rgba(255, 193, 7, 0.4);
        }

        /* Question review items - modern theme */
        [data-theme="modern"] .question-review-item {
            background: #2d285a !important;
            border: 2px solid rgba(255, 0, 255, 0.3) !important;
            border-radius: 10px !important;
            padding: 20px !important;
            margin-bottom: 20px !important;
            box-shadow: 0 4px 12px rgba(255, 0, 255, 0.15);
        }

        [data-theme="modern"] .question-review-item.correct-answer {
            border-color: rgba(16, 185, 129, 0.5) !important;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
        }

        [data-theme="modern"] .question-review-item.incorrect-answer {
            border-color: rgba(220, 53, 69, 0.5) !important;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.15);
        }

        [data-theme="modern"] .question-review-item.skipped-answer {
            border-color: rgba(255, 193, 7, 0.5) !important;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.15);
        }

        [data-theme="modern"] .question-review-item h4 {
            color: #ffffff !important;
            margin-bottom: 15px !important;
        }

        [data-theme="modern"] .question-review-item h5 {
            color: #00ffff !important;
            margin-top: 15px !important;
            margin-bottom: 10px !important;
        }

        [data-theme="modern"] .question-review-item p {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        [data-theme="modern"] .question-review-item strong {
            color: #00ffff !important;
        }

        /* Review options - modern theme */
        [data-theme="modern"] .review-option {
            background: #1e1b4b !important;
            border: 1px solid rgba(255, 0, 255, 0.3) !important;
            padding: 12px 16px !important;
            margin: 8px 0 !important;
            border-radius: 6px !important;
            color: rgba(255, 255, 255, 0.9) !important;
            transition: var(--transition-smooth);
        }

        [data-theme="modern"] .review-option:hover {
            background: #252b4a !important;
            border-color: rgba(255, 0, 255, 0.5) !important;
        }

        [data-theme="modern"] .review-option.correct-answer {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%) !important;
            border-color: rgba(16, 185, 129, 0.6) !important;
            color: #10b981 !important;
        }

        [data-theme="modern"] .review-option.incorrect-selection {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.2) 0%, rgba(220, 53, 69, 0.1) 100%) !important;
            border-color: rgba(220, 53, 69, 0.6) !important;
            color: #dc3545 !important;
        }

        [data-theme="modern"] .review-option.user-selected {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.2) 0%, rgba(0, 255, 255, 0.1) 100%) !important;
            border-color: rgba(0, 255, 255, 0.6) !important;
            color: #00ffff !important;
            font-weight: 600;
        }

        /* Ordering sequence containers - modern theme */
        [data-theme="modern"] [style*="background: #f8f9fa"] {
            background: #2d285a !important;
            border: 1px solid rgba(255, 0, 255, 0.3) !important;
            border-radius: 6px;
        }

        [data-theme="modern"] [style*="background: #d4edda"] {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%) !important;
            border: 1px solid rgba(16, 185, 129, 0.4) !important;
            border-radius: 6px;
        }

        /* Explanation box - modern theme */
        [data-theme="modern"] .explanation-box {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.15) 0%, rgba(0, 255, 255, 0.05) 100%) !important;
            border: 2px solid rgba(0, 255, 255, 0.4) !important;
            border-radius: 10px !important;
            padding: 20px !important;
            margin-top: 20px !important;
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.15);
        }

        [data-theme="modern"] .explanation-box strong {
            color: #00ffff !important;
        }

        [data-theme="modern"] .explanation-box div,
        [data-theme="modern"] .explanation-box br {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        /* Review status badges - modern theme */
        [data-theme="modern"] .review-status {
            padding: 6px 14px;
            border-radius: 6px !important;
            font-weight: 600;
            font-size: 0.9em;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* Category badges and tags - modern theme */
        [data-theme="modern"] .question-review-item .category-badge,
        [data-theme="modern"] .question-review-item .tag {
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.2) 0%, rgba(0, 255, 255, 0.2) 100%) !important;
            border: 1px solid rgba(255, 0, 255, 0.4) !important;
            color: #ffffff !important;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            margin: 3px;
            display: inline-block;
        }

        /* Back buttons - modern theme */
        [data-theme="modern"] .back-btn {
            background: #2d285a !important;
            border: 2px solid rgba(255, 0, 255, 0.6) !important;
            color: #ffffff !important;
            border-radius: 8px !important;
            padding: 10px 20px !important;
            font-weight: 600;
            transition: var(--transition-smooth);
        }

        [data-theme="modern"] .back-btn:hover {
            background: #353060 !important;
            border-color: rgba(0, 255, 255, 0.8) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.3);
        }

        /* ========== FLASHCARDS - MOTYW NEON ========== */

        /* Flashcard progress container - modern theme */
        [data-theme="modern"] .flashcard-progress {
            background: linear-gradient(145deg, #2d285a 0%, #353060 100%) !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
            border-radius: 12px !important;
            padding: 16px !important;
            margin-top: 16px !important;
            box-shadow: 0 8px 20px rgba(255, 0, 255, 0.15);
        }

        /* Flashcard progress text (Fiszka X z Y) - modern theme */
        [data-theme="modern"] .flashcard-progress>div[style*="display: flex"] span {
            color: #ffffff !important;
            font-size: 1.1em;
        }

        [data-theme="modern"] .flashcard-progress>div[style*="display: flex"] strong {
            color: #00ffff !important;
            font-weight: 700;
        }

        [data-theme="modern"] #flashcard-current,
        [data-theme="modern"] #flashcard-total {
            color: #00ffff !important;
            font-weight: 700;
        }

        [data-theme="modern"] #flashcard-percent {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 600;
        }

        /* Flashcard progress bar - modern theme */
        [data-theme="modern"] .flashcard-progress-bar {
            background: #1e1b4b !important;
            border: 1px solid rgba(255, 0, 255, 0.3) !important;
            border-radius: 6px !important;
            margin: 10px 0 !important;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Flashcard progress fill - modern theme */
        [data-theme="modern"] .flashcard-progress-fill {
            background: linear-gradient(90deg, #ff00ff 0%, #00ffff 100%) !important;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
        }

        /* Flashcard stats container - modern theme */
        [data-theme="modern"] .flashcard-stats {
            background: transparent !important;
            gap: 12px !important;
            margin-top: 16px !important;
        }

        /* Flashcard stat items - modern theme */
        [data-theme="modern"] .flashcard-stat {
            background: linear-gradient(145deg, #1e1b4b 0%, #252b4a 100%) !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
            border-radius: 10px !important;
            padding: 12px 16px !important;
            min-width: 80px;
            box-shadow: 0 4px 12px rgba(255, 0, 255, 0.15);
            transition: var(--transition-smooth);
        }

        [data-theme="modern"] .flashcard-stat:hover {
            background: #252b4a !important;
            border-color: rgba(0, 255, 255, 0.6) !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 255, 255, 0.25);
        }

        /* Flashcard stat value - modern theme */
        [data-theme="modern"] .flashcard-stat-value {
            background: linear-gradient(135deg, #ff00ff 0%, #00ffff 100%) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            color: transparent !important;
            font-size: 22px !important;
            font-weight: 800 !important;
            text-shadow: none !important;
        }

        /* Flashcard stat label - modern theme */
        [data-theme="modern"] .flashcard-stat-label {
            color: rgba(255, 255, 255, 0.8) !important;
            font-size: 12px !important;
            margin-top: 4px !important;
            font-weight: 500;
        }

        /* Flashcard complete score - modern theme */
        [data-theme="modern"] .flashcard-complete-score {
            background: linear-gradient(135deg, #ff00ff 0%, #00ffff 100%) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            color: transparent !important;
            font-size: 5em !important;
            font-weight: 900 !important;
            margin: 20px 0 !important;
            text-align: center;
            filter: drop-shadow(0 4px 8px rgba(255, 0, 255, 0.4));
        }

        /* Flashcard complete container - modern theme */
        [data-theme="modern"] .flashcard-complete {
            background: linear-gradient(145deg, #1e1b4b 0%, #252b4a 100%) !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
            border-radius: 16px !important;
            padding: 40px !important;
            text-align: center;
            box-shadow: 0 12px 32px rgba(255, 0, 255, 0.2);
        }

        [data-theme="modern"] .flashcard-complete h2 {
            color: #ffffff !important;
            border-bottom: 2px solid rgba(255, 0, 255, 0.4) !important;
            padding-bottom: 15px !important;
            margin-bottom: 20px !important;
            font-size: 2.5em;
        }

        [data-theme="modern"] .flashcard-complete p {
            color: rgba(255, 255, 255, 0.9) !important;
            font-size: 1.2em;
            margin: 15px 0;
        }

        [data-theme="modern"] .flashcard-complete button {
            background: linear-gradient(135deg, #ff00ff 0%, #00ffff 100%) !important;
            border: none !important;
            color: #000000 !important;
            padding: 15px 40px !important;
            border-radius: 10px !important;
            font-weight: 700 !important;
            font-size: 1.1em;
            box-shadow: 0 8px 24px rgba(255, 0, 255, 0.4);
            transition: var(--transition-smooth);
        }

        [data-theme="modern"] .flashcard-complete button:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 12px 32px rgba(255, 0, 255, 0.6);
        }

        /* Flashcard keyboard hints - modern theme */
        [data-theme="modern"] .flashcard-keyboard-hint {
            background: #2d285a !important;
            border: 2px solid rgba(255, 0, 255, 0.3) !important;
            border-radius: 10px !important;
            padding: 14px 20px !important;
            margin-top: 20px !important;
            box-shadow: 0 4px 12px rgba(255, 0, 255, 0.1);
        }

        [data-theme="modern"] .flashcard-keyboard-hint {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        [data-theme="modern"] .flashcard-keyboard-hint kbd {
            background: linear-gradient(135deg, #1e1b4b 0%, #252b4a 100%) !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
            border-radius: 6px !important;
            padding: 6px 12px !important;
            color: #00ffff !important;
            font-weight: 700 !important;
            font-size: 12px !important;
            box-shadow: 0 2px 6px rgba(255, 0, 255, 0.3);
        }

        /* Flashcard setup - modern theme */
        [data-theme="modern"] #flashcard-setup {
            background: linear-gradient(145deg, #1e1b4b 0%, #252b4a 100%) !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
            border-radius: 12px !important;
            padding: 25px !important;
            box-shadow: 0 8px 20px rgba(255, 0, 255, 0.15);
        }

        [data-theme="modern"] #flashcard-setup h2 {
            color: #ffffff !important;
            border-bottom: 2px solid rgba(255, 0, 255, 0.4) !important;
            padding-bottom: 15px !important;
            margin-bottom: 20px !important;
        }

        [data-theme="modern"] #flashcard-setup p {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        /* Flashcard card itself - modern theme */
        [data-theme="modern"] #flashcard {
            background: linear-gradient(145deg, #1e1b4b 0%, #252b4a 100%) !important;
            border: 3px solid rgba(255, 0, 255, 0.5) !important;
            border-radius: 20px !important;
            box-shadow: 0 12px 32px rgba(255, 0, 255, 0.25);
        }

        [data-theme="modern"] #flashcard-question {
            color: #ffffff !important;
        }

        [data-theme="modern"] #flashcard-answer-question {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        [data-theme="modern"] .flashcard-option {
            background: #2d285a !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
            border-radius: 12px !important;
            padding: 16px 20px !important;
            margin: 12px 0 !important;
            color: rgba(255, 255, 255, 0.9) !important;
            box-shadow: 0 4px 12px rgba(255, 0, 255, 0.15);
            transition: var(--transition-smooth);
        }

        [data-theme="modern"] .flashcard-option:hover {
            background: #353060 !important;
            border-color: rgba(0, 255, 255, 0.6) !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 255, 255, 0.25);
        }

        [data-theme="modern"] .flashcard-option.correct {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, rgba(16, 185, 129, 0.1) 100%) !important;
            border-color: rgba(16, 185, 129, 0.7) !important;
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);
        }

        [data-theme="modern"] .flashcard-option .option-number {
            color: #00ffff !important;
        }

        [data-theme="modern"] .flashcard-option.correct .option-number {
            color: #10b981 !important;
        }

        /* Ordering step row in editor - modern theme */
        [data-theme="modern"] .ordering-step-row {
            background: #1e1b4b !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
        }

        [data-theme="modern"] .ordering-step-row input[type="text"] {
            background: #2d285a !important;
            border: 1px solid rgba(255, 0, 255, 0.3) !important;
            color: #ffffff !important;
        }

        [data-theme="modern"] .ordering-step-row input[type="text"]:focus {
            border-color: rgba(0, 255, 255, 0.8) !important;
            background: #252b4a !important;
        }

        [data-theme="modern"] .ordering-step-number {
            color: #00ffff !important;
        }

        /* Practice setup container - modern theme */
        [data-theme="modern"] #practice-setup {
            background: linear-gradient(145deg, #1e1b4b 0%, #252b4a 100%) !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
        }

        [data-theme="modern"] #practice-setup h2 {
            color: #ffffff !important;
        }

        [data-theme="modern"] #practice-setup p {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        /* Select dropdown options - modern theme */
        [data-theme="modern"] select option {
            background: #1e1b4b !important;
            color: #ffffff !important;
        }

        [data-theme="modern"] .ordering-test-row select option {
            background: #1e1b4b !important;
            color: #ffffff !important;
        }

        /* Practice category select - modern theme */
        [data-theme="modern"] #practiceCategory {
            background: linear-gradient(145deg, #1a1f3a 0%, #252b4a 100%) !important;
            border: 2px solid rgba(255, 0, 255, 0.4) !important;
            color: #ffffff !important;
        }

        [data-theme="modern"] #practiceCategory option {
            background: #1e1b4b !important;
            color: #ffffff !important;
        }

        /* ========== RESPONSIVE DESIGN - MOBILE & TABLET ========== */

        /* ========== BOTTOM NAVIGATION (Mobile) ========== */
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--nav-bg);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            padding: 0 8px;
            justify-content: space-around;
            align-items: center;
            gap: 4px;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px 4px;
            border: none;
            background: transparent;
            color: var(--text-light);
            font-size: var(--text-xs);
            text-decoration: none;
            cursor: pointer;
            transition: var(--transition-smooth);
            flex: 1;
            min-width: 0;
            border-radius: var(--border-radius);
        }

        .bottom-nav-item .nav-icon {
            font-size: 20px;
            margin-bottom: 2px;
            line-height: 1;
        }

        .bottom-nav-item .nav-label {
            font-size: 10px;
            line-height: 1.1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .bottom-nav-item:hover,
        .bottom-nav-item:active {
            color: var(--primary-color);
            background: rgba(255, 255, 255, 0.05);
        }

        .bottom-nav-item.active {
            color: var(--primary-color);
            background: rgba(37, 99, 235, 0.1);
        }

        [data-theme="modern"] .bottom-nav-item.active {
            background: rgba(168, 85, 247, 0.2);
        }

        /* Bottom nav more menu */
        .bottom-nav-more {
            position: fixed;
            bottom: 70px;
            right: 8px;
            background: var(--nav-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            padding: 8px 0;
            min-width: 200px;
            z-index: 9998;
            display: none;
        }

        .bottom-nav-more.show {
            display: block;
            animation: slideUpFade 0.2s ease;
        }

        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bottom-nav-more button {
            display: block;
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            text-align: left;
            cursor: pointer;
            font-size: var(--text-sm);
        }

        .bottom-nav-more button:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .bottom-nav-more button.admin-only {
            color: var(--warning-color);
            display: none;
        }

        /* Poka≈º przyciski admina gdy u≈ºytkownik jest adminem */
        body.is-admin .bottom-nav-more button.admin-only {
            display: block;
        }

        /* Add bottom padding for main content when bottom nav is visible */
        body.has-bottom-nav .container {
            padding-bottom: 80px;
        }

        /* ========== POPRAWKI MOBILE - UKRYWANIE BOTTOM NAV W AKTYWNYCH SESJACH ========== */
        
        /* Ukryj bottom navigation podczas testu/praktyki/flashcard */
        body.in-test .bottom-nav,
        body.in-practice .bottom-nav,
        body.in-flashcards .bottom-nav {
            display: none !important;
        }

        body.in-test .container,
        body.in-practice .container,
        body.in-flashcards .container {
            padding-bottom: 20px !important;
        }

        /* Przyciski test/praktyka zawsze widoczne nad bottom-nav */
        @media (max-width: 768px) {
            #test-interface button[onclick="window.finishTest()"],
            #practice-interface button[onclick="window.endPracticeEarly()"] {
                position: sticky;
                bottom: 20px;
                z-index: 9998;
                margin-top: 20px;
                margin-bottom: 20px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            /* Tryb nauki - poprawa wy≈õwietlania */
            .practice-stats {
                margin-bottom: 20px;
            }

            #practice-question-container {
                margin-bottom: 15px;
            }

            #practice-feedback {
                margin-bottom: 15px;
            }

            /* Fiszki - scroll dla d≈Çugich tre≈õci */
            .flashcard-content {
                overflow-y: auto;
                max-height: 250px;
            }

            .flashcard-rating button {
                font-size: var(--text-sm);
                padding: 12px 16px;
            }

            /* Dodaj padding dla bottom-nav gdy jest widoczne */
            body.has-bottom-nav .flashcard-container {
                margin-bottom: 80px;
            }

            /* Opis klawiszy na dole ekranu w trybie fiszek */
            .flashcard-keyboard-hint {
                margin-top: 20px;
                margin-bottom: 10px;
                font-size: 11px;
                padding: 8px 12px;
            }

            .flashcard-keyboard-hint kbd {
                padding: 3px 6px;
                font-size: 10px;
            }
        }
        
        /* Small mobile - dodatkowe poprawki */
        @media (max-width: 480px) {
            #test-interface button[onclick="window.finishTest()"],
            #practice-interface button[onclick="window.endPracticeEarly()"] {
                bottom: 10px;
                margin-top: 15px;
                margin-bottom: 15px;
            }

            /* Tryb nauki - jeszcze mniejsze marginesy */
            .practice-stats {
                margin-bottom: 15px;
                padding: 12px;
            }

            .practice-stats h3 {
                font-size: var(--text-lg);
            }

            #practice-question-container {
                margin-bottom: 12px;
            }

            #practice-feedback {
                margin-bottom: 12px;
            }

            .flashcard-content {
                max-height: 200px;
            }

            .flashcard-rating button {
                padding: 10px 12px;
                font-size: var(--text-xs);
            }

            /* Opis klawiszy - jeszcze mniejszy na small mobile */
            .flashcard-keyboard-hint {
                font-size: 10px;
                padding: 6px 10px;
                margin-top: 15px;
                margin-bottom: 8px;
            }

            .flashcard-keyboard-hint kbd {
                padding: 2px 5px;
                font-size: 9px;
            }
        }

        /* Hamburger Menu (hidden on desktop) */
        .hamburger-menu {
            display: none;
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 10000;
            background: var(--nav-bg);
            border: none;
            border-radius: var(--border-radius);
            padding: 12px;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: var(--transition-smooth);
            pointer-events: auto;
            touch-action: manipulation;
        }

        .hamburger-menu:hover {
            background: var(--nav-hover);
            transform: scale(1.05);
        }

        .hamburger-menu span {
            display: block;
            width: 24px;
            height: 2px;
            background: white;
            margin: 5px 0;
            transition: var(--transition-bounce);
            border-radius: 2px;
        }

        .hamburger-menu.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger-menu.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger-menu.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        /* Mobile navigation overlay */
        .mobile-nav-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 9998;
            opacity: 0;
            transition: opacity 0.25s ease;
            pointer-events: none;
        }

        .mobile-nav-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Tablet (max-width: 768px) */
        @media (max-width: 768px) {

            /* Hide side navigation and hamburger on mobile */
            #app-section > nav {
                display: none !important;
            }

            .hamburger-menu {
                display: none !important;
            }

            .mobile-nav-overlay {
                display: none !important;
            }

            /* Show bottom navigation when logged in */
            .logged-in .bottom-nav {
                display: flex;
            }

            /* Add bottom padding for content */
            .logged-in #app-section .container {
                padding-bottom: 80px;
            }

            nav button::before {
                display: none;
            }

            /* Container adjustments - add top padding for hamburger */
            .container {
                padding: 16px;
                padding-top: 70px;
            }

            /* Typography scaling */
            h1 {
                font-size: var(--text-3xl);
                margin-bottom: 24px;
            }

            h2 {
                font-size: var(--text-2xl);
            }

            h3 {
                font-size: var(--text-xl);
            }

            /* Question items */
            .question-item {
                padding: 24px;
            }

            /* Question number badge - smaller on mobile */
            .question-item::before {
                top: 12px;
                right: 12px;
                padding: 4px 10px;
                font-size: var(--text-xs);
            }

            /* Navigation - stacked layout */
            nav {
                padding: 6px 12px;
                gap: 6px;
            }

            nav button {
                padding: 10px 16px;
                font-size: var(--text-xs);
            }

            /* Test options - larger touch targets */
            .test-option {
                padding: 16px 14px;
                margin: 10px 0;
                min-height: 48px;
                /* Touch-friendly */
            }

            /* Timer - condensed */
            .test-timer {
                padding: 16px 20px;
                font-size: var(--text-2xl);
            }

            .test-timer .timer-icon {
                font-size: var(--text-xl);
            }

            /* Flashcards - smaller on mobile */
            .flashcard-container {
                perspective: 1200px;
                margin: 20px auto;
            }

            .flashcard {
                min-height: 380px;
            }

            .flashcard-face {
                min-height: 380px;
                padding: 36px 24px;
            }

            .flashcard-content h3,
            .flashcard-content .question-text {
                font-size: var(--text-lg);
            }

            .flashcard-hint {
                font-size: var(--text-xs);
                padding: 10px 16px;
            }

            /* Flashcard rating buttons */
            .flashcard-rating {
                gap: 12px;
                margin-top: 24px;
            }

            .flashcard-rating button {
                padding: 14px 20px;
                font-size: var(--text-base);
            }

            /* Progress bar */
            .progress-bar {
                height: 10px;
            }

            /* Stats */
            .flashcard-stats {
                gap: 8px;
            }

            .flashcard-stat {
                padding: 10px 12px;
                flex: 1 1 calc(50% - 4px);
            }

            .flashcard-stat-value {
                font-size: var(--text-2xl);
            }

            /* Forms */
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 12px;
                font-size: var(--text-base);
            }

            /* Buttons - minimum touch size */
            button,
            .btn-primary,
            .btn-success,
            .btn-secondary,
            .btn-danger,
            .btn-warning {
                min-height: 44px;
                /* iOS touch target */
                padding: 12px 20px;
            }

            /* Images - constrain on mobile */
            .question-item img,
            .test-question img {
                max-height: 300px;
            }
        }

        /* Small mobile (max-width: 480px) */
        @media (max-width: 480px) {

            /* Container - even less padding */
            .container {
                padding: 12px;
            }

            /* Typography - further reduced */
            h1 {
                font-size: var(--text-2xl);
                margin-bottom: 20px;
            }

            h2 {
                font-size: var(--text-xl);
            }

            /* Question items - compact */
            .question-item {
                padding: 20px 16px;
            }

            /* Question badge - even smaller */
            .question-item::before {
                padding: 3px 8px;
                font-size: 10px;
            }

            /* Navigation - horizontal scroll or stacked */
            nav {
                justify-content: flex-start;
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                /* Firefox */
            }

            nav::-webkit-scrollbar {
                display: none;
                /* Chrome/Safari */
            }

            nav button {
                flex-shrink: 0;
                padding: 8px 14px;
                font-size: 11px;
            }

            /* Test timer - very compact */
            .test-timer {
                padding: 12px 16px;
                font-size: var(--text-xl);
                flex-direction: column;
                gap: 4px;
            }

            .test-timer .timer-icon {
                font-size: var(--text-lg);
            }

            /* Flashcards - minimal */
            .flashcard {
                min-height: 320px;
            }

            .flashcard-face {
                min-height: 320px;
                padding: 24px 16px;
            }

            .flashcard-content h3,
            .flashcard-content .question-text {
                font-size: var(--text-base);
            }

            /* Flashcard options */
            .flashcard-option {
                padding: 12px 14px;
                margin: 8px 0;
            }

            .flashcard-option .option-number {
                width: 32px;
                height: 32px;
                font-size: var(--text-sm);
            }

            /* Flashcard rating - stacked vertically */
            .flashcard-rating {
                flex-direction: column;
                gap: 10px;
            }

            .flashcard-rating button {
                width: 100%;
                padding: 16px;
            }

            /* Stats - stacked */
            .flashcard-stats {
                flex-direction: column;
            }

            .flashcard-stat {
                width: 100%;
                padding: 12px;
            }

            .flashcard-stat-value {
                font-size: var(--text-2xl);
            }

            /* Keyboard hints - hide on very small screens or simplify */
            .flashcard-keyboard-hint {
                font-size: 11px;
                padding: 12px 16px;
                gap: 8px;
            }

            .flashcard-keyboard-hint kbd {
                padding: 4px 8px;
                font-size: 10px;
            }

            /* Touch-friendly form elements */
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 14px;
                font-size: 16px;
                /* Prevent iOS zoom */
            }

            /* Buttons - full width on small mobile */
            button,
            .btn-primary,
            .btn-success,
            .btn-secondary,
            .btn-danger,
            .btn-warning {
                width: 100%;
                margin-bottom: 8px;
            }

            button:last-child {
                margin-bottom: 0;
            }

            /* Images */
            .question-item img,
            .test-question img {
                max-height: 250px;
                margin: 12px 0;
            }
        }

        /* Landscape mobile optimizations */
        @media (max-height: 500px) and (orientation: landscape) {
            .flashcard {
                min-height: 280px;
            }

            .flashcard-face {
                min-height: 280px;
                padding: 20px;
            }

            .flashcard-content h3,
            .flashcard-content .question-text {
                font-size: var(--text-sm);
                line-height: var(--leading-normal);
            }

            .flashcard-hint {
                margin-top: 16px;
                padding: 8px 16px;
            }

            .test-timer {
                padding: 8px 12px;
                font-size: var(--text-lg);
            }

            .flashcard-rating {
                margin-top: 16px;
            }

            .flashcard-rating button {
                padding: 10px 16px;
                font-size: var(--text-sm);
            }
        }
    </style>
    <!-- ========== VALIDATION CSS ========== -->
    <style>
        .validation-message {
            margin-top: 5px;
            font-size: var(--text-sm);
        }

        .validation-success {
            color: #22c55e;
            font-weight: var(--font-medium);
        }

        .validation-error {
            color: #ef4444;
            font-weight: var(--font-medium);
        }
    </style>
    <!-- ========== LOADING SPINNER CSS ========== -->
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .spinner-text {
            color: white;
            margin-left: 16px;
            font-size: var(--text-lg);
            font-weight: var(--font-medium);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="spinner-text" id="loadingText">≈Åadowanie...</div>
    </div>

    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Dark mode toggle button -->
    <button class="dark-mode-toggle" onclick="window.toggleDarkMode()" title="Prze≈ÇƒÖcz tryb ciemny/jasny">
        <span id="dark-mode-icon">üåô</span>
    </button>

    <!-- Hamburger menu button (mobile only) -->
    <button class="hamburger-menu" id="hamburgerMenu" onclick="window.toggleMobileNav()" aria-label="Toggle navigation">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- Mobile navigation overlay -->
    <div class="mobile-nav-overlay" id="mobileNavOverlay" onclick="window.closeMobileNav()"></div>

    <div class="container">
        <h1>üìù Aplikacja Quizowo-Testowa <small style="font-size: 0.5em; color: #666;">v1.11</small></h1>

        <div id="auth-section">
            <div class="question-item">
                <h2>üé® Wybierz motyw:</h2>
                <div class="form-group">
                    <label for="loginThemeSelect">Motyw aplikacji:</label>
                    <select id="loginThemeSelect" onchange="window.setTheme(this.value, true)" style="cursor: pointer;">
                        <option value="classic">üîµ Klasyczny (niebieski)</option>
                        <option value="modern">‚ö° NEON Cyberpunk (ciemny)</option>
                        <option value="minimal">‚ö´ Minimalistyczny (czarno-bia≈Çy)</option>
                    </select>
                    <small style="color: var(--text-light); display: block; margin-top: 5px;">
                        Wybierz motyw przed zalogowaniem
                    </small>
                </div>
            </div>

            <div id="login-form" class="question-item">
                <h2 data-i18n="loginTitle">üîê Logowanie</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label data-i18n="username">Nazwa u≈ºytkownika:</label>
                        <input type="text" id="loginUsername" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="password">Has≈Ço:</label>
                        <input type="password" id="loginPassword" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="btn-primary" data-i18n="loginBtn">Zaloguj siƒô</button>
                    <button type="button" class="btn-secondary" onclick="window.showRegisterForm()"
                        data-i18n="registerBtn">Zarejestruj siƒô</button>
                </form>
            </div>

            <div id="register-form" class="question-item hidden">
                <h2 data-i18n="registerTitle">üìù Rejestracja</h2>
                <form id="registerForm">
                    <div class="form-group">
                        <label data-i18n="username">Nazwa u≈ºytkownika:</label>
                        <input type="text" id="regUsername" required oninput="window.validateUsername()">
                        <div id="usernameValidation" class="validation-message"></div>
                    </div>
                    <div class="form-group">
                        <label data-i18n="password">Has≈Ço:</label>
                        <input type="password" id="regPassword" required autocomplete="new-password">
                    </div>
                    <button type="submit" class="btn-success" data-i18n="registerBtn">Zarejestruj siƒô</button>
                    <button type="button" class="btn-secondary" onclick="window.showLoginForm()"
                        data-i18n="cancel">Anuluj</button>
                </form>
            </div>
        </div>

        <div id="app-section" class="hidden">
            <nav>
                <button onclick="window.showSection('dashboard')" id="nav-dashboard" data-i18n="dashboardSection">üìä
                    Dashboard</button>
                <button onclick="window.showSection('practice')" id="nav-practice" data-i18n="practiceSection">üìö Tryb
                    Nauki</button>
                <button onclick="window.showSection('flashcards')" id="nav-flashcards">üé¥ Fiszki</button>
                <button onclick="window.showSection('test')" id="nav-test" data-i18n="testSection">üìù Test</button>
                <button onclick="window.showSection('questions')" id="nav-questions" data-i18n="questionsSection">‚ùì
                    Pytania</button>
                <button onclick="window.showSection('results')" id="nav-results" data-i18n="resultsSection">üèÜ
                    Wyniki</button>
                <button onclick="window.showSection('admin')" id="nav-admin" class="admin-only">üîê Panel
                    Administratora</button>
                <button onclick="window.logout()" data-i18n="logout">üö™ Wyloguj</button>
            </nav>

            <div id="dashboard-section">
                <div class="question-item">
                    <h2><span data-i18n="welcome">üë§ Witaj</span>, <span id="currentUser"></span>!</h2>
                    <p><strong data-i18n="totalQuestions">Pyta≈Ñ w bazie:</strong> <span id="totalQuestions">0</span></p>
                    <p><strong data-i18n="totalResults">RozwiƒÖzanych test√≥w:</strong> <span id="totalTests">0</span></p>
                    <p><strong data-i18n="avgScore">≈öredni wynik:</strong> <span id="avgScore">0%</span></p>
                    <p><strong data-i18n="bestScore">Najlepszy wynik:</strong> <span id="bestScore">0%</span></p>
                    <p><strong data-i18n="lastTest">Ostatni test:</strong> <span id="lastTestScore">0%</span></p>
                </div>

                <div class="question-item">
                    <h2>üé® WyglƒÖd aplikacji</h2>
                    <div class="form-group">
                        <label for="themeSelect">Wybierz motyw:</label>
                        <select id="themeSelect" onchange="window.setTheme(this.value)" style="cursor: pointer;">
                            <option value="classic">üîµ Klasyczny (niebieski)</option>
                            <option value="modern">‚ö° NEON Cyberpunk (ciemny)</option>
                            <option value="minimal">‚ö´ Minimalistyczny (czarno-bia≈Çy)</option>
                        </select>
                        <small style="color: var(--text-light); display: block; margin-top: 5px;">
                            Zmiana motywu jest zapisywana automatycznie
                        </small>
                    </div>
                </div>

                <!-- Analytics Section -->
                <div id="analytics-dashboard"></div>
            </div>

            <div id="test-section" class="hidden">
                <div id="test-setup" class="question-item">
                    <h2>‚öôÔ∏è Ustawienia testu</h2>
                    <div class="form-group">
                        <label data-i18n="selectCategory">Kategoria:</label>
                        <select id="testCategory">
                            <option value="all" data-i18n="allCategories">Wszystkie kategorie</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="questionCount">Liczba pyta≈Ñ:</label>
                        <select id="questionCount">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="30">30</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="all" data-i18n="countAll">Wszystkie</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="randomizeAnswers" style="width: auto; cursor: pointer;">
                            <span data-i18n="randomizeAnswers">üîÄ Losuj kolejno≈õƒá odpowiedzi</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 5px;">Odpowiedzi bƒôdƒÖ wy≈õwietlane w
                            losowej kolejno≈õci (zapobiega uczeniu siƒô kolejno≈õci)</small>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="enableTimer" onchange="window.toggleTimerInput()"
                                style="width: auto; cursor: pointer;">
                            <span>‚è±Ô∏è W≈ÇƒÖcz timer</span>
                        </label>
                        <div id="timerInputContainer" class="hidden" style="margin-top: 10px; padding-left: 24px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <span data-i18n="timeLimit">‚è±Ô∏è Limit czasu:</span>
                                <input type="number" id="timerMinutes" min="1" max="300" value="30"
                                    style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <span data-i18n="minutes">minut</span>
                            </label>
                            <small style="color: #666; display: block; margin-top: 5px;">Po up≈Çywie czasu test zostanie
                                automatycznie zako≈Ñczony</small>
                        </div>
                    </div>
                    <button onclick="window.startTest()" class="btn-primary" data-i18n="startTest">üöÄ Rozpocznij
                        test</button>
                </div>

                <div id="test-interface" class="hidden">
                    <div id="testTimerDisplay" class="test-timer hidden">
                        <span class="timer-icon">‚è±Ô∏è</span>
                        <span id="timerCountdown">30:00</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressBar"></div>
                    </div>
                    <h3 data-i18n="questionOf">Pytanie <span id="currentQuestionNumber">1</span> z <span
                            id="totalTestQuestions">10</span></h3>
                    <div id="test-question-container"></div>
                    <button onclick="window.previousQuestion()" class="btn-secondary" data-i18n="previous">‚¨ÖÔ∏è
                        Poprzednie</button>
                    <button onclick="window.nextQuestion()" class="btn-primary" data-i18n="next">Nastƒôpne ‚û°Ô∏è</button>
                    <button onclick="window.finishTest()" class="btn-success" data-i18n="finishTest">‚úÖ Zako≈Ñcz
                        test</button>
                </div>

            </div>

            <div id="practice-section" class="hidden">
                <div id="practice-setup" class="question-item">
                    <h2 data-i18n="practiceMode">üìö Tryb nauki</h2>
                    <p style="margin-bottom: 10px;" data-i18n="practiceMode">Ucz siƒô z natychmiastowƒÖ informacjƒÖ zwrotnƒÖ
                        po ka≈ºdej odpowiedzi.</p>
                    <div class="form-group">
                        <label data-i18n="selectCategory">Kategoria:</label>
                        <select id="practiceCategory">
                            <option value="all" data-i18n="allCategories">Wszystkie kategorie</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="questionCount">Liczba pyta≈Ñ:</label>
                        <select id="practiceQuestionCount">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="30">30</option>
                            <option value="50">50</option>
                            <option value="all" data-i18n="countAll">Wszystkie</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="randomizeAnswersPractice" style="width: auto; cursor: pointer;">
                            <span data-i18n="randomizeAnswers">üîÄ Losuj kolejno≈õƒá odpowiedzi</span>
                        </label>
                        <small style="color: #666;">Odpowiedzi bƒôdƒÖ wy≈õwietlane w losowej kolejno≈õci (zapobiega uczeniu
                            siƒô kolejno≈õci)</small>
                    </div>
                    <button onclick="window.startPractice()" class="btn-success" data-i18n="startPractice">üìñ Rozpocznij
                        naukƒô</button>
                </div>

                <div id="practice-interface" class="hidden">
                    <div class="practice-stats">
                        <div>
                            <h3>üìö Sesja nauki</h3>
                            <p data-i18n="questionOf">Pytanie <span id="practiceCurrentNumber">1</span> z <span
                                    id="practiceTotalQuestions">10</span></p>
                            <p><strong data-i18n="correct">Poprawne:</strong> <span id="practiceCorrect"
                                    style="color: #28a745;">0</span> | <strong
                                    data-i18n="incorrect">B≈Çƒôdne:</strong> <span id="practiceIncorrect"
                                    style="color: #dc3545;">0</span></p>
                        </div>
                    </div>
                    <div id="practice-question-container"></div>
                    <div id="practice-feedback"></div>
                    <button onclick="window.endPracticeEarly()" class="btn-secondary"
                        style="white-space: nowrap;" data-i18n="exitPractice">
                        ‚èπÔ∏è Zako≈Ñcz naukƒô
                    </button>
                </div>

            </div>

            <div id="questions-section" class="hidden">
                <!-- SEKCJA 1: Dodawanie pytania -->
                <div class="question-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;"
                        onclick="window.toggleSection('add-question-content', 'add-question-icon')">
                        <h2 data-i18n="addQuestion">‚ûï Dodaj/edytuj pytanie</h2>
                        <span id="add-question-icon" style="font-size: 24px;">‚ñº</span>
                    </div>
                    <div id="add-question-content" class="hidden" style="margin-top: 15px;">
                        <button onclick="window.showAddQuestionForm()" class="btn-primary">Poka≈º formularz</button>
                        <button onclick="window.hideAddQuestionForm()" class="btn-secondary">Ukryj formularz</button>

                        <div id="add-question-form" class="hidden" style="margin-top: 15px;">
                            <h3 id="form-title">Nowe pytanie</h3>
                            <form id="questionForm">
                                <!-- Tre≈õƒá pytania z WYSIWYG -->
                                <div class="form-group">
                                    <label data-i18n="questionForm.questionText">Tre≈õƒá pytania:</label>
                                    <div class="wysiwyg-container">
                                        <div class="wysiwyg-toolbar" id="questionToolbar">
                                            <button type="button" data-cmd="bold"><b>B</b></button>
                                            <button type="button" data-cmd="italic"><i>I</i></button>
                                            <button type="button" data-cmd="insertUnorderedList">‚Ä¢ Lista</button>
                                            <button type="button" data-cmd="removeFormat">üßπ</button>
                                        </div>
                                        <div id="questionEditor" class="wysiwyg-editor" contenteditable="true"></div>
                                    </div>
                                    <textarea id="questionText" class="hidden" required></textarea>
                                </div>

                                <!-- Obraz w pytaniu -->
                                <div class="form-group">
                                    <label data-i18n="questionForm.imageUpload">üñºÔ∏è Obraz w pytaniu
                                        (opcjonalne):</label>
                                    <input type="file" id="questionImage" accept="image/*"
                                        onchange="window.handleImageUpload(event)" style="margin-bottom: 10px;">
                                    <div id="imagePreviewContainer" style="display: none; margin-top: 10px;">
                                        <div style="position: relative; display: inline-block;">
                                            <img id="imagePreview"
                                                style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 2px solid #ddd;"
                                                alt="PodglƒÖd obrazu">
                                            <button type="button" onclick="window.removeImage()" class="btn-danger"
                                                style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; font-size: 14px;"
                                                data-i18n="questionForm.removeImage">‚ùå Usu≈Ñ</button>
                                        </div>
                                        <p id="imageSizeInfo" style="font-size: 0.85em; color: #666; margin-top: 5px;">
                                        </p>
                                    </div>
                                    <small style="color: #666;" data-i18n="questionForm.imageSize">Maksymalny rozmiar:
                                        2MB. Obs≈Çugiwane formaty: JPG, PNG, GIF, WebP.</small>
                                </div>

                                <div class="form-group">
                                    <label data-i18n="questionForm.questionType">Typ pytania:</label>
                                    <select id="questionType" onchange="window.handleQuestionTypeChange()">
                                        <option value="single" data-i18n="questionForm.typeSingle">Jedna poprawna
                                            odpowied≈∫</option>
                                        <option value="multiple" data-i18n="questionForm.typeMultiple">Wiele poprawnych
                                            odpowiedzi</option>
                                        <option value="ordering" data-i18n="questionForm.typeOrdering">U≈Ç√≥≈º w kolejno≈õci
                                            (Ordering)</option>
                                    </select>
                                </div>

                                <!-- Dynamiczne odpowiedzi -->
                                <div class="form-group">
                                    <label data-i18n="questionForm.answers">Odpowiedzi:</label>
                                    <div id="options-container">
                                        <!-- Generowane dynamicznie przez JS -->
                                    </div>
                                    <button type="button" id="addOptionBtn" class="add-option-btn"
                                        onclick="window.addOption()" data-i18n="questionForm.addAnswer">+ Dodaj
                                        odpowied≈∫</button>
                                    <small style="color: #666; display: block; margin-top: 5px;"
                                        data-i18n="questionForm.minMaxAnswers">Minimum 2, maksimum 10 odpowiedzi.
                                        Zaznacz ‚úì przy poprawnych.</small>
                                </div>

                                <!-- Ordering steps (dla typu ordering) -->
                                <div id="ordering-steps-container" class="form-group hidden">
                                    <label data-i18n="questionForm.orderingSteps">Kroki do u≈Ço≈ºenia (w prawid≈Çowej
                                        kolejno≈õci):</label>
                                    <small style="color: #666; display: block; margin-bottom: 10px;"
                                        data-i18n="questionForm.orderingHint">Dodaj kroki w poprawnej kolejno≈õci - to
                                        bƒôdzie odpowied≈∫ poprawna.</small>
                                    <div id="ordering-steps">
                                        <!-- Generowane dynamicznie -->
                                    </div>
                                    <button type="button" class="add-option-btn" onclick="window.addOrderingStep()"
                                        data-i18n="questionForm.addStep">+ Dodaj krok</button>
                                    <small style="color: #666; display: block; margin-top: 5px;"
                                        data-i18n="questionForm.minMaxSteps">Minimum 2, maksimum 8 krok√≥w.</small>
                                </div>

                                <div class="form-group">
                                    <label data-i18n="questionForm.category">Kategoria (np. AZ-104, AZ-900,
                                        Linux+):</label>
                                    <input type="text" id="questionCategory" list="existingCategories"
                                        placeholder="Wybierz lub wpisz nazwƒô kategorii">
                                    <datalist id="existingCategories"></datalist>
                                    <small style="color: #666;">Np. AZ-104, AZ-900, AZ-500, Linux+, Security+</small>
                                </div>

                                <div class="form-group">
                                    <label data-i18n="questionForm.tags">Tagi (np. Entra ID, User Management,
                                        Networking):</label>
                                    <div class="tags-input-container">
                                        <input type="text" id="tagInput" placeholder="Wpisz tag i naci≈õnij Enter">
                                        <div id="tagsList" class="tags-list"></div>
                                    </div>
                                    <small style="color: #666;">Np. Entra ID, User Management, Networking, Storage,
                                        Security</small>
                                </div>

                                <!-- Wyja≈õnienie z WYSIWYG -->
                                <div class="form-group">
                                    <label data-i18n="questionForm.explanation">Wyja≈õnienie (opcjonalnie):</label>
                                    <div class="wysiwyg-container">
                                        <div class="wysiwyg-toolbar" id="explanationToolbar">
                                            <button type="button" data-cmd="bold"><b>B</b></button>
                                            <button type="button" data-cmd="italic"><i>I</i></button>
                                            <button type="button" data-cmd="insertUnorderedList">‚Ä¢ Lista</button>
                                            <button type="button" data-cmd="removeFormat">üßπ</button>
                                        </div>
                                        <div id="explanationEditor" class="wysiwyg-editor" contenteditable="true"></div>
                                    </div>
                                    <textarea id="explanation" class="hidden"
                                        placeholder="Dodaj wyja≈õnienie lub kontekst dla tego pytania..."></textarea>
                                </div>

                                <!-- PodglƒÖd na ≈ºywo -->
                                <div class="live-preview-container">
                                    <h3 data-i18n="questionForm.livePreview">üëÅÔ∏è PodglƒÖd na ≈ºywo</h3>
                                    <div id="live-preview" class="live-preview-content">
                                        <p style="color: #999; text-align: center; padding: 20px;" data-i18n="fillForm">
                                            Wype≈Çnij formularz aby zobaczyƒá podglƒÖd pytania...
                                        </p>
                                    </div>
                                </div>

                                <button type="submit" class="btn-success" style="margin-top: 20px;"
                                    data-i18n="questionForm.saveQuestion">üíæ Zapisz pytanie</button>
                                <button type="button" class="btn-secondary" onclick="window.hideAddQuestionForm()"
                                    data-i18n="questionForm.cancel">Anuluj</button>
                            </form>
                        </div>
                    </div> <!-- Koniec add-question-content -->
                </div> <!-- Koniec sekcja 1 -->

                <!-- SEKCJA 2: Import / Eksport - ZWIJANE -->
                <div class="question-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;"
                        onclick="window.toggleSection('import-export-content', 'import-export-icon')">
                        <h2 data-i18n="importExport">üì• Import / üì§ Eksport pyta≈Ñ</h2>
                        <span id="import-export-icon" style="font-size: 24px;">‚ñº</span>
                    </div>
                    <div id="import-export-content" class="hidden" style="margin-top: 15px;">

                        <!-- Eksport CSV -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="margin-bottom: 10px;" data-i18n="exportCSV">üì§ Eksport pyta≈Ñ do CSV</h4>
                            <div class="form-group">
                                <label data-i18n="selectCategory">Wybierz kategoriƒô do eksportu:</label>
                                <select id="exportCategorySelect">
                                    <option value="all" data-i18n="allCategories">Wszystkie kategorie</option>
                                </select>
                            </div>
                            <button onclick="window.exportQuestions()" class="btn-success" style="width: 100%;">üì§
                                Eksportuj wybranƒÖ kategoriƒô (CSV)</button>
                        </div>

                        <!-- Eksport JSON -->
                        <div
                            style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #007bff;">
                            <h4 style="margin-bottom: 10px;">üì¶ Eksport pyta≈Ñ do JSON <small
                                    style="color: #666;">(zalecane - zachowuje formatowanie)</small></h4>
                            <div class="form-group">
                                <label>Wybierz kategoriƒô do eksportu:</label>
                                <select id="exportCategorySelectJSON">
                                    <option value="all">Wszystkie kategorie</option>
                                </select>
                            </div>
                            <button onclick="window.exportQuestionsJSON()" class="btn-primary" style="width: 100%;">üì¶
                                Eksportuj do JSON</button>
                        </div>

                        <!-- Enhanced Export -->
                        <div
                            style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #0ea5e9;">
                            <h4 style="margin-bottom: 10px;">üìä Rozszerzony eksport</h4>
                            <div class="export-grid">
                                <div class="export-option" onclick="window.exportQuestionsPDF()"
                                    style="cursor: pointer;">
                                    <h4>üìÑ PDF</h4>
                                    <p style="font-size: 12px; color: #666;">Wydruk do PDF z formatowaniem</p>
                                </div>
                                <div class="export-option" onclick="window.exportQuestionsExcel()"
                                    style="cursor: pointer;">
                                    <h4>üìä Excel</h4>
                                    <p style="font-size: 12px; color: #666;">Tabela Excel z kolorowaniem</p>
                                </div>
                                <div class="export-option" onclick="window.exportUserResultsCSV()"
                                    style="cursor: pointer;">
                                    <h4>üìà Wyniki</h4>
                                    <p style="font-size: 12px; color: #666;">Eksportuj swoje wyniki (CSV)</p>
                                </div>
                            </div>
                        </div>

                        <!-- Import CSV -->
                        <div
                            style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                            <h4 style="margin-bottom: 10px;">üì• Import pyta≈Ñ z CSV</h4>
                            <div class="form-group">
                                <label>Przypisz do kategorii:</label>
                                <select id="importCategorySelect">
                                    <option value="">-- Wybierz kategoriƒô --</option>
                                    <option value="keep">Zachowaj oryginalnƒÖ kategoriƒô z pliku</option>
                                    <option value="new">--- Utw√≥rz nowƒÖ kategoriƒô ---</option>
                                </select>
                            </div>
                            <div class="form-group hidden" id="newCategoryInput">
                                <label>Nazwa nowej kategorii:</label>
                                <input type="text" id="newCategoryName" placeholder="np. AZ-104">
                            </div>
                            <div class="form-group">
                                <label>Wybierz plik CSV:</label>
                                <input type="file" id="importFile" accept=".txt,.csv">
                            </div>
                            <div
                                style="background: white; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #dc3545;">
                                <strong>‚ö†Ô∏è Automatyczny backup:</strong> Przed importem zostanie utworzony automatyczny
                                backup istniejƒÖcych pyta≈Ñ.
                            </div>
                            <button onclick="window.importQuestions()" class="btn-primary" style="width: 100%;">üì•
                                Importuj pytania (CSV)</button>
                        </div>

                        <!-- Import JSON -->
                        <div
                            style="background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                            <h4 style="margin-bottom: 10px;">üì¶ Import pyta≈Ñ z JSON <small
                                    style="color: #666;">(zalecane - zachowuje formatowanie)</small></h4>
                            <div class="form-group">
                                <label>Tryb importu:</label>
                                <select id="importJSONMode">
                                    <option value="merge">üîó Do≈ÇƒÖcz do istniejƒÖcych pyta≈Ñ</option>
                                    <option value="replace">üîÑ ZastƒÖp wszystkie pytania</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Wybierz plik JSON:</label>
                                <input type="file" id="importJSONFile" accept=".json">
                            </div>
                            <div
                                style="background: white; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #28a745;">
                                <strong>‚úÖ Automatyczny backup:</strong> Przed importem zostanie utworzony automatyczny
                                backup istniejƒÖcych pyta≈Ñ.
                            </div>
                            <button onclick="window.importQuestionsJSON()" class="btn-success" style="width: 100%;">üì¶
                                Importuj pytania (JSON)</button>
                        </div>
                    </div> <!-- Koniec import-export-content -->
                </div> <!-- Koniec sekcja 2 -->

                <!-- SEKCJA 3: Wyszukiwarka i filtry - ZWIJANE (Domy≈õlnie OTWARTE) -->
                <div class="question-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;"
                        onclick="window.toggleSection('search-filter-content', 'search-filter-icon')">
                        <h2 data-i18n="searchFilter">üîç Wyszukiwarka i filtry</h2>
                        <span id="search-filter-icon" style="font-size: 24px;">‚ñ≤</span> <!-- Domy≈õlnie otwarte -->
                    </div>
                    <div id="search-filter-content" style="margin-top: 15px;">
                        <!-- Brak class="hidden" = domy≈õlnie otwarte -->


                        <div class="form-group">
                            <label>Szukaj w pytaniach:</label>
                            <input type="text" id="searchQuestions" data-i18n-placeholder="searchPlaceholder"
                                placeholder="Wpisz szukanƒÖ frazƒô..." oninput="window.filterQuestions()">
                            <small style="color: #666;">Szuka w tre≈õci pytania, wyja≈õnieniach i odpowiedziach</small>
                        </div>

                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label data-i18n="filterCategory">Filtruj po kategorii:</label>
                                <select id="filterCategory" onchange="window.filterQuestions()">
                                    <option value="all" data-i18n="allCategories">Wszystkie kategorie</option>
                                </select>
                            </div>

                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label data-i18n="filterTag">Filtruj po tagu:</label>
                                <select id="filterTag" onchange="window.filterQuestions()">
                                    <option value="all">Wszystkie tagi</option>
                                </select>
                            </div>

                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label>Filtruj po typie:</label>
                                <select id="filterType" onchange="window.filterQuestions()">
                                    <option value="all">Wszystkie typy</option>
                                    <option value="single">Jedna poprawna</option>
                                    <option value="multiple">Wiele poprawnych</option>
                                    <option value="ordering">U≈Ç√≥≈º w kolejno≈õci</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="filterMarkedForReview" onchange="window.filterQuestions()"
                                    style="width: auto; cursor: pointer;">
                                <span>‚≠ê Tylko pytania oznaczone do powt√≥rki</span>
                            </label>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button onclick="window.clearFilters()" class="btn-secondary">üßπ Wyczy≈õƒá filtry</button>
                            <span id="filterResults" style="padding: 10px; font-weight: bold; color: #007bff;"></span>
                        </div>
                    </div> <!-- Koniec search-filter-content -->
                </div> <!-- Koniec sekcja 3 -->

                <!-- SEKCJA 4: Lista pyta≈Ñ - ZWIJANE (Domy≈õlnie OTWARTA) -->
                <div class="question-item">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;"
                        onclick="window.toggleSection('questions-list-content', 'questions-list-icon')">
                        <h2>üìã Lista pyta≈Ñ w bazie (<span id="questionsCount">0</span>)</h2>
                        <span id="questions-list-icon" style="font-size: 24px;">‚ñ≤</span> <!-- Domy≈õlnie otwarta -->
                    </div>
                    <div id="questions-list-content" style="margin-top: 15px;">
                        <!-- Brak class="hidden" = domy≈õlnie otwarta -->
                        <div id="questions-list"></div>
                        <div id="pagination-container" class="pagination-container hidden">
                            <div class="pagination-info">
                                <span id="pagination-info-text">Pokazano 1-10 z 50</span>
                            </div>
                            <div class="pagination-page-size">
                                <label>Poka≈º na stronƒô:</label>
                                <select id="itemsPerPage" onchange="window.changeItemsPerPage()">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                            <div class="pagination-controls">
                                <button class="pagination-btn" onclick="window.firstPage()" id="btn-first">¬´¬´</button>
                                <button class="pagination-btn" onclick="window.previousPage()" id="btn-prev">¬´</button>
                                <span id="page-numbers" style="display: flex; gap: 5px;"></span>
                                <button class="pagination-btn" onclick="window.nextPage()" id="btn-next">¬ª</button>
                                <button class="pagination-btn" onclick="window.lastPage()" id="btn-last">¬ª¬ª</button>
                            </div>
                        </div>
                    </div> <!-- Koniec questions-list-content -->
                </div> <!-- Koniec sekcja 4 -->
            </div>

            <div id="results-section" class="hidden">
                <h2 data-i18n="yourResults">üèÜ Twoje wyniki</h2>
                <div style="margin-bottom: 15px;">
                    <button onclick="window.exportResults()" class="btn-success">üì§ Eksportuj wyniki (CSV)</button>
                </div>
                <div id="results-list"></div>
            </div>

            <div id="detailed-results-section" class="hidden">
                <div id="detailed-results-content"></div>
            </div>

            <div id="admin-section" class="hidden">
                <h2 data-i18n="adminPanel">üîê Panel Administratora</h2>
                <div class="question-item">
                    <h3 data-i18n="manageUsers">ZarzƒÖdzanie u≈ºytkownikami</h3>
                    <div id="admin-users-list"></div>
                </div>
                <div class="question-item">
                    <h2>üíæ Backup wszystkich danych</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Eksportuj kompletne dane aplikacji (wszyscy u≈ºytkownicy z wynikami + wszystkie pytania) do
                        jednego pliku JSON.
                    </p>
                    <div style="background: var(--input-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="margin-bottom: 10px;"><strong>Zawarto≈õƒá backupu:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>‚úÖ Wszyscy u≈ºytkownicy (has≈Ça sƒÖ hashowane)</li>
                            <li>‚úÖ Historia wynik√≥w wszystkich u≈ºytkownik√≥w</li>
                            <li>‚úÖ Wszystkie pytania z obrazami (Base64)</li>
                            <li>‚úÖ Ustawienia aplikacji</li>
                        </ul>
                    </div>
                    <button onclick="window.fullBackup()" class="btn-success" style="width: 100%; margin-bottom: 15px;">
                        üíæ Pobierz pe≈Çny backup (WSZYSTKIE DANE)
                    </button>

                    <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border-color);">

                    <h3 style="margin-bottom: 15px;">üì• Import backupu</h3>
                    <div style="background: var(--input-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="margin-bottom: 10px;"><strong>‚ö†Ô∏è Uwaga:</strong> Import nadpisuje wszystkie obecne
                            dane!</p>
                        <ul style="margin-left: 20px; line-height: 1.8; margin-bottom: 15px;">
                            <li>üîÑ U≈ºytkownicy zostanƒÖ zastƒÖpieni</li>
                            <li>üîÑ Pytania zostanƒÖ zastƒÖpione</li>
                            <li>üîÑ Wyniki test√≥w zostanƒÖ zastƒÖpione</li>
                        </ul>
                    </div>
                    <div class="form-group">
                        <label for="backupFileInput">Wybierz plik backupu (.json):</label>
                        <input type="file" id="backupFileInput" accept=".json" style="margin-bottom: 15px;">
                    </div>
                    <button onclick="window.importBackup()" class="btn-warning" style="width: 100%;">
                        üì• Przywr√≥ƒá dane z backupu
                    </button>
                    <small style="color: var(--text-light); display: block; margin-top: 10px;">
                        Po imporcie strona zostanie automatycznie od≈õwie≈ºona.
                    </small>
                </div>
            </div>

            <div id="flashcards-section" class="hidden">
                <div id="flashcard-setup" class="question-item">
                    <h2 data-i18n="flashcardsMode">üé¥ Tryb Fiszek - Uczenie Aktywne</h2>
                    <p style="color: #666; margin-bottom: 20px;" data-i18n="flashcardsHint">Fiszki pomagajƒÖ w aktywnym
                        przypominaniu informacji - widzisz pytanie, pr√≥bujesz sobie przypomnieƒá odpowied≈∫, a nastƒôpnie
                        sprawdzasz czy dobrze przypomnia≈Çe≈õ.</p>

                    <div class="form-group">
                        <label data-i18n="selectFlashcardsCategory">Kategoria:</label>
                        <select id="flashcardCategory">
                            <option value="all" data-i18n="allCategories">Wszystkie kategorie</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Tryb:</label>
                        <select id="flashcardMode">
                            <option value="all">Wszystkie pytania (oznaczone na poczƒÖtku)</option>
                            <option value="markedForReview">‚≠ê Tylko oznaczone do powt√≥rki</option>
                            <option value="difficult">üîÑ Tylko powt√≥rki (pytania oznaczone "Nie umiem")</option>
                            <option value="srs">üß† Spaced Repetition (due for review)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Liczba fiszek:</label>
                        <select id="flashcardCount">
                            <option value="10">10 fiszek</option>
                            <option value="20">20 fiszek</option>
                            <option value="30">30 fiszek</option>
                            <option value="50">50 fiszek</option>
                            <option value="all">Wszystkie dostƒôpne</option>
                        </select>
                    </div>

                    <div id="flashcardDifficultInfo" class="hidden"
                        style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <strong>‚ÑπÔ∏è Tryb powt√≥rek:</strong> Pokazuje tylko pytania kt√≥re wcze≈õniej oznaczy≈Çe≈õ jako "Nie
                        umiem".
                        Do≈ÇƒÖczone pytania: <span id="difficultCount">0</span>
                    </div>

                    <div id="flashcardMarkedInfo" class="hidden"
                        style="background: #d1ecf1; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <strong>‚≠ê Tryb oznaczonych do powt√≥rki:</strong> Pokazuje pytania oznaczone gwiazdkƒÖ w wynikach.
                        Do≈ÇƒÖczone pytania: <span id="markedCount">0</span>
                    </div>

                    <button onclick="window.startFlashcards()" class="btn-primary"
                        style="width: 100%; margin-top: 15px;">üé¥ Rozpocznij sesjƒô fiszek</button>
                </div>

                <div id="flashcard-active" class="hidden">
                    <button onclick="window.exitFlashcards()" class="btn-secondary" style="margin-bottom: 20px;">‚¨ÖÔ∏è Wr√≥ƒá
                        do ustawie≈Ñ</button>

                    <div class="flashcard-progress">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Fiszka <strong id="flashcard-current">1</strong> z <strong
                                    id="flashcard-total">10</strong></span>
                            <span id="flashcard-percent">0%</span>
                        </div>
                        <div class="flashcard-progress-bar">
                            <div class="flashcard-progress-fill" id="flashcard-progress-fill" style="width: 0%;"></div>
                        </div>
                        <div class="flashcard-stats">
                            <div class="flashcard-stat">
                                <div class="flashcard-stat-value" id="flashcard-know">0</div>
                                <div class="flashcard-stat-label">‚úÖ Umia≈Çem</div>
                            </div>
                            <div class="flashcard-stat">
                                <div class="flashcard-stat-value" id="flashcard-dontknow">0</div>
                                <div class="flashcard-stat-label">‚ùå Nie umia≈Çem</div>
                            </div>
                        </div>
                    </div>

                    <div class="flashcard-container">
                        <div class="flashcard" id="flashcard" onclick="window.flipCard()">
                            <div class="flashcard-face flashcard-front">
                                <div class="flashcard-content">
                                    <div id="flashcard-question" class="question-text"></div>
                                    <div class="flashcard-hint">üëÜ Kliknij aby odkryƒá odpowied≈∫</div>
                                </div>
                            </div>
                            <div class="flashcard-face flashcard-back">
                                <div class="flashcard-content">
                                    <div id="flashcard-answer-question" class="question-text"></div>
                                    <div class="flashcard-options" id="flashcard-options"></div>
                                    <div class="flashcard-rating" id="flashcard-rating" style="display: none;">
                                        <!-- Standard 2-button rating -->
                                        <div id="flashcard-rating-simple" style="display: none; gap: 10px;">
                                            <button class="btn-know"
                                                onclick="event.stopPropagation(); window.rateFlashcard(true)">
                                                ‚úÖ Umiem to
                                            </button>
                                            <button class="btn-dont-know"
                                                onclick="event.stopPropagation(); window.rateFlashcard(false)">
                                                ‚ùå Nie umiem
                                            </button>
                                        </div>
                                        <!-- SRS 4-button rating -->
                                        <div id="flashcard-rating-srs" class="srs-buttons" style="display: none;">
                                            <button class="srs-button again"
                                                onclick="event.stopPropagation(); window.rateFlashcardSRS(0)">
                                                ‚ùå Pon√≥w<br><small>zapomnia≈Çem</small>
                                            </button>
                                            <button class="srs-button hard"
                                                onclick="event.stopPropagation(); window.rateFlashcardSRS(2)">
                                                üí™ Trudne<br><small>ale pamiƒôtam</small>
                                            </button>
                                            <button class="srs-button good"
                                                onclick="event.stopPropagation(); window.rateFlashcardSRS(3)">
                                                üëç Dobrze<br><small>prawie idealnie</small>
                                            </button>
                                            <button class="srs-button easy"
                                                onclick="event.stopPropagation(); window.rateFlashcardSRS(5)">
                                                ‚≠ê ≈Åatwe<br><small>b≈Çyskawicznie</small>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flashcard-keyboard-hint">
                        <kbd>Spacja</kbd> Odkryj | SRS: <kbd>1</kbd> Pon√≥w <kbd>2</kbd> Trudne <kbd>3</kbd> Dobrze
                        <kbd>4</kbd> ≈Åatwe | Normalny: <kbd>1</kbd> Nie <kbd>2</kbd> Tak | <kbd>‚Üê</kbd><kbd>‚Üí</kbd>
                        Nawigacja
                    </div>
                </div>

                <div id="flashcard-complete" class="hidden">
                    <div class="flashcard-complete">
                        <h2>üéâ Sesja zako≈Ñczona!</h2>
                        <div class="flashcard-complete-score" id="flashcard-final-score">0%</div>
                        <p id="flashcard-final-message"></p>
                        <div class="flashcard-stats"
                            style="justify-content: center; max-width: 400px; margin: 20px auto;">
                            <div class="flashcard-stat">
                                <div class="flashcard-stat-value" id="final-know">0</div>
                                <div class="flashcard-stat-label">‚úÖ Umia≈Çe≈õ</div>
                            </div>
                            <div class="flashcard-stat">
                                <div class="flashcard-stat-value" id="final-dontknow">0</div>
                                <div class="flashcard-stat-label">‚ùå Nie umia≈Çe≈õ</div>
                            </div>
                        </div>
                        <button onclick="window.exitFlashcards()" class="btn-primary" style="margin-top: 30px;">üîÑ Nowa
                            sesja</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notes-modal" class="notes-modal" style="display: none;">
        <div class="notes-modal-overlay" onclick="window.closeNotesModal()"></div>
        <div class="notes-modal-content">
            <div class="notes-modal-header">
                <h2>üìù Notatki do pytania</h2>
                <button onclick="window.closeNotesModal()" class="notes-modal-close">&times;</button>
            </div>
            <div class="notes-modal-body">
                <div id="notes-question-text"
                    style="margin-bottom: 16px; padding: 12px; background: var(--bg-warm); border-radius: var(--border-radius); font-size: var(--text-sm);">
                </div>
                <div id="notes-list" class="notes-list"></div>
                <div class="notes-add-new" style="margin-top: 16px;">
                    <textarea id="note-input" class="notes-textarea" placeholder="Wpisz swojƒÖ notatkƒô..."></textarea>
                    <button onclick="window.saveNoteFromModal()" class="btn-primary"
                        style="margin-top: 8px; width: 100%;">üíæ Zapisz notatkƒô</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let users = JSON.parse(safeGetItem("quizUsers", "{}")) || {};

        // ========== MOBILE NAVIGATION ==========
        window.toggleMobileNav = function () {
            const nav = document.querySelector('nav');
            const hamburger = document.getElementById('hamburgerMenu');
            const overlay = document.getElementById('mobileNavOverlay');

            nav.classList.toggle('active');
            hamburger.classList.toggle('active');
            overlay.classList.toggle('active');

            // Prevent body scroll when menu is open
            if (nav.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        };

        window.closeMobileNav = function () {
            const nav = document.querySelector('nav');
            const hamburger = document.getElementById('hamburgerMenu');
            const overlay = document.getElementById('mobileNavOverlay');

            nav.classList.remove('active');
            hamburger.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        };

        // ========== BOTTOM NAVIGATION (Mobile) ==========
        window.toggleBottomNavMore = function () {
            const moreMenu = document.getElementById('bottomNavMoreMenu');
            moreMenu.classList.toggle('show');

            // Close when clicking outside
            if (moreMenu.classList.contains('show')) {
                setTimeout(() => {
                    document.addEventListener('click', window.closeBottomNavMoreOutside);
                }, 100);
            }
        };

        window.closeBottomNavMoreOutside = function (event) {
            const moreMenu = document.getElementById('bottomNavMoreMenu');
            const moreBtn = document.getElementById('bottomNavMoreBtn');

            if (!moreMenu.contains(event.target) && !moreBtn.contains(event.target)) {
                moreMenu.classList.remove('show');
                document.removeEventListener('click', window.closeBottomNavMoreOutside);
            }
        };

        window.updateBottomNavActive = function (sectionName) {
            // Remove active class from all items
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Add active class to current section
            const activeItem = document.querySelector(`.bottom-nav-item[data-section="${sectionName}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        };

        // Close mobile nav when a nav button is clicked
        document.addEventListener('DOMContentLoaded', function () {
            const navButtons = document.querySelectorAll('nav button');
            navButtons.forEach(button => {
                button.addEventListener('click', function () {
                    if (window.innerWidth <= 768) {
                        window.closeMobileNav();
                    }
                });
            });

            // ========== SERVICE WORKER REGISTRATION (PWA) ==========
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function () {
                    navigator.serviceWorker.register('./service-worker.js')
                        .then(function (registration) {
                            console.log('Service Worker registered with scope:', registration.scope);

                            // Check for updates
                            registration.addEventListener('updatefound', function () {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', function () {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        // New version available
                                        if (confirm('Dostƒôpna jest nowa wersja aplikacji. Czy chcesz zaktualizowaƒá?')) {
                                            window.location.reload();
                                        }
                                    }
                                });
                            });
                        })
                        .catch(function (error) {
                            console.error('Service Worker registration failed:', error);
                        });
                });
            } else {
                console.log('Service Worker is not supported in this browser');
            }
        });

        // ========== AUTENTYFIKACJA - funkcje globalne ==========
        function showRegisterForm() {
            document.getElementById("login-form").classList.add("hidden");
            document.getElementById("register-form").classList.remove("hidden");
        }

        function showLoginForm() {
            document.getElementById("register-form").classList.add("hidden");
            document.getElementById("login-form").classList.remove("hidden");
        }

        // ========== PRZYWRACANIE SESJI ==========
        function restoreSession() {
            const savedUser = safeGetItem('currentUser');
            if (savedUser && users[savedUser]) {
                currentUser = savedUser;
                document.body.classList.add('logged-in');
                document.getElementById("auth-section").classList.add("hidden");
                document.getElementById("app-section").classList.remove("hidden");
                document.getElementById("currentUser").textContent = currentUser;
                updateDashboard();

                // Za≈Çadz motyw u≈ºytkownika
                loadSavedTheme();

                // Poka≈º przyciski panelu administratora tylko dla administrator√≥w
                if (users[currentUser].isAdmin) {
                    document.body.classList.add("is-admin");
                } else {
                    document.body.classList.remove("is-admin");
                }

                // Initialize bottom nav active state
                window.updateBottomNavActive('dashboard');

                return true;
            }
            return false;
        }

        // ========== MIGRACJA DANYCH U≈ªYTKOWNIK√ìW ==========
        function migrateUserData() {
            let needsSave = false;

            for (let username in users) {
                const user = users[username];

                // Migracja has≈Ça z jawnego tekstu do hashu (przy pierwszym uruchomieniu)
                if (user.password && !user.passwordHash) {
                    // Has≈Ço w jawnym tek≈õcie - migracja przy nastƒôpnym logowaniu
                    // Na razie przenie≈õ do passwordHash
                    user.passwordHash = user.password;
                    delete user.password;
                    needsSave = true;
                }

                // Inicjalizacja nowych p√≥l dla istniejƒÖcych u≈ºytkownik√≥w
                if (user.isAdmin === undefined) {
                    // Sprawd≈∫ czy to admin na podstawie nazwy
                    user.isAdmin = (username === "admin" || username === "administrator");
                    needsSave = true;
                }

                if (user.canEditQuestions === undefined) {
                    // Domy≈õlnie wszyscy mogƒÖ edytowaƒá (kompatybilno≈õƒá wsteczna)
                    user.canEditQuestions = true;
                    needsSave = true;
                }

                if (user.isBlocked === undefined) {
                    user.isBlocked = false;
                    needsSave = true;
                }
            }

            if (needsSave) {
                safeSetItem("quizUsers", JSON.stringify(users));
                console.log("Migracja danych u≈ºytkownik√≥w zako≈Ñczona.");
            }
        }

        // Wywo≈Çaj migracjƒô przy starcie
        migrateUserData();

        let questions = [];
        let currentTestQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let editingQuestionId = null;
        let practiceQuestions = [];
        let practiceQuestionIndex = 0;
        let practiceCorrect = 0;
        let practiceIncorrect = 0;
        let practiceAnswered = false;
        let practiceUserAnswers = []; // Store multiple selections for practice mode
        let practiceSelectedAnswers = []; // Track selected answers for current practice question
        let currentTags = []; // Track tags for current question being edited/created

        // Timer variables
        let testTimerInterval = null;
        let testTimeLeft = 0; // in seconds
        let isTimerRunning = false;

        // Pagination variables
        let questionsCurrentPage = 1;
        let questionsItemsPerPage = 10;
        let filteredQuestionsForPagination = [];

        // ========== THEME SYSTEM ==========

        // ========== THEME SYSTEM ==========
        function setTheme(themeName, quiet = false) {
            // Wy≈ÇƒÖcz dark mode je≈õli prze≈ÇƒÖczamy na modern (to motyw ciemny)
            if (themeName === 'modern' && document.body.classList.contains('dark-mode')) {
                document.body.classList.remove('dark-mode');
                safeSetItem('darkMode', 'false');
                const icon = document.getElementById('dark-mode-icon');
                if (icon) icon.textContent = 'üåô';
            }

            // Usu≈Ñ wszystkie atrybuty data-theme
            document.documentElement.removeAttribute('data-theme');

            // Ustaw nowy temat (opcjonalnie - dla modern i minimal)
            if (themeName !== 'classic') {
                document.documentElement.setAttribute('data-theme', themeName);
            }

            // Zapisz preferencjƒô globalnƒÖ
            safeSetItem('quizTheme', themeName);

            // Zapisz motyw do profilu u≈ºytkownika (je≈õli zalogowany)
            if (currentUser && users[currentUser]) {
                users[currentUser].theme = themeName;
                safeSetItem('quizUsers', JSON.stringify(users));
            }

            // Aktualizuj selektory
            const select = document.getElementById('themeSelect');
            if (select) {
                select.value = themeName;
            }

            const loginSelect = document.getElementById('loginThemeSelect');
            if (loginSelect) {
                loginSelect.value = themeName;
            }

            // Poka≈º powiadomienie (tylko je≈õli nie quiet)
            if (!quiet) {
                const themeNames = {
                    'classic': 'Klasyczny',
                    'modern': 'NEON Cyberpunk',
                    'minimal': 'Minimalistyczny'
                };
                showToast(`Motyw "${themeNames[themeName]}" zosta≈Ç ustawiony.`, 'success', 2000);
            }
        }

        function loadSavedTheme() {
            let savedTheme = null;

            // Najpierw spr√≥buj pobraƒá motyw u≈ºytkownika (je≈õli zalogowany)
            if (currentUser && users[currentUser] && users[currentUser].theme) {
                savedTheme = users[currentUser].theme;
            }

            // Je≈õli nie ma motywu u≈ºytkownika, pobierz globalny
            if (!savedTheme) {
                savedTheme = safeGetItem('quizTheme');
            }

            // Je≈õli nadal nie ma, u≈ºyj domy≈õlnego
            if (!savedTheme) {
                savedTheme = 'classic';
            }

            setTheme(savedTheme, true); // quiet = true, bez toast
        }

        // ========== TIMER FUNCTIONS ==========
        window.toggleTimerInput = function () {
            const checkbox = document.getElementById('enableTimer');
            const container = document.getElementById('timerInputContainer');
            if (checkbox.checked) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        };

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timerCountdown');
            const timerContainer = document.getElementById('testTimerDisplay');

            if (!display || !timerContainer) return;

            display.textContent = formatTime(testTimeLeft);

            // Update styles based on time left
            timerContainer.classList.remove('timer-warning', 'timer-critical');
            if (testTimeLeft <= 60) {
                timerContainer.classList.add('timer-critical');
            } else if (testTimeLeft <= 300) { // 5 minutes
                timerContainer.classList.add('timer-warning');
            }
        }

        function startTestTimer(minutes) {
            testTimeLeft = minutes * 60;
            isTimerRunning = true;

            const timerContainer = document.getElementById('testTimerDisplay');
            timerContainer.classList.remove('hidden');

            updateTimerDisplay();

            testTimerInterval = setInterval(() => {
                testTimeLeft--;
                updateTimerDisplay();

                if (testTimeLeft <= 0) {
                    stopTestTimer();
                    showToast('‚è±Ô∏è Czas minƒÖ≈Ç! Test zostanie automatycznie zako≈Ñczony.', 'warning', 5000);
                    finishTest();
                }
            }, 1000);
        }

        function stopTestTimer() {
            if (testTimerInterval) {
                clearInterval(testTimerInterval);
                testTimerInterval = null;
            }
            isTimerRunning = false;
        }

        // ========== LOADING SPINNER ==========
        function showLoading(text = "≈Åadowanie...") {
            const overlay = document.getElementById("loadingOverlay");
            const textElement = document.getElementById("loadingText");
            if (textElement) textElement.textContent = text;
            if (overlay) overlay.classList.add("visible");
        }

        function hideLoading() {
            const overlay = document.getElementById("loadingOverlay");
            if (overlay) overlay.classList.remove("visible");
        }

        // ========== WALIDACJA W CZASIE RZECZYWISTYM ==========
        function validateUsername() {
            const username = document.getElementById("regUsername").value.trim();
            const validation = document.getElementById("usernameValidation");

            if (!username) {
                validation.innerHTML = "";
                return;
            }

            if (users[username]) {
                validation.innerHTML = `<span class="validation-error">‚úó Nazwa u≈ºytkownika zajƒôta</span>`;
            } else if (username.length < 3) {
                validation.innerHTML = `<span class="validation-error">‚úó Minimum 3 znaki</span>`;
            } else if (username.length > 20) {
                validation.innerHTML = `<span class="validation-error">‚úó Maksimum 20 znak√≥w</span>`;
            } else {
                validation.innerHTML = `<span class="validation-success">‚úì Nazwa dostƒôpna</span>`;
            }
        }

        // ========== SANITYZACJA DANYCH (XSS PROTECTION) ==========
        function escapeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ========== TOAST NOTIFICATIONS ==========
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            // Utw√≥rz element toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            // Ikona zale≈ºna od typu
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };

            toast.innerHTML = `
                <div class="toast-message">
                    <span style="margin-right: 8px;">${icons[type] || icons.info}</span>
                    <span>${escapeHTML(message)}</span>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            // Dodaj do kontenera
            container.appendChild(toast);

            // Automatyczne usuwanie po okre≈õlonym czasie
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, duration);
        }

        // ========== HASHOWANIE HASE≈Å ==========
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function verifyPassword(password, hash) {
            const passwordHash = await hashPassword(password);
            return passwordHash === hash;
        }

        // Funkcja do zamiany link√≥w tekstowych na klikalne (bezpieczna wersja)
        function makeLinksClickable(text) {
            if (!text) return '';
            // Najpierw escapujemy ca≈Çy tekst
            const escapedText = escapeHTML(text);
            // Potem szukamy URL-i i zamieniamy je na linki (bezpiecznie)
            const urlRegex = /(https?:\/\/[^\s<>]+|www\.[^\s<>]+)/g;
            return escapedText.replace(urlRegex, function (url) {
                let href = url;
                if (url.startsWith('www.')) {
                    href = 'https://' + url;
                }
                // Dodatkowe zabezpieczenie - tylko http/https
                if (!href.startsWith('http://') && !href.startsWith('https://')) {
                    return url; // Zwr√≥ƒá orygina≈Ç je≈õli nie jest http/https
                }
                return `<a href="${escapeHTML(href)}" target="_blank" rel="noopener noreferrer">${escapeHTML(url)}</a>`;
            });
        }

        // ========== ENHANCED EXPLANATIONS ==========
        function findRelatedQuestions(currentQuestion, maxQuestions = 3) {
            if (!currentQuestion) return [];

            let related = [];
            const currentId = currentQuestion.id;
            const currentCategory = currentQuestion.category || '';
            const currentTags = currentQuestion.tags || [];

            // Find questions with same category or tags
            related = questions.filter(q => {
                if (q.id === currentId) return false;

                // Same category
                if (q.category === currentCategory && currentCategory) return true;

                // Same tags (at least one matching)
                if (currentTags.length > 0 && q.tags && q.tags.length > 0) {
                    return q.tags.some(tag => currentTags.includes(tag));
                }

                return false;
            });

            // Sort by relevance (same category > shared tags)
            related.sort((a, b) => {
                const aScore = (a.category === currentCategory ? 2 : 0) +
                    (a.tags ? a.tags.filter(t => currentTags.includes(t)).length : 0);
                const bScore = (b.category === currentCategory ? 2 : 0) +
                    (b.tags ? b.tags.filter(t => currentTags.includes(t)).length : 0);
                return bScore - aScore;
            });

            return related.slice(0, maxQuestions);
        }

        function generateRelatedQuestionsHTML(currentQuestion) {
            const related = findRelatedQuestions(currentQuestion, 3);
            if (related.length === 0) return '';

            let html = `
                <div class="related-questions" style="margin-top: 20px; padding: 16px; background: var(--bg-warm); border-radius: var(--border-radius); border-left: 4px solid var(--info-color);">
                    <h4 style="margin-bottom: 12px; color: var(--text-primary);">üîó PowiƒÖzane pytania:</h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
            `;

            related.forEach((q, i) => {
                html += `
                    <li style="padding: 8px 0; ${i < related.length - 1 ? 'border-bottom: 1px solid var(--border-color);' : ''}">
                        <div style="font-size: var(--text-sm); color: var(--text-primary);">
                            <strong>Q${i + 1}:</strong> ${escapeHTML((q.text || '').substring(0, 100))}${(q.text || '').length > 100 ? '...' : ''}
                        </div>
                        ${q.category ? `<span style="font-size: var(--text-xs); color: var(--text-light);">üìÅ ${escapeHTML(q.category)}</span>` : ''}
                    </li>
                `;
            });

            html += `
                    </ul>
                    <div style="margin-top: 12px; font-size: var(--text-xs); color: var(--text-light);">
                        üí° Przejrzyj powiƒÖzane pytania, aby lepiej zrozumieƒá ten temat
                    </div>
                </div>
            `;

            return html;
        }

        // ========== WALIDACJA DANYCH ==========
        function isValidQuestion(q) {
            if (!q || typeof q !== 'object') return false;
            if (!q.text || typeof q.text !== 'string') return false;
            if (!Array.isArray(q.options) || q.options.length < 2) return false;
            if (!Array.isArray(q.correct)) return false;
            if (!q.id) q.id = Date.now() + Math.random();
            if (!q.type) q.type = 'single';
            if (q.imageData && typeof q.imageData === 'string' && !q.imageData.startsWith('data:')) {
                delete q.imageData;
            }
            return true;
        }

        function cleanQuestionsData() {
            const rawQuestions = JSON.parse(safeGetItem("quizQuestions", "[]")) || [];
            questions = rawQuestions.map(q => {
                if (q.imageData && typeof q.imageData === 'string' && !q.imageData.startsWith('data:')) {
                    console.warn('Usuwam nieprawid≈Çowe imageData z pytania:', q.id);
                    delete q.imageData;
                }
                return q;
            }).filter(isValidQuestion);
            if (questions.length !== rawQuestions.length) {
                console.log("Usuniƒôto " + (rawQuestions.length - questions.length) + " uszkodzonych pyta≈Ñ");
                safeSetItem("quizQuestions", JSON.stringify(questions));
            }
        }

        // ========== SAFE LOCALSTORAGE - Error handling ==========
        function safeSetItem(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    showToast("‚ùå Brak miejsca w pamiƒôci! Usu≈Ñ stare pytania lub wyczy≈õƒá dane przeglƒÖdarki.", "error");
                } else {
                    console.error("B≈ÇƒÖd zapisu localStorage:", error);
                    showToast("‚ùå B≈ÇƒÖd zapisu danych: " + error.message, "error");
                }
                return false;
            }
        }

        function safeGetItem(key, defaultValue = null) {
            try {
                const value = localStorage.getItem(key);
                return value !== null ? value : defaultValue;
            } catch (error) {
                console.error("B≈ÇƒÖd odczytu localStorage:", error);
                return defaultValue;
            }
        }

        function safeRemoveItem(key) {
            try {
                localStorage.removeItem(key);
                return true;
            } catch (error) {
                console.error("B≈ÇƒÖd usuwania localStorage:", error);
                return false;
            }
        }

        // ========== KATEGORIE I TAGI ==========
        function getAllCategories() {
            const categories = new Set();
            questions.forEach(q => {
                if (q.category && q.category.trim()) {
                    categories.add(q.category.trim());
                }
            });
            return Array.from(categories).sort();
        }

        function updateCategorySelects() {
            const categories = getAllCategories();
            const testSelect = document.getElementById("testCategory");
            const practiceSelect = document.getElementById("practiceCategory");
            const categoryDatalist = document.getElementById("existingCategories");

            // Aktualizuj select w trybie testu
            if (testSelect) {
                const currentValue = testSelect.value;
                testSelect.innerHTML = '<option value="all">Wszystkie kategorie</option>';
                categories.forEach(cat => {
                    const option = document.createElement("option");
                    option.value = cat;
                    option.textContent = cat;
                    testSelect.appendChild(option);
                });
                testSelect.value = currentValue;
            }

            // Aktualizuj select w trybie nauki
            if (practiceSelect) {
                const currentValue = practiceSelect.value;
                practiceSelect.innerHTML = '<option value="all">Wszystkie kategorie</option>';
                categories.forEach(cat => {
                    const option = document.createElement("option");
                    option.value = cat;
                    option.textContent = cat;
                    practiceSelect.appendChild(option);
                });
                practiceSelect.value = currentValue;
            }

            // Aktualizuj datalist w formularzu pytania
            if (categoryDatalist) {
                categoryDatalist.innerHTML = '';
                categories.forEach(cat => {
                    const option = document.createElement("option");
                    option.value = cat;
                    categoryDatalist.appendChild(option);
                });
            }

            // Aktualizuj select w eksporcie
            const exportSelect = document.getElementById("exportCategorySelect");
            if (exportSelect) {
                const currentValue = exportSelect.value;
                exportSelect.innerHTML = '<option value="all">Wszystkie kategorie</option>';
                categories.forEach(cat => {
                    const option = document.createElement("option");
                    option.value = cat;
                    option.textContent = cat;
                    exportSelect.appendChild(option);
                });
                exportSelect.value = currentValue && categories.includes(currentValue) ? currentValue : "all";
            }

            // Aktualizuj select w imporcie
            const importSelect = document.getElementById("importCategorySelect");
            if (importSelect) {
                const currentValue = importSelect.value;
                const keepOption = importSelect.querySelector('option[value="keep"]');
                const newOption = importSelect.querySelector('option[value="new"]');
                importSelect.innerHTML = '<option value="">-- Wybierz kategoriƒô --</option>';
                if (keepOption) importSelect.appendChild(keepOption);
                if (newOption) importSelect.appendChild(newOption);
                else {
                    const newOpt = document.createElement("option");
                    newOpt.value = "new";
                    newOpt.textContent = "--- Utw√≥rz nowƒÖ kategoriƒô ---";
                    importSelect.appendChild(newOpt);
                }
                categories.forEach(cat => {
                    const option = document.createElement("option");
                    option.value = cat;
                    option.textContent = cat;
                    importSelect.appendChild(option);
                });
                if (currentValue && currentValue !== "keep" && currentValue !== "new") {
                    importSelect.value = categories.includes(currentValue) ? currentValue : "";
                }
            }

            // Aktualizuj select w eksporcie JSON
            const exportSelectJSON = document.getElementById("exportCategorySelectJSON");
            if (exportSelectJSON) {
                const currentValue = exportSelectJSON.value;
                exportSelectJSON.innerHTML = '<option value="all">Wszystkie kategorie</option>';
                categories.forEach(cat => {
                    const option = document.createElement("option");
                    option.value = cat;
                    option.textContent = cat;
                    exportSelectJSON.appendChild(option);
                });
                exportSelectJSON.value = currentValue && categories.includes(currentValue) ? currentValue : "all";
            }

            // Aktualizuj select we Fiszkach
            const flashcardCatSelect = document.getElementById("flashcardCategory");
            if (flashcardCatSelect) {
                const currentValue = flashcardCatSelect.value;
                flashcardCatSelect.innerHTML = '<option value="all">Wszystkie kategorie</option>';
                categories.forEach(cat => {
                    const option = document.createElement("option");
                    option.value = cat;
                    option.textContent = cat;
                    flashcardCatSelect.appendChild(option);
                });
                flashcardCatSelect.value = currentValue && categories.includes(currentValue) ? currentValue : "all";
            }

            // NOWE: Aktualizuj select w filtrze pyta≈Ñ
            const filterCatSelect = document.getElementById("filterCategory");
            if (filterCatSelect) {
                const currentValue = filterCatSelect.value;
                filterCatSelect.innerHTML = '<option value="all">Wszystkie kategorie</option>';
                categories.forEach(cat => {
                    const option = document.createElement("option");
                    option.value = cat;
                    option.textContent = cat;
                    filterCatSelect.appendChild(option);
                });
                filterCatSelect.value = currentValue && categories.includes(currentValue) ? currentValue : "all";
            }

            // NOWE: Aktualizuj select tag√≥w w filtrze pyta≈Ñ
            updateFilterTagSelect();
        }

        function renderTags() {
            const container = document.getElementById("tagsList");
            container.innerHTML = "";

            currentTags.forEach((tag, index) => {
                const tagEl = document.createElement("div");
                tagEl.className = "tag-item";
                tagEl.innerHTML = `
                    <span>${tag}</span>
                    <span class="tag-remove" onclick="window.removeTag(${index})">&times;</span>
                `;
                container.appendChild(tagEl);
            });
        }

        function addTag(tag) {
            tag = tag.trim();
            if (tag && !currentTags.includes(tag)) {
                currentTags.push(tag);
                renderTags();
            }
            document.getElementById("tagInput").value = "";
        }

        function removeTag(index) {
            currentTags.splice(index, 1);
            renderTags();
        }

        // ========== NOWE: WYSZUKIWARKA I FILTRPY ==========
        function getAllTags() {
            const tags = new Set();
            questions.forEach(q => {
                if (q.tags && Array.isArray(q.tags)) {
                    q.tags.forEach(tag => {
                        if (tag && tag.trim()) {
                            tags.add(tag.trim());
                        }
                    });
                }
            });
            return Array.from(tags).sort();
        }

        function updateFilterTagSelect() {
            const filterTagSelect = document.getElementById("filterTag");
            if (!filterTagSelect) return;

            const tags = getAllTags();
            const currentValue = filterTagSelect.value;

            filterTagSelect.innerHTML = '<option value="all">Wszystkie tagi</option>';
            tags.forEach(tag => {
                const option = document.createElement("option");
                option.value = tag;
                option.textContent = tag;
                filterTagSelect.appendChild(option);
            });

            filterTagSelect.value = currentValue && tags.includes(currentValue) ? currentValue : "all";
        }

        function filterQuestions() {
            const searchText = document.getElementById("searchQuestions").value.toLowerCase();
            const categoryFilter = document.getElementById("filterCategory").value;
            const tagFilter = document.getElementById("filterTag").value;
            const typeFilter = document.getElementById("filterType").value;
            const markedFilter = document.getElementById("filterMarkedForReview").checked;
            const resultsSpan = document.getElementById("filterResults");

            // Filtrowanie pyta≈Ñ
            const filtered = questions.filter(q => {
                // Search text - szukaj w tre≈õci, wyja≈õnieniu i odpowiedziach
                let matchesSearch = true;
                if (searchText) {
                    const text = (q.text || '').toLowerCase();
                    const explanation = (q.explanation || '').toLowerCase();
                    const options = (q.options || []).map(o => o.toLowerCase()).join(' ');

                    matchesSearch = text.includes(searchText) ||
                        explanation.includes(searchText) ||
                        options.includes(searchText);
                }

                // Category filter
                const matchesCategory = categoryFilter === 'all' || (q.category || '') === categoryFilter;

                // Tag filter
                let matchesTag = true;
                if (tagFilter !== 'all') {
                    matchesTag = q.tags && q.tags.includes(tagFilter);
                }

                // Type filter
                const matchesType = typeFilter === 'all' || (q.type || 'single') === typeFilter;

                // Marked for review filter
                const matchesMarked = !markedFilter || q.markedForReview;

                return matchesSearch && matchesCategory && matchesTag && matchesType && matchesMarked;
            });

            // Store filtered questions for pagination
            filteredQuestionsForPagination = filtered;

            // Reset to first page when filtering
            questionsCurrentPage = 1;

            // Show results count
            if (filtered.length === 0) {
                resultsSpan.textContent = `0 z ${questions.length} pyta≈Ñ`;
            } else {
                resultsSpan.textContent = `Znaleziono: ${filtered.length} z ${questions.length} pyta≈Ñ`;
            }

            // Render with pagination
            renderQuestions();
        }

        function renderFilteredQuestions(filteredList) {
            // This function is now replaced by filterQuestions() + renderQuestions()
            // Kept for backward compatibility, but delegates to filterQuestions
            filteredQuestionsForPagination = filteredList;
            questionsCurrentPage = 1;
            renderQuestions();
        }

        function clearFilters() {
            document.getElementById("searchQuestions").value = "";
            document.getElementById("filterCategory").value = "all";
            document.getElementById("filterTag").value = "all";
            document.getElementById("filterType").value = "all";
            document.getElementById("filterMarkedForReview").checked = false;
            document.getElementById("filterResults").textContent = "";

            // Clear filtered questions and reset pagination
            filteredQuestionsForPagination = [];
            questionsCurrentPage = 1;

            // Przywr√≥ƒá wszystkie pytania
            renderQuestions();
        }

        // NOWE: Funkcja do zwijania/rozwijania sekcji
        function toggleSection(contentId, iconId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);

            if (!content || !icon) return;

            // Toggle visibility
            if (content.classList.contains("hidden")) {
                // Otw√≥rz
                content.classList.remove("hidden");
                icon.textContent = "‚ñ≤";  // Strza≈Çka w g√≥rƒô = otwarte
            } else {
                // Zamknij
                content.classList.add("hidden");
                icon.textContent = "‚ñº";  // Strza≈Çka w d√≥≈Ç = zamkniƒôte
            }
        }

        // ========== DARK MODE ==========
        function toggleDarkMode() {
            // Sprawd≈∫ czy motyw modern jest aktywny
            const isModernTheme = document.documentElement.getAttribute('data-theme') === 'modern';

            // Nie pozw√≥l na dark mode gdy motyw modern (jest ju≈º ciemny)
            if (isModernTheme && !document.body.classList.contains('dark-mode')) {
                showToast('Motyw NEON Cyberpunk jest ju≈º ciemny - dark mode nie jest potrzebny.', 'info', 3000);
                return;
            }

            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            const icon = document.getElementById('dark-mode-icon');

            // Zmie≈Ñ ikonƒô
            icon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';

            // Zapisz globalnƒÖ preferencjƒô
            safeSetItem('darkMode', isDark ? 'true' : 'false');

            // DYNAMICZNIE ZMIE≈É INLINE STYLES
            applyDarkModeToInlineStyles(isDark);
        }

        function applyDarkModeToInlineStyles(isDark) {
            // Znajd≈∫ WSZYSTKIE elementy z inline style
            const allElements = document.querySelectorAll('*');
            let changedCount = 0;

            allElements.forEach(el => {
                const computedStyle = window.getComputedStyle(el);
                const inlineStyle = el.getAttribute('style') || '';

                // Sprawd≈∫ czy element ma jasne t≈Ço (inline lub przez CSS)
                const bgColor = computedStyle.backgroundColor;

                // Zapisz original style tylko raz
                if (!el.dataset.originalStyle) {
                    el.dataset.originalStyle = inlineStyle;
                }

                if (isDark) {
                    // Sprawd≈∫ computed background color i zmie≈Ñ je≈õli jest jasna
                    const rgb = bgColor.match(/\d+/g);
                    if (rgb) {
                        const r = parseInt(rgb[0]);
                        const g = parseInt(rgb[1]);
                        const b = parseInt(rgb[2]);
                        const brightness = (r * 299 + g * 587 + b * 114) / 1000;

                        // Jasne t≈Ço (>128) -> zmie≈Ñ na ciemne
                        if (brightness > 128) {
                            el.style.setProperty('background-color', '#21262d', 'important');
                            el.style.setProperty('background', '#21262d', 'important');
                            changedCount++;
                        }
                    }

                    // Sprawd≈∫ computed color i zmie≈Ñ je≈õli jest ciemna (czarna)
                    const textColor = computedStyle.color;
                    const textRgb = textColor.match(/\d+/g);
                    if (textRgb) {
                        const tr = parseInt(textRgb[0]);
                        const tg = parseInt(textRgb[1]);
                        const tb = parseInt(textRgb[2]);

                        // Ciemny tekst (<100) -> zmie≈Ñ na jasny
                        if (tr < 100 && tg < 100 && tb < 100) {
                            el.style.setProperty('color', '#c9d1d9', 'important');
                            changedCount++;
                        }
                    }

                    // Dodatkowo: bezpo≈õrednia modyfikacja inline style attribute
                    let newStyle = inlineStyle;
                    newStyle = newStyle.replace(/background:\s*white/gi, 'background: #21262d');
                    newStyle = newStyle.replace(/background:\s*#fff/gi, 'background: #21262d');
                    newStyle = newStyle.replace(/background:\s*#f8f9fa/gi, 'background: #21262d');
                    newStyle = newStyle.replace(/background:\s*#e9ecef/gi, 'background: #21262d');
                    newStyle = newStyle.replace(/background:\s*#e7f3ff/gi, 'background: #161b22');
                    newStyle = newStyle.replace(/background:\s*#fff3cd/gi, 'background: #21262d');
                    newStyle = newStyle.replace(/background:\s*#d4edda/gi, 'background: #161b22');
                    newStyle = newStyle.replace(/color:\s*#000/gi, 'color: #c9d1d9');
                    newStyle = newStyle.replace(/color:\s*#333/gi, 'color: #c9d1d9');
                    newStyle = newStyle.replace(/color:\s*black/gi, 'color: #c9d1d9');

                    if (newStyle !== inlineStyle) {
                        el.setAttribute('style', newStyle);
                        changedCount++;
                    }
                } else {
                    // Przywr√≥ƒá original style
                    if (el.dataset.originalStyle) {
                        el.setAttribute('style', el.dataset.originalStyle);
                    }
                    // Wyczy≈õƒá computed style overrides
                    el.style.removeProperty('background-color');
                    el.style.removeProperty('background');
                    el.style.removeProperty('color');
                }
            });

            console.log(`Dark mode: zmieniono ${changedCount} element√≥w`);
        }

        // MutationObserver - monitoruj nowe elementy DOM
        function setupDarkModeObserver() {
            const isDark = document.body.classList.contains('dark-mode');

            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) { // Element node
                            // Zastosuj dark mode do nowych element√≥w
                            if (node.getAttribute && node.getAttribute('style')) {
                                applyDarkModeToInlineStyles(isDark);
                            }
                            // Sprawd≈∫ dzieci
                            const children = node.querySelectorAll ? node.querySelectorAll('*') : [];
                            if (children.length > 0) {
                                applyDarkModeToInlineStyles(isDark);
                            }
                        }
                    });
                });
            });

            // Obserwuj ca≈Çy body
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });

            console.log('Dark mode observer uruchomiony');
        }

        function initDarkMode() {
            // Za≈Çaduj globalnƒÖ preferencjƒô
            const savedMode = safeGetItem('darkMode', 'false');
            const isDark = savedMode === 'true';

            if (isDark) {
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-icon').textContent = '‚òÄÔ∏è';
            } else {
                document.getElementById('dark-mode-icon').textContent = 'üåô';
            }

            // Zastosuj inline styles po za≈Çadowaniu DOM
            setTimeout(() => {
                applyDarkModeToInlineStyles(isDark);
                setupDarkModeObserver();  // Uruchom observer
            }, 200);
        }

        // Obs≈Çuga Enter w polu tag√≥w i inicjalizacja WYSIWYG
        document.addEventListener("DOMContentLoaded", function () {
            // Zawsze za≈Çadz motyw (nawet na ekranie logowania)
            loadSavedTheme();

            // Inicjalizuj dark mode zawsze (dla wszystkich u≈ºytkownik√≥w)
            initDarkMode();

            const tagInput = document.getElementById("tagInput");
            if (tagInput) {
                tagInput.addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        addTag(this.value);
                    }
                });
            }

            // Inicjalizacja WYSIWYG edytor√≥w
            initWYSIWYG('questionToolbar', 'questionEditor', 'questionText');
            initWYSIWYG('explanationToolbar', 'explanationEditor', 'explanation');

            // Obs≈Çuga zmiany trybu fiszek
            const flashcardModeSelect = document.getElementById("flashcardMode");
            if (flashcardModeSelect) {
                flashcardModeSelect.addEventListener("change", function () {
                    const difficultInfo = document.getElementById("flashcardDifficultInfo");
                    const difficultCountSpan = document.getElementById("difficultCount");
                    const markedInfo = document.getElementById("flashcardMarkedInfo");
                    const markedCountSpan = document.getElementById("markedCount");

                    // Ukryj wszystkie info-boxy
                    difficultInfo.classList.add("hidden");
                    markedInfo.classList.add("hidden");

                    if (this.value === "difficult") {
                        // Zlicz pytania oznaczone jako trudne
                        const difficultQuestions = questions.filter(q => {
                            const userFlashcardData = users[currentUser]?.flashcardData || {};
                            const qData = userFlashcardData[q.id];
                            return qData && qData.difficult === true;
                        });
                        difficultCountSpan.textContent = difficultQuestions.length;
                        difficultInfo.classList.remove("hidden");
                    } else if (this.value === "markedForReview") {
                        // Zlicz pytania oznaczone do powt√≥rki
                        const markedQuestions = questions.filter(q => q.markedForReview === true);
                        markedCountSpan.textContent = markedQuestions.length;
                        markedInfo.classList.remove("hidden");
                    } else if (this.value === "srs") {
                        // Zlicz pytania due for review (SRS)
                        const dueQuestions = questions.filter(q => isQuestionDueForReview(q.id));
                        showToast(`üß† ${dueQuestions.length} fiszek do powt√≥rki dzisiaj!`, "info", 3000);
                    }
                });
            }

            // ========== AUTENTYFIKACJA - event listenery ==========
            document.getElementById("registerForm").addEventListener("submit", async function (e) {
                e.preventDefault();
                const username = document.getElementById("regUsername").value.trim();
                const password = document.getElementById("regPassword").value;

                if (users[username]) {
                    showToast("U≈ºytkownik ju≈º istnieje!", "error");
                    return;
                }

                const passwordHash = await hashPassword(password);
                const isAdmin = username === "admin" || username === "administrator";

                users[username] = {
                    passwordHash: passwordHash,
                    isAdmin: isAdmin,
                    canEditQuestions: true,  // Domy≈õlnie wszyscy mogƒÖ edytowaƒá (kompatybilno≈õƒá)
                    isBlocked: false,
                    registeredAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    testResults: []
                };

                safeSetItem("quizUsers", JSON.stringify(users));
                showToast(isAdmin ? "Rejestracja zako≈Ñczona! Utworzono konto administratora." : "Rejestracja zako≈Ñczona! Mo≈ºesz siƒô zalogowaƒá.", "success");
                showLoginForm();
            });

            document.getElementById("loginForm").addEventListener("submit", async function (e) {
                e.preventDefault();
                showLoading("Logowanie...");
                const username = document.getElementById("loginUsername").value.trim();
                const password = document.getElementById("loginPassword").value;

                if (!users[username]) {
                    hideLoading();
                    showToast("Nieprawid≈Çowe dane logowania!", "error");
                    return;
                }

                // Migracja starych hase≈Ç (je≈õli has≈Ço jest w jawnym tek≈õcie)
                let user = users[username];
                if (user.password && !user.passwordHash) {
                    // Stare has≈Ço w jawnym tek≈õcie - migracja
                    if (user.password === password) {
                        user.passwordHash = await hashPassword(password);
                        delete user.password;
                        users[username] = user;
                        safeSetItem("quizUsers", JSON.stringify(users));
                    } else {
                        hideLoading();
                        showToast("Nieprawid≈Çowe dane logowania!", "error");
                        return;
                    }
                }

                // Sprawdzenie czy konto jest zablokowane
                if (user.isBlocked) {
                    hideLoading();
                    showToast("To konto zosta≈Ço zablokowane. Skontaktuj siƒô z administratorem.", "error");
                    return;
                }

                // Weryfikacja has≈Ça
                const isValid = await verifyPassword(password, user.passwordHash);
                if (!isValid) {
                    hideLoading();
                    showToast("Nieprawid≈Çowe dane logowania!", "error");
                    return;
                }

                // MIGRACJA DANYCH U≈ªYTKOWNIKA (przy ka≈ºdym logowaniu dla pewno≈õci)
                if (user.isAdmin === undefined) {
                    user.isAdmin = (username === "admin" || username === "administrator");
                    safeSetItem("quizUsers", JSON.stringify(users));
                    console.log("Migracja isAdmin dla u≈ºytkownika:", username, user.isAdmin);
                }

                currentUser = username;
                users[currentUser].lastLogin = new Date().toISOString();
                safeSetItem("quizUsers", JSON.stringify(users));

                // Zapisz zalogowanego u≈ºytkownika do localStorage (dla przywracania sesji)
                safeSetItem("currentUser", currentUser);

                document.body.classList.add('logged-in');
                document.getElementById("auth-section").classList.add("hidden");
                document.getElementById("app-section").classList.remove("hidden");
                document.getElementById("currentUser").textContent = currentUser;

                cleanQuestionsData();

                // Poka≈º przyciski panelu administratora tylko dla administrator√≥w
                if (users[currentUser].isAdmin) {
                    document.body.classList.add("is-admin");
                } else {
                    document.body.classList.remove("is-admin");
                }

                hideLoading();
                showSection("dashboard");
            });
        });

        // ========== AUTENTYFIKACJA - funkcje globalne ==========
        function logout() {
            currentUser = null;
            document.body.classList.remove('logged-in');

            // Usu≈Ñ zalogowanego u≈ºytkownika z localStorage
            safeSetItem('currentUser', '');

            // Usu≈Ñ klasƒô admina z body
            document.body.classList.remove("is-admin");

            document.getElementById("app-section").classList.add("hidden");
            document.getElementById("auth-section").classList.remove("hidden");
            document.getElementById("loginUsername").value = "";
            document.getElementById("loginPassword").value = "";
        }

        // ========== FISZKI - FLASHCARDS ==========
        let flashcards = [];
        let currentFlashcardIndex = 0;
        let flashcardStats = { know: 0, dontKnow: 0 };
        let isFlashcardFlipped = false;
        let currentFlashcardMode = null; // Track if we're in SRS mode

        function startFlashcards() {
            // Ukryj bottom nav na mobile podczas fiszek
            document.body.classList.add('in-flashcards');

            const category = document.getElementById("flashcardCategory").value;
            const mode = document.getElementById("flashcardMode").value;
            const count = document.getElementById("flashcardCount").value;

            // Filtrowanie pyta≈Ñ
            let filteredQuestions = [...questions];
            if (category !== "all") {
                filteredQuestions = filteredQuestions.filter(q => (q.category || "") === category);
            }

            // Tryb "markedForReview" - tylko pytania oznaczone do powt√≥rki
            if (mode === "markedForReview") {
                filteredQuestions = filteredQuestions.filter(q => q.markedForReview);

                if (filteredQuestions.length === 0) {
                    showToast("Nie masz jeszcze pyta≈Ñ oznaczonych do powt√≥rki! Oznacz trudne pytania w szczeg√≥≈Çach wynik√≥w.", "info");
                    return;
                }
            } else if (mode === "srs") {
                // Spaced Repetition - tylko pytania due for review
                filteredQuestions = filteredQuestions.filter(q => isQuestionDueForReview(q.id));

                // Sortuj po nextReviewDate
                filteredQuestions.sort((a, b) => {
                    const aData = getQuestionSRSData(a.id);
                    const bData = getQuestionSRSData(b.id);
                    const aDate = aData?.nextReview ? new Date(aData.nextReview).getTime() : 0;
                    const bDate = bData?.nextReview ? new Date(bData.nextReview).getTime() : 0;
                    return aDate - bDate;
                });

                if (filteredQuestions.length === 0) {
                    showToast("Brak fiszek do powt√≥rki! Wszystkie sƒÖ od≈Ço≈ºone na przysz≈Ço≈õƒá. üéâ", "success", 3000);
                    return;
                }

                if (count !== "all") {
                    filteredQuestions = filteredQuestions.slice(0, parseInt(count));
                }
            } else {
                // Priorytetowe pokazywanie oznaczonych do powt√≥rki
                const markedQuestions = filteredQuestions.filter(q => q.markedForReview);
                const otherQuestions = filteredQuestions.filter(q => !q.markedForReview);

                if (count !== "all") {
                    const countNum = parseInt(count);
                    // Je≈õli oznaczonych jest mniej ni≈º limit, dope≈Çnij resztƒÖ
                    if (markedQuestions.length >= countNum) {
                        filteredQuestions = markedQuestions.slice(0, countNum);
                    } else {
                        filteredQuestions = [...markedQuestions];
                        const remaining = countNum - markedQuestions.length;
                        // Losuj z pozosta≈Çych
                        const shuffledOthers = [...otherQuestions].sort(() => Math.random() - 0.5);
                        // Tasowanie (Fisher-Yates)
                        for (let i = shuffledOthers.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [shuffledOthers[i], shuffledOthers[j]] = [shuffledOthers[j], shuffledOthers[i]];
                        }
                        filteredQuestions = [...filteredQuestions, ...shuffledOthers.slice(0, remaining)];
                    }
                } else {
                    // Wszystkie pytania - oznaczone na poczƒÖtku
                    filteredQuestions = [...markedQuestions, ...otherQuestions];
                }
            }

            if (filteredQuestions.length === 0) {
                showToast("Brak pyta≈Ñ do wy≈õwietlenia!", "warning");
                return;
            }

            // Inicjalizacja sesji
            flashcards = filteredQuestions;
            currentFlashcardIndex = 0;
            flashcardStats = { know: 0, dontKnow: 0 };
            isFlashcardFlipped = false;
            currentFlashcardMode = mode; // Store current mode

            // Poka≈º interfejs fiszek
            document.getElementById("flashcard-setup").classList.add("hidden");
            document.getElementById("flashcard-active").classList.remove("hidden");
            document.getElementById("flashcard-complete").classList.add("hidden");

            // Poka≈º pierwszƒÖ fiszkƒô
            showFlashcard();
        }

        function showFlashcard() {
            if (currentFlashcardIndex >= flashcards.length) {
                // Koniec sesji
                showFlashcardComplete();
                return;
            }

            const q = flashcards[currentFlashcardIndex];
            isFlashcardFlipped = false;

            // Reset karty
            const flashcard = document.getElementById("flashcard");
            flashcard.classList.remove("flipped");

            // Aktualizuj UI
            document.getElementById("flashcard-current").textContent = currentFlashcardIndex + 1;
            document.getElementById("flashcard-total").textContent = flashcards.length;
            document.getElementById("flashcard-percent").textContent = Math.round((currentFlashcardIndex / flashcards.length) * 100) + "%";
            document.getElementById("flashcard-progress-fill").style.width = (currentFlashcardIndex / flashcards.length * 100) + "%";
            document.getElementById("flashcard-know").textContent = flashcardStats.know;
            document.getElementById("flashcard-dontknow").textContent = flashcardStats.dontKnow;

            // Pytanie (prz√≥d karty)
            document.getElementById("flashcard-question").innerHTML = sanitizeHTML(q.text);

            // Pytanie (ty≈Ç karty)
            document.getElementById("flashcard-answer-question").innerHTML = sanitizeHTML(q.text);

            // Opcje odpowiedzi
            const optionsHTML = (q.options || []).map((opt, i) => {
                const isCorrect = (q.correct || []).includes(i + 1);
                const optionClass = isCorrect ? "flashcard-option correct" : "flashcard-option";
                return `
                    <div class="${optionClass}">
                        <div class="option-number">${i + 1}</div>
                        <div>${escapeHTML(opt)}</div>
                    </div>
                `;
            }).join("");
            document.getElementById("flashcard-options").innerHTML = optionsHTML;

            // Ukryj przyciski oceny
            document.getElementById("flashcard-rating").style.display = "none";

            // Setup touch gestures for flashcard
            setupFlashcardTouchGestures();
        }

        // ========== TOUCH GESTURES FOR FLASHCARDS ==========
        let touchStartX = 0;
        let touchEndX = 0;
        const SWIPE_THRESHOLD = 50; // Minimum distance for swipe

        function setupFlashcardTouchGestures() {
            const flashcard = document.getElementById("flashcard");
            if (!flashcard) return;

            // Touch start
            flashcard.addEventListener('touchstart', function (e) {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            // Touch end
            flashcard.addEventListener('touchend', function (e) {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });
        }

        function handleSwipe() {
            const swipeDistance = touchEndX - touchStartX;

            // Swipe left (next)
            if (swipeDistance < -SWIPE_THRESHOLD) {
                if (isFlashcardFlipped) {
                    // If flipped, go to next card
                    nextFlashcard();
                } else {
                    // If not flipped, flip the card
                    flipCard();
                }
            }
            // Swipe right (previous)
            else if (swipeDistance > SWIPE_THRESHOLD) {
                if (isFlashcardFlipped) {
                    // Go back to previous card
                    previousFlashcard();
                }
            }
        }

        function flipCard() {
            if (isFlashcardFlipped) return; // Ju≈º odwr√≥cona

            const flashcard = document.getElementById("flashcard");
            flashcard.classList.add("flipped");
            isFlashcardFlipped = true;

            // Poka≈º przyciski oceny po animacji
            setTimeout(() => {
                const ratingContainer = document.getElementById("flashcard-rating");
                const simpleRating = document.getElementById("flashcard-rating-simple");
                const srsRating = document.getElementById("flashcard-rating-srs");

                ratingContainer.style.display = "flex";

                // Poka≈º odpowiednie przyciski w zale≈ºno≈õci od trybu
                if (currentFlashcardMode === "srs") {
                    simpleRating.style.display = "none";
                    srsRating.style.display = "grid";
                } else {
                    simpleRating.style.display = "flex";
                    srsRating.style.display = "none";
                }
            }, 300);
        }

        function rateFlashcard(knewIt) {
            if (!isFlashcardFlipped) return;

            const q = flashcards[currentFlashcardIndex];

            // Zapisz wynik
            if (knewIt) {
                flashcardStats.know++;
            } else {
                flashcardStats.dontKnow++;
            }

            // Zapisz dane fiszki dla u≈ºytkownika
            if (!users[currentUser].flashcardData) {
                users[currentUser].flashcardData = {};
            }

            users[currentUser].flashcardData[q.id] = {
                difficult: !knewIt, // Oznacz jako trudne je≈õli nie umia≈Ç
                lastReviewed: new Date().toISOString(),
                timesReviewed: (users[currentUser].flashcardData[q.id]?.timesReviewed || 0) + 1,
                timesKnown: (users[currentUser].flashcardData[q.id]?.timesKnown || 0) + (knewIt ? 1 : 0)
            };

            safeSetItem("quizUsers", JSON.stringify(users));

            // Nastƒôpna fiszka
            nextFlashcard();
        }

        // SRS rating with quality parameter (0-5)
        function rateFlashcardSRS(quality) {
            if (!isFlashcardFlipped) return;

            const q = flashcards[currentFlashcardIndex];

            // Calculate next SRS interval
            const srsData = calculateNextSRS(q.id, quality);

            if (!srsData) {
                showToast("B≈ÇƒÖd podczas aktualizacji SRS", "error");
                return;
            }

            // Update stats for session feedback
            if (quality < 3) {
                flashcardStats.dontKnow++;
            } else {
                flashcardStats.know++;
            }

            // Show brief feedback
            const messages = {
                0: "üîÑ Pon√≥w to pytanie wkr√≥tce",
                2: "üí™ Trudne - powt√≥rz za kilka dni",
                3: "üëç Dobrze - do zobaczenia wkr√≥tce",
                5: "‚≠ê ≈öwietnie - od≈Ço≈ºone na d≈Çu≈ºej!"
            };
            showToast(messages[quality] || "Zapisano", "info", 1000);

            // Nastƒôpna fiszka
            nextFlashcard();
        }

        function nextFlashcard() {
            currentFlashcardIndex++;
            showFlashcard();
        }

        function previousFlashcard() {
            if (currentFlashcardIndex > 0) {
                currentFlashcardIndex--;
                showFlashcard();
            }
        }

        function showFlashcardComplete() {
            document.getElementById("flashcard-active").classList.add("hidden");
            document.getElementById("flashcard-complete").classList.remove("hidden");

            const total = flashcardStats.know + flashcardStats.dontKnow;
            const percentage = total > 0 ? Math.round((flashcardStats.know / total) * 100) : 0;

            document.getElementById("flashcard-final-score").textContent = percentage + "%";
            document.getElementById("final-know").textContent = flashcardStats.know;
            document.getElementById("final-dontknow").textContent = flashcardStats.dontKnow;

            // Wiadomo≈õƒá
            let message = "";
            if (percentage >= 80) {
                message = "≈öwietna robota! üéâ Prawie wszystko umia≈Çe≈õ!";
            } else if (percentage >= 60) {
                message = "Nie≈∫le! üëç Ale jest jeszcze trochƒô do powt√≥rzenia.";
            } else if (percentage >= 40) {
                message = "Wymaga jeszcze trochƒô praktyki. üí™ Nie poddawaj siƒô!";
            } else {
                message = "Warto powt√≥rzyƒá te pytania. üîÑ Spr√≥buj ponownie!";
            }

            document.getElementById("flashcard-final-message").textContent = message;
        }

        function exitFlashcards() {
            // Poka≈º bottom nav po wyj≈õciu z fiszek
            document.body.classList.remove('in-flashcards');

            document.getElementById("flashcard-setup").classList.remove("hidden");
            document.getElementById("flashcard-active").classList.add("hidden");
            document.getElementById("flashcard-complete").classList.add("hidden");
        }

        // Skr√≥ty klawiaturowe dla fiszek i trybu nauki
        document.addEventListener("keydown", function (e) {
            // Ignoruj je≈õli u≈ºytkownik pisze w inpucie
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }

            // ========== FLASHCARDS SHORTCUTS ==========
            // Tylko je≈õli jeste≈õmy w trybie fiszek i karta jest widoczna
            if (!document.getElementById("flashcard-active").classList.contains("hidden")) {
                // Spacja - obr√≥ƒá kartƒô
                if (e.code === "Space" && !isFlashcardFlipped) {
                    e.preventDefault();
                    flipCard();
                }

                // SRS mode shortcuts (1-4 for quality ratings)
                if (isFlashcardFlipped && currentFlashcardMode === "srs") {
                    // 1 - Again (quality 0)
                    if (e.key === "1") {
                        e.preventDefault();
                        rateFlashcardSRS(0);
                    }
                    // 2 - Hard (quality 2)
                    if (e.key === "2") {
                        e.preventDefault();
                        rateFlashcardSRS(2);
                    }
                    // 3 - Good (quality 3)
                    if (e.key === "3") {
                        e.preventDefault();
                        rateFlashcardSRS(3);
                    }
                    // 4 - Easy (quality 5)
                    if (e.key === "4") {
                        e.preventDefault();
                        rateFlashcardSRS(5);
                    }
                }
                // Standard mode shortcuts (1-2 for know/don't know)
                else if (isFlashcardFlipped) {
                    // 1 - nie umia≈Çem
                    if (e.key === "1") {
                        e.preventDefault();
                        rateFlashcard(false);
                    }
                    // 2 - umia≈Çem
                    if (e.key === "2") {
                        e.preventDefault();
                        rateFlashcard(true);
                    }
                }

                // Strza≈Çka w prawo - nastƒôpna
                if (e.key === "ArrowRight" && !isFlashcardFlipped) {
                    e.preventDefault();
                    nextFlashcard();
                }

                // Strza≈Çka w lewo - poprzednia
                if (e.key === "ArrowLeft" && !isFlashcardFlipped) {
                    e.preventDefault();
                    previousFlashcard();
                }
            }

            // ========== PRACTICE MODE SHORTCUTS ==========
            // Tylko je≈õli jeste≈õmy w trybie nauki
            if (!document.getElementById("practice-interface").classList.contains("hidden")) {
                // Spacja - sprawd≈∫ odpowied≈∫
                if (e.code === "Space" && !practiceAnswered) {
                    e.preventDefault();
                    checkPracticeAnswer();
                }
                // Enter - nastƒôpne pytanie (je≈õli ju≈º odpowiedziano)
                else if (e.code === "Enter" && practiceAnswered) {
                    e.preventDefault();
                    nextPracticeQuestion();
                }
                // Escape - zako≈Ñcz naukƒô
                else if (e.key === "Escape") {
                    e.preventDefault();
                    endPracticeEarly();
                }
                // Cyfry 1-4 - wybierz odpowied≈∫
                else if (!practiceAnswered && e.key >= "1" && e.key <= "4") {
                    e.preventDefault();
                    const optionIndex = parseInt(e.key) - 1;
                    // Toggle the selected option
                    togglePracticeOption(optionIndex);
                }
            }

            // ========== TEST MODE SHORTCUTS ==========
            // Tylko je≈õli jeste≈õmy w trybie testu
            if (!document.getElementById("test-interface").classList.contains("hidden")) {
                // Spacja - nastƒôpne pytanie lub sprawd≈∫
                if (e.code === "Space") {
                    e.preventDefault();
                    // Sprawd≈∫ czy widoczny jest przycisk submit
                    const submitBtn = document.querySelector('#test-interface button[onclick="submitTestAnswer()"]');
                    if (submitBtn && !submitBtn.classList.contains('hidden')) {
                        submitTestAnswer();
                    } else {
                        // Przejd≈∫ do nastƒôpnego pytania
                        const nextBtn = document.querySelector('#test-interface button[onclick="nextQuestion()"]');
                        if (nextBtn) nextQuestion();
                    }
                }
                // Escape - zako≈Ñcz test przedwcze≈õnie
                else if (e.key === "Escape") {
                    e.preventDefault();
                    // Potwierd≈∫ przed zako≈Ñczeniem
                    if (confirm("Czy na pewno chcesz zako≈Ñczyƒá test przedwcze≈õnie?")) {
                        stopTestTimer();
                        document.getElementById("test-setup").classList.remove("hidden");
                        document.getElementById("test-interface").classList.add("hidden");
                    }
                }
            }
        });

        function showSection(sectionName) {
            // Stop timer if leaving test section while timer is running
            if (isTimerRunning && sectionName !== "test") {
                stopTestTimer();
                // Reset test interface
                document.getElementById("test-setup").classList.remove("hidden");
                document.getElementById("test-interface").classList.add("hidden");
            }

            const sections = ["dashboard", "practice", "flashcards", "test", "questions", "results", "detailed-results", "admin"];
            sections.forEach(s => {
                const sectionEl = document.getElementById(s + "-section");
                if (sectionEl) sectionEl.classList.add("hidden");
                const navBtn = document.getElementById("nav-" + s);
                if (navBtn) navBtn.classList.remove("active");
            });

            // Aktualizuj klasƒô is-admin na body przy ka≈ºdej zmianie sekcji
            if (currentUser && users[currentUser]) {
                if (users[currentUser].isAdmin) {
                    document.body.classList.add("is-admin");
                } else {
                    document.body.classList.remove("is-admin");
                }
            }

            document.getElementById(sectionName + "-section").classList.remove("hidden");
            const navBtn = document.getElementById("nav-" + sectionName);
            if (navBtn) navBtn.classList.add("active");

            if (sectionName === "dashboard") updateDashboard();
            if (sectionName === "questions") {
                // Sprawd≈∫ uprawnienia i poka≈º/ukryj elementy edycji
                const canEdit = users[currentUser] && (users[currentUser].isAdmin || users[currentUser].canEditQuestions);
                const addContainer = document.getElementById("add-question-container");
                const importExportBtns = document.getElementById("import-export-buttons");
                if (addContainer) {
                    addContainer.style.display = canEdit ? "block" : "none";
                }
                if (importExportBtns) {
                    importExportBtns.style.display = canEdit ? "flex" : "none";
                }

                // NOWE: Aktualizuj filtry przed renderowaniem
                updateCategorySelects();

                renderQuestions();
            }
            if (sectionName === "results") renderResults();
            if (sectionName === "detailed-results") renderDetailedResults();
            if (sectionName === "admin") renderAdminPanel();

            // Update bottom navigation active state
            window.updateBottomNavActive(sectionName);
        }

        function updateDashboard() {
            cleanQuestionsData();
            document.getElementById("totalQuestions").textContent = questions.length;

            const results = users[currentUser].testResults || [];
            document.getElementById("totalTests").textContent = results.length;

            if (results.length > 0) {
                // ≈öredni wynik
                const avg = results.reduce((sum, r) => sum + parseFloat(r.score), 0) / results.length;
                document.getElementById("avgScore").textContent = avg.toFixed(1) + "%";

                // Najlepszy wynik
                const bestScore = Math.max(...results.map(r => parseFloat(r.score)));
                document.getElementById("bestScore").textContent = bestScore + "%";

                // Ostatni test
                const lastTestScore = parseFloat(results[results.length - 1].score);
                document.getElementById("lastTestScore").textContent = lastTestScore + "%";
            } else {
                document.getElementById("avgScore").textContent = "0%";
                document.getElementById("bestScore").textContent = "0%";
                document.getElementById("lastTestScore").textContent = "0%";
            }

            // Dodaj statystyki kategorii
            updateCategorySelects();
            renderCategoryStats();

            // Calculate and display study streak
            updateStudyStreak();

            // Render analytics dashboard
            renderAnalyticsDashboard();
        }

        // ========== STUDY STREAK SYSTEM ==========
        function calculateStudyStreak() {
            const results = users[currentUser].testResults || [];
            if (results.length === 0) return 0;

            // Get unique study dates (YYYY-MM-DD format)
            const studyDates = [...new Set(results.map(r => {
                const date = new Date(r.date);
                return date.toISOString().split('T')[0];
            }))].sort().reverse(); // Most recent first

            if (studyDates.length === 0) return 0;

            let streak = 0;
            let currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0); // Reset to midnight

            // Check if studied today or yesterday (to allow streak continuation)
            const today = currentDate.toISOString().split('T')[0];
            const yesterday = new Date(currentDate);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            // Start checking from most recent study date
            let checkDate = currentDate;

            for (let i = 0; i < studyDates.length; i++) {
                const checkDateStr = checkDate.toISOString().split('T')[0];

                if (studyDates[i] === checkDateStr) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1); // Move to previous day
                } else if (i === 0 && (studyDates[i] !== today && studyDates[i] !== yesterdayStr)) {
                    // Most recent study is not today or yesterday - streak broken
                    break;
                } else {
                    // Gap in study dates - streak broken
                    break;
                }
            }

            return streak;
        }

        function updateStudyStreak() {
            const streak = calculateStudyStreak();

            // Create or update streak display
            let streakDisplay = document.getElementById("study-streak-display");
            if (!streakDisplay) {
                streakDisplay = document.createElement("div");
                streakDisplay.id = "study-streak-display";
                streakDisplay.className = "study-streak-card";
                streakDisplay.style.cssText = `
                    background: linear-gradient(135deg, var(--warning-color) 0%, #f59e0b 100%);
                    color: white;
                    padding: 20px;
                    border-radius: var(--border-radius-large);
                    margin-bottom: 20px;
                    box-shadow: var(--shadow-lg);
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    animation: slideInLeft 0.5s ease-out;
                `;

                // Insert after total questions
                const totalQuestionsEl = document.getElementById("totalQuestions");
                if (totalQuestionsEl && totalQuestionsEl.parentElement) {
                    totalQuestionsEl.parentElement.after(streakDisplay);
                }
            }

            // Update streak content
            if (streak === 0) {
                streakDisplay.innerHTML = `
                    <div>
                        <div style="font-size: var(--text-sm); opacity: 0.9;">üî• Study Streak</div>
                        <div style="font-size: var(--text-xl); font-weight: var(--font-bold);">Rozpocznij naukƒô ju≈º dzi≈õ!</div>
                    </div>
                    <div style="font-size: var(--text-4xl);">üí™</div>
                `;
            } else if (streak === 1) {
                streakDisplay.innerHTML = `
                    <div>
                        <div style="font-size: var(--text-sm); opacity: 0.9;">üî• Study Streak</div>
                        <div style="font-size: var(--text-xl); font-weight: var(--font-bold);">${streak} dzie≈Ñ z rzƒôdu!</div>
                    </div>
                    <div style="font-size: var(--text-4xl);">üî•</div>
                `;
            } else {
                streakDisplay.innerHTML = `
                    <div>
                        <div style="font-size: var(--text-sm); opacity: 0.9;">üî• Study Streak</div>
                        <div style="font-size: var(--text-xl); font-weight: var(--font-bold);">${streak} dni z rzƒôdu!</div>
                        <div style="font-size: var(--text-xs); opacity: 0.8;">≈öwietna robota! Kontynuuj naukƒô üöÄ</div>
                    </div>
                    <div style="font-size: var(--text-4xl);">‚ö°</div>
                `;
            }
        }

        // ========== ANALYTICS & INSIGHTS ==========
        function renderAnalyticsDashboard() {
            const container = document.getElementById("analytics-dashboard");
            if (!container) return;

            const results = users[currentUser].testResults || [];

            if (results.length === 0) {
                container.innerHTML = `
                    <div class="analytics-card">
                        <h3>üìä Analytics & Insights</h3>
                        <p style="color: var(--text-light); text-align: center; padding: 20px;">
                            RozwiƒÖ≈º pierwszy test, aby zobaczyƒá statystyki!
                        </p>
                    </div>
                `;
                return;
            }

            // Calculate all analytics
            const progressChart = generateProgressChart(results);
            const weakAreas = identifyWeakAreas(results);
            const performanceMetrics = calculatePerformanceMetrics(results);
            const learningInsights = generateLearningInsights(results);

            container.innerHTML = `
                <div class="analytics-grid">
                    <!-- Progress Over Time -->
                    <div class="analytics-card">
                        <h3>üìà Postƒôp w czasie</h3>
                        ${progressChart}
                    </div>

                    <!-- Weak & Strong Areas -->
                    <div class="analytics-card">
                        <h3>üéØ S≈Çabe i mocne obszary</h3>
                        ${weakAreas}
                    </div>

                    <!-- Performance Metrics -->
                    <div class="analytics-card">
                        <h3>‚ö° Metryki wydajno≈õci</h3>
                        ${performanceMetrics}
                    </div>

                    <!-- Learning Insights -->
                    <div class="analytics-card">
                        <h3>üí° Wnioski z nauki</h3>
                        ${learningInsights}
                    </div>
                </div>
            `;
        }

        function generateProgressChart(results) {
            // Take last 10 results for the chart
            const recentResults = results.slice(-10);
            const scores = recentResults.map(r => parseFloat(r.score));

            // Calculate trend
            let trend = 'neutral';
            let trendIcon = '‚û°Ô∏è';
            if (scores.length >= 2) {
                const recentAvg = scores.slice(-3).reduce((a, b) => a + b, 0) / Math.min(3, scores.length);
                const olderAvg = scores.slice(0, -3).reduce((a, b) => a + b, 0) / Math.max(1, scores.length - 3);
                if (recentAvg > olderAvg + 5) {
                    trend = 'up';
                    trendIcon = 'üìà';
                } else if (recentAvg < olderAvg - 5) {
                    trend = 'down';
                    trendIcon = 'üìâ';
                }
            }

            // Generate simple SVG line chart
            const maxScore = 100;
            const width = 100;
            const height = 60;
            const padding = 5;

            const points = scores.map((score, i) => {
                const x = padding + (i / (scores.length - 1)) * (width - 2 * padding);
                const y = height - padding - (score / maxScore) * (height - 2 * padding);
                return `${x},${y}`;
            }).join(' ');

            const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;

            let chartClass = 'high';
            if (avgScore < 60) chartClass = 'low';
            else if (avgScore < 80) chartClass = 'medium';

            return `
                <div class="line-chart">
                    <svg viewBox="0 0 100 60" preserveAspectRatio="none">
                        <!-- Grid lines -->
                        <line x1="0" y1="15" x2="100" y2="15" stroke="var(--border-color)" stroke-width="0.5" stroke-dasharray="2"/>
                        <line x1="0" y1="30" x2="100" y2="30" stroke="var(--border-color)" stroke-width="0.5" stroke-dasharray="2"/>
                        <line x1="0" y1="45" x2="100" y2="45" stroke="var(--border-color)" stroke-width="0.5" stroke-dasharray="2"/>
                        <!-- Progress line -->
                        <polyline
                            points="${points}"
                            fill="none"
                            stroke="var(--primary-color)"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        />
                        <!-- Data points -->
                        ${scores.map((score, i) => {
                const x = padding + (i / (scores.length - 1)) * (width - 2 * padding);
                const y = height - padding - (score / maxScore) * (height - 2 * padding);
                return `<circle cx="${x}" cy="${y}" r="2" fill="var(--primary-color)"/>`;
            }).join('')}
                    </svg>
                </div>
                <div class="progress-chart-message">
                    <strong>≈örednia z ostatnich ${scores.length} test√≥w:</strong> ${avgScore.toFixed(1)}%
                    <span style="margin-left: 8px; font-size: var(--text-lg);">${trendIcon}</span>
                </div>
            `;
        }

        function identifyWeakAreas(results) {
            // Calculate category performance
            const categoryStats = {};
            const categoryCounts = {};

            results.forEach(result => {
                if (result.detailedAnswers) {
                    result.detailedAnswers.forEach(answer => {
                        const question = questions.find(q => q.id === answer.questionId);
                        if (!question) return;

                        const category = question.category || 'Bez kategorii';

                        if (!categoryStats[category]) {
                            categoryStats[category] = { correct: 0, total: 0 };
                        }

                        categoryStats[category].total++;
                        if (answer.isCorrect) {
                            categoryStats[category].correct++;
                        }

                        categoryCounts[category] = (categoryCounts[category] || 0) + 1;
                    });
                }
            });

            // Calculate percentages and sort
            const categories = Object.keys(categoryStats).map(cat => {
                const stats = categoryStats[cat];
                const percentage = stats.total > 0 ? (stats.correct / stats.total * 100) : 0;
                return {
                    category: cat,
                    percentage: percentage,
                    correct: stats.correct,
                    total: stats.total
                };
            }).sort((a, b) => a.percentage - b.percentage);

            // Separate weak and strong areas
            const weakAreas = categories.filter(c => c.percentage < 70);
            const strongAreas = categories.filter(c => c.percentage >= 85);

            let html = '';

            // Weak areas
            if (weakAreas.length > 0) {
                html += `<div style="margin-bottom: 16px;">
                    <strong style="color: var(--danger-color);">üî¥ Do poprawy:</strong>
                    <div style="margin-top: 8px;">`;
                weakAreas.forEach(area => {
                    html += `<span class="weak-area-badge">${escapeHTML(area.category)} (${area.percentage.toFixed(0)}%)</span>`;
                });
                html += `</div></div>`;
            } else {
                html += `<div style="margin-bottom: 16px;">
                    <strong style="color: var(--success-color);">‚úÖ Brak s≈Çabych obszar√≥w!</strong>
                    <div style="font-size: var(--text-sm); color: var(--text-light);">≈öwietna robota ze wszystkich kategorii!</div>
                </div>`;
            }

            // Strong areas
            if (strongAreas.length > 0) {
                html += `<div>
                    <strong style="color: var(--success-color);">üü¢ Twoje mocne strony:</strong>
                    <div style="margin-top: 8px;">`;
                strongAreas.forEach(area => {
                    html += `<span class="strong-area-badge">${escapeHTML(area.category)} (${area.percentage.toFixed(0)}%)</span>`;
                });
                html += `</div></div>`;
            }

            // Bar chart for all categories
            html += `<div class="bar-chart">`;
            categories.forEach(cat => {
                const barClass = cat.percentage < 60 ? 'low' : cat.percentage < 80 ? 'medium' : 'high';
                html += `
                    <div class="bar-chart-row">
                        <div class="bar-chart-label">${escapeHTML(cat.category).substring(0, 20)}</div>
                        <div class="bar-chart-bar-container">
                            <div class="bar-chart-bar ${barClass}" style="width: ${cat.percentage}%">
                                <span class="bar-chart-value">${cat.percentage.toFixed(0)}%</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;

            return html;
        }

        function calculatePerformanceMetrics(results) {
            if (results.length === 0) return '<p>Brak danych</p>';

            // Calculate metrics
            const scores = results.map(r => parseFloat(r.score));
            const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;
            const bestScore = Math.max(...scores);
            const worstScore = Math.min(...scores);

            // Calculate improvement (first 3 vs last 3)
            let improvement = 0;
            let improvementText = 'Brak danych';
            if (scores.length >= 6) {
                const firstAvg = scores.slice(0, 3).reduce((a, b) => a + b, 0) / 3;
                const lastAvg = scores.slice(-3).reduce((a, b) => a + b, 0) / 3;
                improvement = lastAvg - firstAvg;
                improvementText = `${improvement > 0 ? '+' : ''}${improvement.toFixed(1)}%`;
            }

            // Calculate accuracy rate (correct answers / total answers)
            let totalQuestions = 0;
            let totalCorrect = 0;
            results.forEach(result => {
                if (result.correct !== undefined && result.total !== undefined) {
                    totalQuestions += result.total;
                    totalCorrect += result.correct;
                }
            });
            const accuracy = totalQuestions > 0 ? (totalCorrect / totalQuestions * 100) : 0;

            // Calculate consistency (standard deviation)
            const variance = scores.reduce((sum, score) => sum + Math.pow(score - avgScore, 2), 0) / scores.length;
            const stdDev = Math.sqrt(variance);
            const consistency = 100 - stdDev; // Higher is better

            return `
                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-label">≈öredni wynik</div>
                        <div class="metric-value">${avgScore.toFixed(1)}%</div>
                        <div class="metric-trend ${avgScore >= 70 ? 'up' : avgScore >= 50 ? 'neutral' : 'down'}">
                            ${avgScore >= 70 ? 'üëç Dobrze' : avgScore >= 50 ? '‚ö†Ô∏è OK' : '‚ùå Niska'}
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Najlepszy wynik</div>
                        <div class="metric-value">${bestScore}%</div>
                        <div class="metric-trend up">üèÜ Rekord</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Dok≈Çadno≈õƒá</div>
                        <div class="metric-value">${accuracy.toFixed(1)}%</div>
                        <div class="metric-trend ${accuracy >= 80 ? 'up' : accuracy >= 60 ? 'neutral' : 'down'}">
                            ${accuracy >= 80 ? 'üéØ Precyzyjny' : accuracy >= 60 ? '‚ö†Ô∏è ≈örednio' : '‚ùå Niska'}
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Konsekwencja</div>
                        <div class="metric-value">${consistency.toFixed(0)}%</div>
                        <div class="metric-trend ${consistency >= 85 ? 'up' : consistency >= 70 ? 'neutral' : 'down'}">
                            ${consistency >= 85 ? 'üí™ Stabilny' : consistency >= 70 ? '‚ö†Ô∏è Zmienny' : 'üé≤ Losowy'}
                        </div>
                    </div>
                </div>
                ${scores.length >= 6 ? `
                    <div style="margin-top: 16px; padding: 12px; background: var(--bg-warm); border-radius: var(--border-radius); text-align: center;">
                        <div style="font-size: var(--text-sm); color: var(--text-secondary);">Poprawa (poczƒÖtek vs koniec)</div>
                        <div style="font-size: var(--text-xl); font-weight: var(--font-bold); color: ${improvement >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">
                            ${improvementText}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function generateLearningInsights(results) {
            if (results.length < 3) {
                return '<p style="color: var(--text-light); text-align: center;">RozwiƒÖ≈º co najmniej 3 testy, aby zobaczyƒá wnioski.</p>';
            }

            const insights = [];

            // Analyze score trend
            const scores = results.map(r => parseFloat(r.score));
            const recentScores = scores.slice(-5);
            const trend = recentScores[recentScores.length - 1] - recentScores[0];

            if (trend > 15) {
                insights.push({
                    icon: 'üöÄ',
                    text: '≈öwietna progressja! Twoje wyniki znacznie siƒô poprawi≈Çy w ostatnich testach.',
                    type: 'success'
                });
            } else if (trend < -15) {
                insights.push({
                    icon: '‚ö†Ô∏è',
                    text: 'Twoje wyniki spad≈Çy w ostatnich testach. Mo≈ºe warto powt√≥rzyƒá trudne tematy?',
                    type: 'warning'
                });
            } else {
                insights.push({
                    icon: '‚û°Ô∏è',
                    text: 'Twoje wyniki sƒÖ stabilne. Kontynuuj naukƒô, aby zobaczyƒá wiƒôkszƒÖ poprawƒô!',
                    type: 'neutral'
                });
            }

            // Analyze consistency
            const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;
            const aboveAvgCount = scores.filter(s => s >= avgScore).length;

            if (aboveAvgCount >= scores.length * 0.7) {
                insights.push({
                    icon: 'üí™',
                    text: 'Bardzo konsekwentny ucze≈Ñ! Wiƒôkszo≈õƒá Twoich wynik√≥w jest powy≈ºej ≈õredniej.',
                    type: 'success'
                });
            }

            // Analyze improvement rate
            if (scores.length >= 10) {
                const firstHalf = scores.slice(0, Math.floor(scores.length / 2));
                const secondHalf = scores.slice(Math.floor(scores.length / 2));
                const firstAvg = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
                const secondAvg = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;

                if (secondAvg > firstAvg + 20) {
                    insights.push({
                        icon: '‚≠ê',
                        text: 'ImponujƒÖca poprawa! Twoja wiedza znacznie siƒô rozwinƒô≈Ça.',
                        type: 'success'
                    });
                }
            }

            // Study frequency insight
            if (results.length >= 5) {
                const dates = results.slice(-5).map(r => new Date(r.date).getTime());
                const timeSpan = Math.max(...dates) - Math.min(...dates);
                const days = timeSpan / (1000 * 60 * 60 * 24);

                if (days <= 7) {
                    insights.push({
                        icon: 'üî•',
                        text: 'Intensywna nauka! RozwiƒÖza≈Çe≈õ 5 test√≥w w ciƒÖgu tygodnia. Pamiƒôtaj o przerwach!',
                        type: 'warning'
                    });
                } else if (days <= 30) {
                    insights.push({
                        icon: 'üìÖ',
                        text: 'Dobra regularno≈õƒá. Uczysz siƒô systematycznie, co jest kluczem do sukcesu!',
                        type: 'success'
                    });
                }
            }

            return `
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    ${insights.map(insight => `
                        <div style="padding: 12px; background: var(--bg-warm); border-radius: var(--border-radius); border-left: 4px solid ${insight.type === 'success' ? 'var(--success-color)' :
                    insight.type === 'warning' ? 'var(--warning-color)' :
                        'var(--info-color)'
                };">
                            <span style="font-size: var(--text-lg); margin-right: 8px;">${insight.icon}</span>
                            <span style="font-size: var(--text-sm); color: var(--text-primary);">${insight.text}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderCategoryStats() {
            const container = document.getElementById("dashboard-section");
            if (!container) return;

            // Usu≈Ñ istniejƒÖce statystyki kategorii je≈õli sƒÖ
            const existingStats = document.getElementById("category-stats");
            if (existingStats) existingStats.remove();

            const existingProgress = document.getElementById("category-progress");
            if (existingProgress) existingProgress.remove();

            const categories = getAllCategories();
            if (categories.length === 0) return;

            // Statystyki pyta≈Ñ wed≈Çug kategorii
            const statsDiv = document.createElement("div");
            statsDiv.id = "category-stats";
            statsDiv.className = "category-stats";
            statsDiv.innerHTML = "<h3>üìÅ Statystyki pyta≈Ñ wed≈Çug kategorii</h3>";

            categories.forEach(cat => {
                const count = questions.filter(q => (q.category || "") === cat).length;
                const item = document.createElement("div");
                item.className = "category-stat-item";
                item.innerHTML = `
                    <span class="category-stat-name">${escapeHTML(cat)}</span>
                    <span class="category-stat-count">${count} pyta≈Ñ</span>
                `;
                statsDiv.appendChild(item);
            });

            // Dodaj po pierwszym question-item
            const firstItem = container.querySelector(".question-item");
            if (firstItem) {
                firstItem.after(statsDiv);
            }

            // Statystyki postƒôp√≥w w nauce wed≈Çug kategorii
            const results = users[currentUser].testResults || [];
            if (results.length > 0) {
                const categoryProgress = document.createElement("div");
                categoryProgress.id = "category-progress";
                categoryProgress.className = "category-stats";
                categoryProgress.style.marginTop = "20px";
                categoryProgress.innerHTML = "<h3>üìà Postƒôpy w nauce wed≈Çug kategorii</h3>";

                // Oblicz statystyki per kategoria
                const categoryStats = {};
                results.forEach(r => {
                    const cat = r.category || 'Wszystkie';
                    if (!categoryStats[cat]) {
                        categoryStats[cat] = { count: 0, totalScore: 0 };
                    }
                    categoryStats[cat].count++;
                    categoryStats[cat].totalScore += parseFloat(r.score);
                });

                // Posortuj kategorie wg liczby test√≥w
                const sortedCategories = Object.entries(categoryStats)
                    .sort((a, b) => b[1].count - a[1].count);

                if (sortedCategories.length > 0) {
                    sortedCategories.forEach(([cat, stats]) => {
                        const avg = (stats.totalScore / stats.count).toFixed(1);
                        const item = document.createElement("div");
                        item.className = "category-stat-item";

                        // Koloruj wynik
                        let scoreColor = "#dc3545"; // czerwony < 60%
                        if (avg >= 90) scoreColor = "#28a745"; // zielony >= 90%
                        else if (avg >= 70) scoreColor = "#007bff"; // niebieski >= 70%
                        else if (avg >= 60) scoreColor = "#ffc107"; // ≈º√≥≈Çty >= 60%

                        item.innerHTML = `
                            <span class="category-stat-name">${escapeHTML(cat)}</span>
                            <span class="category-stat-count" style="color: ${scoreColor}; font-weight: bold;">
                                ${avg}% (${stats.count} ${stats.count === 1 ? 'test' : 'test√≥w'})
                            </span>
                        `;
                        categoryProgress.appendChild(item);
                    });

                    // Dodaj po statystykach pyta≈Ñ
                    const statsSection = document.getElementById("category-stats");
                    if (statsSection) {
                        statsSection.after(categoryProgress);
                    }
                }
            }
        }

        // ========== WYSIWYG EDITOR ==========
        function initWYSIWYG(toolbarId, editorId, hiddenTextareaId) {
            const toolbar = document.getElementById(toolbarId);
            const editor = document.getElementById(editorId);
            const hiddenTextarea = document.getElementById(hiddenTextareaId);

            if (!toolbar || !editor) return;

            toolbar.querySelectorAll('button[data-cmd]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const cmd = btn.dataset.cmd;
                    document.execCommand(cmd, false, null);
                    editor.focus();

                    // Zapisz do ukrytego textarea
                    if (hiddenTextarea) {
                        hiddenTextarea.value = sanitizeHTML(editor.innerHTML);
                    }

                    // Aktualizuj podglƒÖd
                    updateLivePreview();
                });
            });

            // Zapisuj przy wpisywaniu
            editor.addEventListener('input', () => {
                if (hiddenTextarea) {
                    hiddenTextarea.value = sanitizeHTML(editor.innerHTML);
                }
                updateLivePreview();
            });
        }

        function getWYSIWYGContent(editorId) {
            const editor = document.getElementById(editorId);
            return editor ? sanitizeHTML(editor.innerHTML) : '';
        }

        function setWYSIWYGContent(editorId, content) {
            const editor = document.getElementById(editorId);
            if (editor) {
                editor.innerHTML = content;

                // Zapisz te≈º do ukrytego textarea
                const hiddenTextarea = document.getElementById(editorId === 'questionEditor' ? 'questionText' : 'explanation');
                if (hiddenTextarea) {
                    hiddenTextarea.value = sanitizeHTML(content);
                }
            }
        }

        function sanitizeHTML(html) {
            if (!html) return '';

            // Zezw√≥l tylko na podstawowe tagi
            // Dodano 'div' i 'p' bo contenteditable u≈ºywa ich dla nowych linii (Enter)
            const allowedTags = ['b', 'i', 'u', 'ul', 'li', 'br', 'strong', 'em', 'div', 'p'];

            // Usu≈Ñ niebezpieczne atrybuty i tagi
            const temp = document.createElement('div');
            temp.innerHTML = html;

            // Przejd≈∫ przez wszystkie elementy
            const allElements = temp.querySelectorAll('*');
            allElements.forEach(el => {
                // Usu≈Ñ wszystkie atrybuty (bezpiecze≈Ñstwo)
                while (el.attributes.length > 0) {
                    el.removeAttribute(el.attributes[0].name);
                }

                // Usu≈Ñ element je≈õli nie jest dozwolonym tagiem
                if (!allowedTags.includes(el.tagName.toLowerCase())) {
                    // Zachowaj tekst, usu≈Ñ tag
                    const parent = el.parentNode;
                    while (el.firstChild) {
                        parent.insertBefore(el.firstChild, el);
                    }
                    parent.removeChild(el);
                }
            });

            return temp.innerHTML;
        }

        // ========== PODGLƒÑD NA ≈ªYWO ==========
        function updateLivePreview() {
            const preview = document.getElementById("live-preview");
            if (!preview) return;

            const questionText = getWYSIWYGContent('questionEditor');
            const questionType = document.getElementById("questionType").value;

            // Je≈õli nic nie wype≈Çniono, poka≈º placeholder
            if (!questionText) {
                preview.innerHTML = `
                    <p class="preview-placeholder">
                        Wype≈Çnij formularz aby zobaczyƒá podglƒÖd pytania...
                    </p>
                `;
                return;
            }

            // Dla ordering - inny podglƒÖd
            if (questionType === "ordering") {
                const orderingSteps = getOrderingStepsData();
                const typeLabel = "U≈Ç√≥≈º w kolejno≈õci";

                let previewHTML = `
                    <div class="test-question">
                        <h4 class="question-type-label">${typeLabel}</h4>
                        ${(currentImageData && currentImageData.startsWith('data:')) ? `<img src="${currentImageData}" style="max-width: 100%; max-height: 400px; margin: 0 auto 20px auto; border-radius: 8px; border: 2px solid #ddd; display: block;" alt="PodglƒÖd obrazu">` : ''}
                        <div class="question-text">${questionText || '<em style="color:#999">(Brak tre≈õci pytania)</em>'}</div>
                        <div class="ordering-correct-sequence">
                            <strong>Prawid≈Çowa kolejno≈õƒá:</strong>
                            <ol style="margin: 10px 0 0 20px;">
                `;

                orderingSteps.forEach((step, i) => {
                    previewHTML += `<li>${escapeHTML(step)}</li>`;
                });

                previewHTML += `
                            </ol>
                        </div>
                    </div>
                `;

                preview.innerHTML = previewHTML;
                return;
            }

            // Dla single/multiple - zwyk≈Çy podglƒÖd
            const { options, correct } = getOptionsData();
            const typeLabel = questionType === "single" ? "Jedna poprawna odpowied≈∫" : "Wiele poprawnych odpowiedzi";

            let previewHTML = `
                <div class="test-question">
                    <h4 class="question-type-label">${typeLabel}</h4>
                    ${(currentImageData && currentImageData.startsWith('data:')) ? `<img src="${currentImageData}" style="max-width: 100%; max-height: 400px; margin: 0 auto 20px auto; border-radius: 8px; border: 2px solid #ddd; display: block;" alt="PodglƒÖd obrazu">` : ''}
                    <div class="question-text">${questionText || '<em style="color:#999">(Brak tre≈õci pytania)</em>'}</div>
                    <div class="test-options">
            `;

            options.forEach((opt, i) => {
                const isCorrect = correct.includes(i + 1);
                const optionClass = isCorrect ? 'test-option correct' : 'test-option';
                previewHTML += `
                    <div class="${optionClass}">
                        ${i + 1}. ${escapeHTML(opt)} ${isCorrect ? '‚úÖ' : ''}
                    </div>
                `;
            });

            previewHTML += `
                    </div>
                </div>
            `;

            preview.innerHTML = previewHTML;
        }

        // ========== ZARZƒÑDZANIE ODPOWIEDZIAMI ==========
        let optionsCount = 2; // Start z 2 odpowiedziami
        const MIN_OPTIONS = 2;
        const MAX_OPTIONS = 10;

        function addOption() {
            if (optionsCount >= MAX_OPTIONS) {
                showToast(`Maksymalnie ${MAX_OPTIONS} odpowiedzi!`, "warning");
                return;
            }
            optionsCount++;
            renderOptions();
            updateLivePreview();
        }

        function removeOption(index) {
            if (optionsCount <= MIN_OPTIONS) {
                showToast(`Musisz mieƒá co najmniej ${MIN_OPTIONS} odpowiedzi!`, "warning");
                return;
            }
            optionsCount--;
            renderOptions();
            updateLivePreview();
        }

        function renderOptions() {
            const container = document.getElementById("options-container");
            const addBtn = document.getElementById("addOptionBtn");
            if (!container) return;

            container.innerHTML = "";

            for (let i = 0; i < optionsCount; i++) {
                const div = document.createElement("div");
                div.className = "option-row";

                const questionType = document.getElementById("questionType") ? document.getElementById("questionType").value : "single";
                const inputType = questionType === "single" ? "radio" : "checkbox";
                const nameAttr = questionType === "single" ? "correctRadio" : `correct${i}`;

                div.innerHTML = `
                    <input type="text" id="option${i}" placeholder="Odpowied≈∫ ${i + 1}" style="flex: 1; margin: 0;" oninput="window.updateLivePreview()">
                    <input type="${inputType}" id="correct${i}" name="${nameAttr}" data-index="${i}" style="width: 18px; height: 18px; cursor: pointer;" onchange="window.updateLivePreview(); window.handleCorrectSelection('${questionType}', ${i})">
                    <label for="correct${i}" style="margin: 0; font-size: 18px; color: #28a745; cursor: pointer; user-select: none;">‚úì</label>
                    <button type="button" class="option-remove-btn" onclick="window.removeOption(${i})">üóëÔ∏è</button>
                `;
                container.appendChild(div);
            }

            // Zablokuj przycisk dodawania je≈õli osiƒÖgniƒôto limit
            if (addBtn) {
                addBtn.disabled = optionsCount >= MAX_OPTIONS;
            }
        }

        function handleQuestionTypeChange() {
            const questionType = document.getElementById("questionType").value;
            const optionsContainer = document.querySelector(".form-group:has(#options-container)");
            const orderingContainer = document.getElementById("ordering-steps-container");

            if (questionType === "ordering") {
                // Ukryj zwyk≈Çe odpowiedzi, poka≈º ordering steps
                optionsContainer.style.display = "none";
                orderingContainer.classList.remove("hidden");
                // Initialize ordering steps if empty
                if (document.querySelectorAll("#ordering-steps .ordering-step-row").length === 0) {
                    addOrderingStep();
                    addOrderingStep();
                }
            } else {
                // Poka≈º zwyk≈Çe odpowiedzi, ukryj ordering steps
                optionsContainer.style.display = "block";
                orderingContainer.classList.add("hidden");
                renderOptions(); // Prze≈Çaduj aby zmieniƒá radio/checkbox
            }
            updateLivePreview();
        }

        function handleCorrectSelection(type, selectedIndex) {
            if (type === "single") {
                // Dla radio - automatycznie odznacza inne, ale upewnijmy siƒô
                updateLivePreview();
            } else {
                // Dla checkbox - nic specjalnego
                updateLivePreview();
            }
        }

        function getOptionsData() {
            const options = [];
            const correct = [];
            const questionType = document.getElementById("questionType").value;

            for (let i = 0; i < optionsCount; i++) {
                const opt = document.getElementById(`option${i}`).value.trim();
                if (opt) {
                    options.push(opt);
                    const isCorrect = document.getElementById(`correct${i}`).checked;
                    if (isCorrect) correct.push(i + 1); // 1-based index
                }
            }

            return { options, correct };
        }

        function loadOptionsData(options, correctAnswers) {
            optionsCount = options.length;

            // Najpierw wyrenderuj puste pola
            renderOptions();

            // Potem w nastƒôpnym cyklu za≈Çaduj warto≈õci (gdy DOM jest ju≈º gotowy)
            requestAnimationFrame(() => {
                // Za≈Çaduj warto≈õci odpowiedzi
                options.forEach((opt, i) => {
                    const input = document.getElementById(`option${i}`);
                    if (input && opt !== undefined) {
                        input.value = opt;
                    }
                });

                // Za≈Çaduj zaznaczenia poprawnych odpowiedzi
                correctAnswers.forEach(correctIdx => {
                    const checkbox = document.getElementById(`correct${correctIdx - 1}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });

                // Aktualizuj podglƒÖd po za≈Çadowaniu
                updateLivePreview();
            });
        }

        // ========== ORDERING STEPS FUNCTIONS ==========
        let orderingStepsCount = 0;
        const MAX_ORDERING_STEPS = 8;

        window.addOrderingStep = function () {
            const container = document.getElementById("ordering-steps");
            const currentCount = document.querySelectorAll("#ordering-steps .ordering-step-row").length;

            if (currentCount >= MAX_ORDERING_STEPS) {
                showToast("Maksymalna liczba krok√≥w to 8!", "warning");
                return;
            }

            const stepDiv = document.createElement("div");
            stepDiv.className = "ordering-step-row";
            stepDiv.dataset.stepIndex = currentCount;
            stepDiv.innerHTML = `
                <span class="ordering-step-number">${currentCount + 1}.</span>
                <input type="text" id="ordering-step-${currentCount}" placeholder="Wpisz krok..." required>
                <div class="ordering-step-actions">
                    <button type="button" class="btn-danger" onclick="window.removeOrderingStep(${currentCount})" title="Usu≈Ñ krok">üóëÔ∏è</button>
                </div>
            `;

            container.appendChild(stepDiv);
            updateLivePreview();
        };

        window.removeOrderingStep = function (index) {
            const container = document.getElementById("ordering-steps");
            const rows = container.querySelectorAll(".ordering-step-row");

            if (rows.length <= 2) {
                showToast("Minimum 2 kroki sƒÖ wymagane!", "warning");
                return;
            }

            const rowToRemove = container.querySelector(`.ordering-step-row[data-step-index="${index}"]`);
            if (rowToRemove) {
                rowToRemove.remove();
                // Renumber remaining steps
                renumberOrderingSteps();
                updateLivePreview();
            }
        };

        function renumberOrderingSteps() {
            const container = document.getElementById("ordering-steps");
            const rows = container.querySelectorAll(".ordering-step-row");

            rows.forEach((row, i) => {
                const numberSpan = row.querySelector(".ordering-step-number");
                const input = row.querySelector("input[type='text']");
                const deleteBtn = row.querySelector("button");

                numberSpan.textContent = `${i + 1}.`;
                row.dataset.stepIndex = i;

                // Update input ID
                input.id = `ordering-step-${i}`;

                // Update delete button onclick
                deleteBtn.onclick = () => window.removeOrderingStep(i);
            });
        }

        function getOrderingStepsData() {
            const steps = [];
            const rows = document.querySelectorAll("#ordering-steps .ordering-step-row");

            rows.forEach(row => {
                const input = row.querySelector("input[type='text']");
                const value = input.value.trim();
                if (value) {
                    steps.push(value);
                }
            });

            return steps;
        }

        function loadOrderingStepsData(steps) {
            const container = document.getElementById("ordering-steps");
            container.innerHTML = ""; // Clear existing steps

            steps.forEach((step, index) => {
                const stepDiv = document.createElement("div");
                stepDiv.className = "ordering-step-row";
                stepDiv.dataset.stepIndex = index;
                stepDiv.innerHTML = `
                    <span class="ordering-step-number">${index + 1}.</span>
                    <input type="text" id="ordering-step-${index}" value="${escapeHTML(step)}" placeholder="Wpisz krok..." required>
                    <div class="ordering-step-actions">
                        <button type="button" class="btn-danger" onclick="window.removeOrderingStep(${index})" title="Usu≈Ñ krok">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(stepDiv);
            });
        }

        // ========== PYTANIA ==========
        function showAddQuestionForm() {
            document.getElementById("add-question-form").classList.remove("hidden");
            // Zainicjuj 2 odpowiedzi przy pierwszym otwarciu
            if (!document.getElementById("options-container").hasChildNodes()) {
                optionsCount = 2;
                renderOptions();
            }
        }

        function hideAddQuestionForm() {
            document.getElementById("add-question-form").classList.add("hidden");
            document.getElementById("questionForm").reset();
            editingQuestionId = null;
            currentTags = [];
            renderTags();
            document.getElementById("form-title").textContent = "Nowe pytanie";

            // Reset WYSIWYG
            document.getElementById("questionEditor").innerHTML = "";
            document.getElementById("explanationEditor").innerHTML = "";
            document.getElementById("questionText").value = "";
            document.getElementById("explanation").value = "";

            // Reset odpowiedzi do 2
            optionsCount = 2;
            renderOptions();

            // Reset obrazu
            currentImageData = null;
            document.getElementById("imagePreviewContainer").style.display = "none";
            document.getElementById("imagePreview").src = "";
            document.getElementById("imageSizeInfo").textContent = "";

            // Reset podglƒÖdu
            document.getElementById("live-preview").innerHTML = `
                <p style="color: #999; text-align: center; padding: 20px;">
                    Wype≈Çnij formularz aby zobaczyƒá podglƒÖd pytania...
                </p>
            `;
        }

        document.getElementById("questionForm").addEventListener("submit", function (e) {
            e.preventDefault();

            // Pobierz dane z WYSIWYG
            const text = getWYSIWYGContent('questionEditor').trim();
            const explanationHTML = getWYSIWYGContent('explanationEditor').trim();
            const type = document.getElementById("questionType").value;

            // Walidacja tre≈õci pytania
            if (!text) {
                showToast("Musisz podaƒá tre≈õƒá pytania!", "error");
                return;
            }

            let options, correct, orderingSteps;

            // Pobierz odpowiednie dane w zale≈ºno≈õci od typu
            if (type === "ordering") {
                // Dla ordering - pobierz kroki
                orderingSteps = getOrderingStepsData();
                if (orderingSteps.length < 2) {
                    showToast("Musisz podaƒá co najmniej 2 kroki!", "error");
                    return;
                }
                // Dla ordering u≈ºywamy kroki jako options, correct to [1,2,3...] (kolejno≈õƒá)
                options = [...orderingSteps];
                correct = orderingSteps.map((_, i) => i + 1);
            } else {
                // Dla single/multiple - pobierz odpowiedzi
                const optionsData = getOptionsData();
                options = optionsData.options;
                correct = optionsData.correct;

                if (options.length < 2) {
                    showToast("Musisz podaƒá co najmniej 2 odpowiedzi!", "error");
                    return;
                }

                if (correct.length === 0) {
                    showToast("Musisz wskazaƒá co najmniej jednƒÖ poprawnƒÖ odpowied≈∫!", "error");
                    return;
                }
            }

            const category = document.getElementById("questionCategory").value.trim();
            const tags = [...currentTags]; // Copy current tags

            if (editingQuestionId) {
                const index = questions.findIndex(q => q.id === editingQuestionId);
                if (index !== -1) {
                    questions[index] = {
                        id: editingQuestionId,
                        text,
                        type,
                        options,
                        correct,
                        category: category,
                        tags: tags,
                        explanation: explanationHTML,
                        imageData: currentImageData || questions[index].imageData  // Zachowaj stary je≈õli nie nowy
                    };
                    showToast("Pytanie zaktualizowane!", "success");
                }
            } else {
                questions.push({
                    id: Date.now() + Math.random(),
                    text,
                    type,
                    options,
                    correct,
                    category: category,
                    tags: tags,
                    explanation: explanationHTML,
                    imageData: currentImageData  // Dodaj obraz je≈õli jest
                });
                showToast("Pytanie dodane!", "success");
            }

            safeSetItem("quizQuestions", JSON.stringify(questions));
            updateCategorySelects();
            hideAddQuestionForm();
            renderQuestions();
            updateDashboard();
        });

        function renderQuestions() {
            cleanQuestionsData();
            const container = document.getElementById("questions-list");
            container.innerHTML = "";

            // Use filtered questions or all questions
            const questionsToRender = filteredQuestionsForPagination.length > 0 ? filteredQuestionsForPagination : questions;
            const totalQuestions = questionsToRender.length;

            document.getElementById("questionsCount").textContent = questions.length;

            // Sprawd≈∫ uprawnienia do edycji
            const canEdit = users[currentUser] && (users[currentUser].isAdmin || users[currentUser].canEditQuestions);

            if (totalQuestions === 0) {
                container.innerHTML = "<p>Brak pyta≈Ñ w bazie.</p>";
                document.getElementById("pagination-container").classList.add("hidden");
                return;
            }

            // Calculate pagination
            const totalPages = Math.ceil(totalQuestions / questionsItemsPerPage);
            if (questionsCurrentPage > totalPages) {
                questionsCurrentPage = totalPages;
            }
            if (questionsCurrentPage < 1) {
                questionsCurrentPage = 1;
            }

            const startIndex = (questionsCurrentPage - 1) * questionsItemsPerPage;
            const endIndex = Math.min(startIndex + questionsItemsPerPage, totalQuestions);
            const paginatedQuestions = questionsToRender.slice(startIndex, endIndex);

            // Render questions for current page
            paginatedQuestions.forEach(q => {
                const div = document.createElement("div");
                div.className = "question-item";
                const buttonsHTML = canEdit ? `
                    <button onclick="window.editQuestion(${q.id})" class="btn-primary">‚úèÔ∏è Edytuj</button>
                    <button onclick="window.deleteQuestion(${q.id})" class="btn-danger">üóëÔ∏è Usu≈Ñ</button>
                ` : '<p style="color: #6c757d; font-size: 0.9em; margin-top: 10px;">üîí Tylko do odczytu - brak uprawnie≈Ñ do edycji</p>';

                // Dla ordering - wy≈õwietlaj kroki w inny spos√≥b
                let optionsHTML = '';
                if (q.type === "ordering") {
                    optionsHTML = `
                        <div class="ordering-correct-sequence">
                            <strong>Prawid≈Çowa kolejno≈õƒá:</strong>
                            <ol style="margin: 10px 0 0 20px;">
                                ${(q.options || []).map(opt => `<li>${escapeHTML(opt)}</li>`).join('')}
                            </ol>
                        </div>
                    `;
                } else {
                    optionsHTML = `
                        <ul class="question-options">
                            ${(q.options || []).map((opt, i) => `
                                <li style="color: ${(q.correct || []).includes(i + 1) ? 'green' : 'inherit'}">
                                    ${i + 1}. ${escapeHTML(opt)} ${(q.correct || []).includes(i + 1) ? '‚úÖ' : ''}
                                </li>
                            `).join("")}
                        </ul>
                    `;
                }

                div.innerHTML = `
                    <h4>${q.markedForReview ? '‚≠ê ' : ''}${getQuestionTypeLabel(q.type)}</h4>
                    ${q.category ? `<span class="category-badge">üìÅ ${escapeHTML(q.category)}</span>` : ""}
                    ${q.tags && q.tags.length > 0 ? (q.tags || []).map(tag => `<span class="tag">üè∑Ô∏è ${escapeHTML(tag)}</span>`).join("") : ""}
                    ${q.markedForReview ? '<span class="tag" style="background: #ffc107; color: #000;">üîÑ Do powt√≥rki</span>' : ''}
                    <div style="margin-top: 10px;"><strong>Pytanie:</strong></div>
                    ${(q.imageData && q.imageData.startsWith('data:')) ? `<img src="${q.imageData}" loading="lazy" style="max-width: 100%; max-height: 400px; margin: 10px 0; border-radius: 8px; border: 2px solid #ddd; display: block;" alt="Obraz do pytania">` : ''}
                    <div style="white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; margin: 5px 0;">${sanitizeHTML(q.text)}</div>
                    ${q.explanation ? `<div class="explanation-box"><strong>üí° Wyja≈õnienie:</strong> ${sanitizeHTML(q.explanation)}</div>` : ""}
                    ${optionsHTML}
                    ${buttonsHTML}
                `;
                container.appendChild(div);
            });

            // Update pagination controls
            updatePaginationControls(totalQuestions, startIndex, endIndex, totalPages);
        }

        function updatePaginationControls(totalQuestions, startIndex, endIndex, totalPages) {
            const paginationContainer = document.getElementById("pagination-container");

            if (totalQuestions <= questionsItemsPerPage) {
                paginationContainer.classList.add("hidden");
                return;
            }

            paginationContainer.classList.remove("hidden");

            // Update info text
            document.getElementById("pagination-info-text").textContent =
                `Pokazano ${startIndex + 1}-${endIndex} z ${totalQuestions}`;

            // Update button states
            document.getElementById("btn-first").disabled = questionsCurrentPage === 1;
            document.getElementById("btn-prev").disabled = questionsCurrentPage === 1;
            document.getElementById("btn-next").disabled = questionsCurrentPage === totalPages;
            document.getElementById("btn-last").disabled = questionsCurrentPage === totalPages;

            // Update page numbers
            renderPageNumbers(totalPages);
        }

        function renderPageNumbers(totalPages) {
            const pageNumbersContainer = document.getElementById("page-numbers");
            pageNumbersContainer.innerHTML = "";

            // Show at most 5 page numbers
            let startPage = Math.max(1, questionsCurrentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);

            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }

            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement("button");
                btn.className = "pagination-btn";
                btn.textContent = i;
                if (i === questionsCurrentPage) {
                    btn.classList.add("active");
                }
                btn.onclick = () => goToPage(i);
                pageNumbersContainer.appendChild(btn);
            }
        }

        window.firstPage = function () {
            questionsCurrentPage = 1;
            renderQuestions();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.previousPage = function () {
            if (questionsCurrentPage > 1) {
                questionsCurrentPage--;
                renderQuestions();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        window.nextPage = function () {
            const totalQuestions = filteredQuestionsForPagination.length > 0 ? filteredQuestionsForPagination : questions;
            const totalPages = Math.ceil(totalQuestions.length / questionsItemsPerPage);
            if (questionsCurrentPage < totalPages) {
                questionsCurrentPage++;
                renderQuestions();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        window.lastPage = function () {
            const totalQuestions = filteredQuestionsForPagination.length > 0 ? filteredQuestionsForPagination : questions;
            const totalPages = Math.ceil(totalQuestions.length / questionsItemsPerPage);
            questionsCurrentPage = totalPages;
            renderQuestions();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.goToPage = function (pageNum) {
            questionsCurrentPage = pageNum;
            renderQuestions();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.changeItemsPerPage = function () {
            const select = document.getElementById("itemsPerPage");
            questionsItemsPerPage = parseInt(select.value);
            questionsCurrentPage = 1; // Reset to first page
            renderQuestions();
        };

        function getQuestionTypeLabel(type) {
            if (type === "single") return "Jedna poprawna odpowied≈∫";
            if (type === "multiple") return "Wiele poprawnych odpowiedzi";
            if (type === "ordering") return "U≈Ç√≥≈º w kolejno≈õci";
            return type;
        }

        function deleteQuestion(id) {
            if (confirm("Czy na pewno chcesz usunƒÖƒá to pytanie?")) {
                questions = questions.filter(q => q.id !== id);
                safeSetItem("quizQuestions", JSON.stringify(questions));
                renderQuestions();
                updateDashboard();
            }
        }

        function editQuestion(id) {
            const question = questions.find(q => q.id === id);
            if (!question) {
                showToast("Nie znaleziono pytania!", "error");
                return;
            }

            editingQuestionId = id;

            // Za≈Çaduj typ pytania
            document.getElementById("questionType").value = question.type;

            // Za≈Çaduj tre≈õƒá pytania do WYSIWYG
            setWYSIWYGContent('questionEditor', question.text || '');

            // Za≈Çaduj odpowiedzi lub kroki ordering
            if (question.type === "ordering") {
                loadOrderingStepsData(question.options || []);
            } else {
                loadOptionsData(question.options || [], question.correct || []);
            }

            // Za≈Çaduj wyja≈õnienie do WYSIWYG
            setWYSIWYGContent('explanationEditor', question.explanation || '');

            // Load category
            document.getElementById("questionCategory").value = question.category || "";

            // Load tags
            currentTags = (question.tags || []).slice(); // Copy tags
            renderTags();

            // Load image
            currentImageData = question.imageData || null;
            if (currentImageData) {
                document.getElementById("imagePreview").src = currentImageData;
                document.getElementById("imagePreviewContainer").style.display = "block";
                document.getElementById("imageSizeInfo").textContent = "Obraz za≈Çadowany z pytania";
            } else {
                document.getElementById("imagePreviewContainer").style.display = "none";
                document.getElementById("imagePreview").src = "";
                document.getElementById("imageSizeInfo").textContent = "";
            }

            document.getElementById("form-title").textContent = "Edytuj pytanie";

            // Trigger handleQuestionTypeChange to show/hide correct UI
            handleQuestionTypeChange();

            // Aktualizuj podglƒÖd
            updateLivePreview();

            // Rozwi≈Ñ sekcjƒô "Dodaj/edytuj pytanie" je≈õli jest zamkniƒôta
            const addQuestionContent = document.getElementById("add-question-content");
            const addQuestionIcon = document.getElementById("add-question-icon");
            if (addQuestionContent && addQuestionContent.classList.contains("hidden")) {
                addQuestionContent.classList.remove("hidden");
                if (addQuestionIcon) {
                    addQuestionIcon.textContent = "‚ñ≤";
                }
            }

            // Poka≈º formularz i przewi≈Ñ do niego
            showAddQuestionForm();
            document.getElementById("add-question-form").scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ========== IMPORT/EXPORT ==========
        function exportQuestions() {
            cleanQuestionsData();

            const selectedCategory = document.getElementById("exportCategorySelect").value;
            const questionsToExport = selectedCategory === "all" ?
                questions :
                questions.filter(q => (q.category || "") === selectedCategory);

            if (questionsToExport.length === 0) {
                showToast("Brak pyta≈Ñ do eksportu w wybranej kategorii!", "warning");
                return;
            }

            // Rozszerzony format CSV z kategoriƒÖ i tagami
            let csv = "typ,pytanie,kategoria,tagi,odp1,odp2,odp3,odp4,odp5,poprawne,wyja≈õnienie\n";

            questionsToExport.forEach(q => {
                const opts = q.options || [];
                const escape = (str) => (str || "").replace(/"/g, '""');
                csv += `${q.type},"${escape(q.text)}","${escape(q.category || "")}","${escape((q.tags || []).join(';'))}","${escape(opts[0] || '')}","${escape(opts[1] || '')}","${escape(opts[2] || '')}","${escape(opts[3] || '')}","${escape(opts[4] || '')}",${(q.correct || []).join(";")},"${escape(q.explanation || "")}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);

            // Nazwa pliku z kategoriƒÖ
            let filename = "pytania";
            if (selectedCategory !== "all") {
                filename = selectedCategory.replace(/[^a-zA-Z0-9]/g, "_");
            }
            filename += "_" + new Date().toISOString().slice(0, 10) + ".csv";

            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);

            showToast(`Wyeksportowano ${questionsToExport.length} pyta≈Ñ!`, "success");
        }

        function exportQuestionsJSON() {
            cleanQuestionsData();

            const selectedCategory = document.getElementById("exportCategorySelectJSON").value;

            // Filtrowanie po kategorii
            let questionsToExport = questions;
            if (selectedCategory !== "all") {
                questionsToExport = questions.filter(q => (q.category || "") === selectedCategory);
            }

            if (questionsToExport.length === 0) {
                alert("Brak pyta≈Ñ do eksportu w wybranej kategorii!");
                return;
            }

            // Struktura JSON z metadanymi
            const exportData = {
                version: "1.0",
                exportDate: new Date().toISOString(),
                category: selectedCategory,
                totalQuestions: questionsToExport.length,
                questions: questionsToExport.map(q => ({
                    id: q.id,
                    type: q.type,
                    text: q.text,
                    options: q.options || [],
                    correct: q.correct || [],
                    category: q.category || "",
                    tags: q.tags || [],
                    explanation: q.explanation || "",
                    imageData: q.imageData || ""
                }))
            };

            // Konwersja do JSON z formatowaniem
            const json = JSON.stringify(exportData, null, 2);

            // Utw√≥rz blob i pobierz
            const blob = new Blob([json], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);

            // Nazwa pliku z kategoriƒÖ
            let filename = "pytania";
            if (selectedCategory !== "all") {
                filename = selectedCategory.replace(/[^a-zA-Z0-9]/g, "_");
            }
            filename += "_" + new Date().toISOString().slice(0, 10) + ".json";

            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);

            alert(`Wyeksportowano ${questionsToExport.length} pyta≈Ñ do JSON!`);
        }

        // ========== ENHANCED EXPORT - PDF & EXCEL ==========
        // Export to PDF (using browser print)
        function exportQuestionsPDF() {
            cleanQuestionsData();

            const selectedCategory = document.getElementById("exportCategorySelect").value;

            // Filtrowanie po kategorii
            let questionsToExport = questions;
            if (selectedCategory !== "all") {
                questionsToExport = questions.filter(q => (q.category || "") === selectedCategory);
            }

            if (questionsToExport.length === 0) {
                alert("Brak pyta≈Ñ do eksportu w wybranej kategorii!");
                return;
            }

            // Create printable HTML
            const printWindow = window.open('', '_blank');
            const categoryLabel = selectedCategory === "all" ? "Wszystkie kategorie" : selectedCategory;

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Quiz - ${categoryLabel}</title>
                    <style>
                        body {
                            font-family: 'Georgia', serif;
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 20px;
                            line-height: 1.6;
                        }
                        h1 {
                            text-align: center;
                            color: #333;
                            border-bottom: 2px solid #333;
                            padding-bottom: 10px;
                        }
                        .meta {
                            text-align: center;
                            color: #666;
                            margin-bottom: 30px;
                        }
                        .question {
                            page-break-inside: avoid;
                            margin-bottom: 25px;
                            padding: 15px;
                            border: 1px solid #ddd;
                            border-radius: 5px;
                        }
                        .question-header {
                            font-weight: bold;
                            color: #2563eb;
                            margin-bottom: 10px;
                        }
                        .category-badge {
                            display: inline-block;
                            background: #e0e7ff;
                            padding: 2px 8px;
                            border-radius: 3px;
                            font-size: 12px;
                            margin-bottom: 10px;
                        }
                        .options {
                            margin: 10px 0;
                            padding-left: 20px;
                        }
                        .options li {
                            margin: 5px 0;
                        }
                        .correct {
                            color: #059669;
                            font-weight: bold;
                        }
                        .explanation {
                            margin-top: 10px;
                            padding: 10px;
                            background: #fef3c7;
                            border-radius: 5px;
                            font-style: italic;
                        }
                        @media print {
                            body { padding: 0; }
                            .question { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <h1>üìù Quiz - ${categoryLabel}</h1>
                    <div class="meta">
                        <p>Data eksportu: ${new Date().toLocaleDateString('pl-PL')}</p>
                        <p>Liczba pyta≈Ñ: ${questionsToExport.length}</p>
                    </div>
                    ${questionsToExport.map((q, i) => `
                        <div class="question">
                            ${q.category ? `<span class="category-badge">üìÅ ${escapeHTML(q.category)}</span>` : ''}
                            <div class="question-header">Pytanie ${i + 1}</div>
                            <div>${sanitizeHTML(q.text)}</div>
                            <ul class="options">
                                ${(q.options || []).map((opt, idx) => {
                const isCorrect = (q.correct || []).includes(idx + 1);
                return `<li class="${isCorrect ? 'correct' : ''}">${idx + 1}. ${escapeHTML(opt)}${isCorrect ? ' ‚úì' : ''}</li>`;
            }).join('')}
                            </ul>
                            ${q.explanation ? `<div class="explanation">üí° Wyja≈õnienie: ${escapeHTML(q.explanation)}</div>` : ''}
                        </div>
                    `).join('')}
                    \x3Cscript>
                        // Auto-print on load
                        window.onload = function() {
                            window.print();
                        };
                    \x3C/script>
                \x3C/body>
                \x3C/html>
            `);
            printWindow.document.close();
        }

        // Export to Excel (HTML table format)
        function exportQuestionsExcel() {
            cleanQuestionsData();

            const selectedCategory = document.getElementById("exportCategorySelect").value;

            // Filtrowanie po kategorii
            let questionsToExport = questions;
            if (selectedCategory !== "all") {
                questionsToExport = questions.filter(q => (q.category || "") === selectedCategory);
            }

            if (questionsToExport.length === 0) {
                alert("Brak pyta≈Ñ do eksportu w wybranej kategorii!");
                return;
            }

            // Create HTML table for Excel
            let excelHTML = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">
                <head>
                    <meta charset="UTF-8">
                    <!--[if gte mso 9]>
                    <xml>
                        <x:ExcelWorkbook>
                            <x:ExcelWorksheets>
                                <x:ExcelWorksheet>
                                    <x:Name>Quiz</x:Name>
                                    <x:WorksheetOptions>
                                        <x:DisplayGridlines/>
                                    </x:WorksheetOptions>
                                </x:ExcelWorksheet>
                            </x:ExcelWorksheets>
                        </x:ExcelWorkbook>
                    </xml>
                    <![endif]-->
                    <style>
                        table {
                            border-collapse: collapse;
                        }
                        td, th {
                            border: 1px solid #ccc;
                            padding: 5px;
                            font-size: 12px;
                        }
                        th {
                            background-color: #4CAF50;
                            color: white;
                            font-weight: bold;
                        }
                        .correct {
                            background-color: #d4edda;
                            font-weight: bold;
                        }
                        .category {
                            background-color: #e3f2fd;
                        }
                    </style>
                </head>
                <body>
                    <table>
                        <thead>
                            <tr>
                                <th>Nr</th>
                                <th>Typ</th>
                                <th>Kategoria</th>
                                <th>Pytanie</th>
                                <th>Odp 1</th>
                                <th>Odp 2</th>
                                <th>Odp 3</th>
                                <th>Odp 4</th>
                                <th>Odp 5</th>
                                <th>Poprawne</th>
                                <th>Wyja≈õnienie</th>
                                <th>Tagi</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${questionsToExport.map((q, i) => {
                const opts = q.options || [];
                const correct = (q.correct || []).join(', ');
                return `
                                    <tr>
                                        <td>${i + 1}</td>
                                        <td>${q.type || 'single'}</td>
                                        <td class="category">${escapeHTML(q.category || '')}</td>
                                        <td>${escapeHTML(q.text || '')}</td>
                                        <td class="${q.correct?.includes(1) ? 'correct' : ''}">${escapeHTML(opts[0] || '')}</td>
                                        <td class="${q.correct?.includes(2) ? 'correct' : ''}">${escapeHTML(opts[1] || '')}</td>
                                        <td class="${q.correct?.includes(3) ? 'correct' : ''}">${escapeHTML(opts[2] || '')}</td>
                                        <td class="${q.correct?.includes(4) ? 'correct' : ''}">${escapeHTML(opts[3] || '')}</td>
                                        <td class="${q.correct?.includes(5) ? 'correct' : ''}">${escapeHTML(opts[4] || '')}</td>
                                        <td>${correct}</td>
                                        <td>${escapeHTML(q.explanation || '')}</td>
                                        <td>${escapeHTML((q.tags || []).join(', '))}</td>
                                    </tr>
                                `;
            }).join('')}
                        </tbody>
                    </table>
                \x3C/body>
                \x3C/html>
            `;

            // Create blob and download
            const blob = new Blob([excelHTML], { type: 'application/vnd.ms-excel;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);

            let filename = "pytania";
            if (selectedCategory !== "all") {
                filename = selectedCategory.replace(/[^a-zA-Z0-9]/g, "_");
            }
            filename += "_" + new Date().toISOString().slice(0, 10) + ".xls";

            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);

            alert(`Wyeksportowano ${questionsToExport.length} pyta≈Ñ do Excel!`);
        }

        // Export user results to CSV
        function exportUserResultsCSV() {
            if (!currentUser || !users[currentUser]) {
                alert("Musisz byƒá zalogowany!");
                return;
            }

            const results = users[currentUser].testResults || [];
            if (results.length === 0) {
                alert("Brak wynik√≥w do eksportu!");
                return;
            }

            let csv = "Data,Tryb,Wynik (%),Poprawne,B≈ÇƒÖdne,≈ÅƒÖcznie\n";

            results.forEach(r => {
                const date = new Date(r.date).toLocaleDateString('pl-PL');
                csv += `${date},${r.mode || 'test'},${r.score},${r.correct},${r.total - r.correct},${r.total}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `wyniki_${currentUser}_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            URL.revokeObjectURL(link.href);

            alert(`Wyeksportowano ${results.length} wynik√≥w!`);
        }

        // Make functions available globally
        window.exportQuestionsPDF = exportQuestionsPDF;
        window.exportQuestionsExcel = exportQuestionsExcel;
        window.exportUserResultsCSV = exportUserResultsCSV;
        window.toggleDarkMode = toggleDarkMode;

        function importQuestions(event) {
            const file = document.getElementById("importFile").files[0];
            if (!file) {
                alert("Wybierz plik do importu!");
                return;
            }

            const categoryChoice = document.getElementById("importCategorySelect").value;
            if (!categoryChoice) {
                alert("Wybierz kategoriƒô do przypisania!");
                return;
            }

            let targetCategory = categoryChoice;
            if (categoryChoice === "new") {
                targetCategory = document.getElementById("newCategoryName").value.trim();
                if (!targetCategory) {
                    alert("Podaj nazwƒô nowej kategorii!");
                    return;
                }
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                // === AUTOMATYCZNY BACKUP PRZED IMPORTEM ===
                const backupTimestamp = new Date().toISOString();
                const backupKey = `quizQuestions_backup_${backupTimestamp}`;
                safeSetItem(backupKey, JSON.stringify(questions));
                console.log("‚úÖ Utworzono backup: " + backupKey);

                const records = parseCSV(e.target.result);

                // ========== POTWIERDZENIE PRZED IMPORTEM CSV ==========
                if (records.length <= 1) {  // Tylko nag≈Ç√≥wek lub pusty
                    alert("‚ö†Ô∏è Plik CSV jest pusty lub zawiera tylko nag≈Ç√≥wek!");
                    return;
                }

                const estimatedImportCount = records.length - 1;  // minus nag≈Ç√≥wek
                const currentCount = questions.length;

                const confirmed = confirm(
                    `üì• Import pyta≈Ñ z CSV\n\n` +
                    `üìä Aktualnie w bazie: ${currentCount} pyta≈Ñ\n` +
                    `üì• Do importu: ~${estimatedImportCount} pyta≈Ñ (szacunkowo)\n` +
                    `üì¶ Po imporcie: ~${currentCount + estimatedImportCount} pyta≈Ñ\n\n` +
                    `‚úÖ Automatyczny backup zostanie utworzony przed importem.\n` +
                    `‚ÑπÔ∏è Duplikaty (wg ID lub tre≈õci) zostanƒÖ pominiƒôte.\n\n` +
                    `Czy kontynuowaƒá import?`
                );

                if (!confirmed) {
                    alert("‚ùå Import anulowany.");
                    return;
                }

                let imported = 0;
                let errors = 0;

                // Sprawd≈∫ czy plik ma nowy format
                const hasNewFormat = records.length > 0 && records[0].length >= 11;

                // Pomi≈Ñ nag≈Ç√≥wek (indeks 0)
                for (let i = 1; i < records.length; i++) {
                    const parts = records[i];

                    if (hasNewFormat && parts.length >= 11) {
                        // Nowy format: typ,pytanie,kategoria,tagi,odp1,odp2,odp3,odp4,odp5,poprawne,wyja≈õnienie
                        const type = parts[0].trim();
                        const questionText = parts[1].trim();
                        const fileCategory = parts[2] ? parts[2].trim() : "";
                        const fileTags = parts[3] ? parts[3].trim().split(';').filter(t => t.trim()) : [];
                        const options = [];
                        const correct = [];

                        for (let j = 4; j <= 8; j++) {
                            const opt = parts[j] ? parts[j].trim() : "";
                            if (opt) options.push(opt);
                        }

                        const correctStr = parts[9].trim();
                        const correctIndices = correctStr.split(';').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
                        correctIndices.forEach(idx => {
                            if (idx > 0 && idx <= options.length) {
                                correct.push(idx);
                            }
                        });

                        const explanation = parts[10] ? parts[10].trim() : "";

                        let finalCategory = "";
                        if (categoryChoice === "keep") {
                            finalCategory = fileCategory;
                        } else {
                            finalCategory = targetCategory;
                        }

                        if (questionText && options.length >= 2 && correct.length > 0) {
                            const newQ = {
                                id: Date.now() + i,
                                type: type,
                                text: questionText,
                                options: options,
                                correct: correct,
                                category: finalCategory,
                                tags: fileTags,
                                explanation: explanation
                            };

                            if (isValidQuestion(newQ)) {
                                questions.push(newQ);
                                imported++;
                            } else {
                                errors++;
                            }
                        } else {
                            errors++;
                        }
                    } else if (parts.length >= 8) {
                        // Stary format
                        const type = parts[0].trim();
                        const questionText = parts[1].trim();
                        const options = [];
                        const correct = [];

                        for (let j = 2; j <= 6; j++) {
                            const opt = parts[j] ? parts[j].trim() : "";
                            if (opt) options.push(opt);
                        }

                        const correctStr = parts[7].trim();
                        const correctIndices = correctStr.split(';').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
                        correctIndices.forEach(idx => {
                            if (idx > 0 && idx <= options.length) {
                                correct.push(idx);
                            }
                        });

                        if (questionText && options.length >= 2 && correct.length > 0) {
                            const newQ = {
                                id: Date.now() + i,
                                type: type,
                                text: questionText,
                                options: options,
                                correct: correct,
                                category: categoryChoice === "keep" ? "" : targetCategory,
                                tags: [],
                                explanation: ""
                            };

                            if (isValidQuestion(newQ)) {
                                questions.push(newQ);
                                imported++;
                            } else {
                                errors++;
                            }
                        } else {
                            errors++;
                        }
                    } else {
                        errors++;
                    }
                }

                safeSetItem("quizQuestions", JSON.stringify(questions));
                updateCategorySelects();

                alert(`‚úÖ Import zako≈Ñczony!\n\nüìä Pomy≈õlnie zaimportowano: ${imported}\n‚ùå B≈Çƒôdy: ${errors}\n\nüíæ Automatyczny backup utworzony przed importem.\nüîë Klucz backup'u: ${backupKey}`);

                // Reset
                document.getElementById("importFile").value = "";
                renderQuestions();
                updateDashboard();
            };

            reader.readAsText(file, "UTF-8");
        }

        function importQuestionsJSON() {
            const file = document.getElementById("importJSONFile").files[0];
            if (!file) {
                alert("Wybierz plik JSON do importu!");
                return;
            }

            const importMode = document.getElementById("importJSONMode").value;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    // === AUTOMATYCZNY BACKUP PRZED IMPORTEM ===
                    const backupTimestamp = new Date().toISOString();
                    const backupKey = `quizQuestions_backup_${backupTimestamp}`;
                    safeSetItem(backupKey, JSON.stringify(questions));
                    console.log("‚úÖ Utworzono backup: " + backupKey);

                    // Parsuj JSON
                    const jsonData = JSON.parse(e.target.result);

                    // Walidacja struktury
                    if (!jsonData.questions || !Array.isArray(jsonData.questions)) {
                        alert("Nieprawid≈Çowy format JSON! Brak tablicy 'questions'.");
                        return;
                    }

                    // ========== POTWIERDZENIE PRZED REPLACE ==========
                    if (importMode === "replace") {
                        const currentCount = questions.length;
                        const importCount = jsonData.questions.length;

                        const confirmed = confirm(
                            `‚ö†Ô∏è CZY NA PEWNO CHCESZ ZASTƒÑPIƒÜ WSZYSTKIE PYTANIA?\n\n` +
                            `üìä Aktualnie w bazie: ${currentCount} pyta≈Ñ\n` +
                            `üì• Do importu: ${importCount} pyta≈Ñ\n` +
                            `üì¶ Po imporcie: ${importCount} pyta≈Ñ (wszystkie obecne zostanƒÖ usuniƒôte)\n\n` +
                            `‚úÖ Automatyczny backup zostanie utworzony przed importem.\n\n` +
                            `Czy na pewno chcesz kontynuowaƒá?`
                        );

                        if (!confirmed) {
                            alert("‚ùå Import anulowany.");
                            return;
                        }
                    }

                    // Tryb "replace" - usu≈Ñ wszystkie pytania
                    if (importMode === "replace") {
                        questions = [];
                    }

                    let imported = 0;
                    let errors = 0;
                    const skipped = [];

                    // Importuj pytania
                    jsonData.questions.forEach((q, index) => {
                        // Walidacja struktury pojedynczego pytania
                        if (!q.text || !q.options || !Array.isArray(q.options) || !q.correct) {
                            console.warn("Nieprawid≈Çowa struktura pytania #" + (index + 1), q);
                            errors++;
                            return;
                        }

                        if (q.options.length < 2) {
                            console.warn("Pytanie #" + (index + 1) + " ma mniej ni≈º 2 odpowiedzi");
                            errors++;
                            return;
                        }

                        if (!Array.isArray(q.correct) || q.correct.length === 0) {
                            console.warn("Pytanie #" + (index + 1) + " nie ma poprawnych odpowiedzi");
                            errors++;
                            return;
                        }

                        // Sprawd≈∫ czy pytanie ju≈º istnieje (po ID lub tre≈õci)
                        const exists = questions.some(existing =>
                            (existing.id === q.id) ||
                            (existing.text === q.text && JSON.stringify(existing.options) === JSON.stringify(q.options))
                        );

                        if (exists) {
                            skipped.push(index + 1);
                            return;
                        }

                        // Utw√≥rz nowe pytanie
                        const newQ = {
                            id: q.id || Date.now() + Math.random(),
                            type: q.type || "single",
                            text: q.text,
                            options: q.options,
                            correct: q.correct,
                            category: q.category || "",
                            tags: q.tags || [],
                            explanation: q.explanation || "",
                            imageData: q.imageData || ""
                        };

                        if (isValidQuestion(newQ)) {
                            questions.push(newQ);
                            imported++;
                        } else {
                            errors++;
                        }
                    });

                    // Zapisz do localStorage
                    safeSetItem("quizQuestions", JSON.stringify(questions));
                    updateCategorySelects();
                    renderQuestions();
                    updateDashboard();

                    // Reset
                    document.getElementById("importJSONFile").value = "";

                    // Podsumowanie
                    let message = `‚úÖ Import JSON zako≈Ñczony!\n\n`;
                    message += `üì¶ Zaimportowano: ${imported} pyta≈Ñ\n`;
                    if (skipped.length > 0) {
                        message += `‚è≠Ô∏è Pominiƒôto (duplikaty): ${skipped.length} pyta≈Ñ\n`;
                    }
                    if (errors > 0) {
                        message += `‚ùå B≈Çƒôdy: ${errors} pyta≈Ñ\n`;
                    }
                    message += `\n≈ÅƒÖcznie pyta≈Ñ w bazie: ${questions.length}`;

                    alert(message);

                } catch (error) {
                    console.error("B≈ÇƒÖd importu JSON:", error);
                    alert("B≈ÇƒÖd podczas importu JSON: " + error.message + "\n\nUpewnij siƒô ≈ºe plik ma prawid≈Çowy format JSON!");
                }
            };

            reader.onerror = function () {
                alert("B≈ÇƒÖd podczas odczytu pliku!");
            };

            reader.readAsText(file, "UTF-8");
        }

        // Obs≈Çuga zmiany kategorii przy imporcie
        document.addEventListener("DOMContentLoaded", function () {
            const importCatSelect = document.getElementById("importCategorySelect");
            if (importCatSelect) {
                importCatSelect.addEventListener("change", function () {
                    const newCatInput = document.getElementById("newCategoryInput");
                    if (this.value === "new") {
                        newCatInput.classList.remove("hidden");
                    } else {
                        newCatInput.classList.add("hidden");
                    }
                });
            }
        });

        // Parser CSV obs≈ÇugujƒÖcy cudzys≈Çowy i wielolinijkowe pola
        function parseCSV(text) {
            const records = [];
            let currentRecord = [];
            let currentField = '';
            let insideQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];

                if (char === '"') {
                    if (insideQuotes && nextChar === '"') {
                        // Podw√≥jny cudzys≈Ç√≥w = escape
                        currentField += '"';
                        i++; // Pomi≈Ñ nastƒôpny cudzys≈Ç√≥w
                    } else {
                        // Prze≈ÇƒÖcz stan cudzys≈Çow√≥w
                        insideQuotes = !insideQuotes;
                    }
                } else if (char === ',' && !insideQuotes) {
                    // Koniec pola
                    currentRecord.push(currentField);
                    currentField = '';
                } else if ((char === '\r' || char === '\n') && !insideQuotes) {
                    // Koniec rekordu
                    if (currentField || currentRecord.length > 0) {
                        currentRecord.push(currentField);
                    }
                    if (currentRecord.length > 0) {
                        records.push(currentRecord);
                    }
                    currentRecord = [];
                    currentField = '';

                    // Pomi≈Ñ \r w \r\n
                    if (char === '\r' && nextChar === '\n') {
                        i++;
                    }
                } else {
                    currentField += char;
                }
            }

            // Dodaj ostatni rekord
            if (currentField || currentRecord.length > 0) {
                currentRecord.push(currentField);
            }
            if (currentRecord.length > 0) {
                records.push(currentRecord);
            }

            return records;
        }

        // ========== TEST ==========
        function startTest() {
            cleanQuestionsData();

            // Ukryj bottom nav na mobile podczas testu
            document.body.classList.add('in-test');

            if (questions.length === 0) {
                alert("Brak pyta≈Ñ w bazie!");
                return;
            }

            // Filtrowanie po kategorii
            const selectedCategory = document.getElementById("testCategory").value;
            let filteredQuestions = selectedCategory === "all" ?
                [...questions] :
                questions.filter(q => (q.category || "") === selectedCategory);

            if (filteredQuestions.length === 0) {
                alert("Brak pyta≈Ñ w wybranej kategorii!");
                return;
            }

            const count = document.getElementById("questionCount").value;
            currentTestQuestions = count === "all" ?
                filteredQuestions :
                [...filteredQuestions].sort(() => Math.random() - 0.5).slice(0, parseInt(count));

            // Losowanie kolejno≈õci odpowiedzi (je≈õli wybrano)
            const randomizeAnswers = document.getElementById("randomizeAnswers").checked;
            currentTestQuestions.forEach(q => {
                // Dla ordering - ZAWSZE losuj kolejno≈õƒá krok√≥w (inaczej pytanie nie ma sensu)
                // Dla single/multiple - losuj tylko je≈õli checkbox jest zaznaczony
                const shouldShuffle = (q.type === "ordering") || (randomizeAnswers && q.options && q.options.length > 1);

                if (shouldShuffle) {
                    // Stw√≥rz tablicƒô indeks√≥w [0, 1, 2, ...]
                    const indices = q.options.map((_, i) => i);
                    // Pomieszaj indeksy (Fisher-Yates shuffle)
                    for (let i = indices.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [indices[i], indices[j]] = [indices[j], indices[i]];
                    }
                    // Zapisz pomieszane opcje i mapowanie
                    q._shuffledOptions = indices.map(i => q.options[i]);
                    q._shuffledToOriginal = indices; // shuffled[i] = original[indices[i]]
                }
            });

            currentQuestionIndex = 0;
            userAnswers = {};

            document.getElementById("test-setup").classList.add("hidden");
            document.getElementById("test-interface").classList.remove("hidden");
            document.getElementById("totalTestQuestions").textContent = currentTestQuestions.length;

            // Start timer if enabled
            const enableTimer = document.getElementById("enableTimer").checked;
            if (enableTimer) {
                const timerMinutes = parseInt(document.getElementById("timerMinutes").value) || 30;
                startTestTimer(timerMinutes);
            } else {
                // Hide timer display if timer is not enabled
                document.getElementById("testTimerDisplay").classList.add("hidden");
            }

            renderCurrentQuestion();
        }

        function renderCurrentQuestion() {
            const q = currentTestQuestions[currentQuestionIndex];

            document.getElementById("currentQuestionNumber").textContent = currentQuestionIndex + 1;
            document.getElementById("progressBar").style.width = ((currentQuestionIndex + 1) / currentTestQuestions.length * 100) + "%";

            // U≈ºyj pomieszanych opcji lub oryginalnych
            const optionsToRender = q._shuffledOptions || q.options || [];

            // Dla ordering - generuj specjalny interfejs
            if (q.type === "ordering") {
                renderOrderingQuestion(q, optionsToRender);
            } else {
                document.getElementById("test-question-container").innerHTML = `
                    <div class="test-question">
                        ${(q.imageData && q.imageData.startsWith('data:')) ? `<img src="${q.imageData}" loading="lazy" style="max-width: 100%; max-height: 400px; margin: 0 auto 20px auto; border-radius: 8px; border: 2px solid #ddd; display: block;" alt="Obraz do pytania">` : ''}
                        <div class="question-text">${sanitizeHTML(q.text)}</div>
                        <div class="test-options">
                            ${optionsToRender.map((opt, i) => `
                                <div class="test-option" onclick="window.selectOption(${i}, '${q.type}')">${i + 1}. ${escapeHTML(opt)}</div>
                            `).join("")}
                        </div>
                    </div>
                `;
            }

            if (userAnswers[currentQuestionIndex] && q.type !== "ordering") {
                userAnswers[currentQuestionIndex].forEach(idx => {
                    document.querySelectorAll(".test-option")[idx].classList.add("selected");
                });
            }
        }

        function renderOrderingQuestion(q, options) {
            const currentAnswer = userAnswers[currentQuestionIndex] || {};
            // U≈ºyj pomieszanych opcji je≈õli dostƒôpne, w przeciwnym razie oryginalne
            const steps = q._shuffledOptions || q.options || [];

            // Generuj dropdown options (1, 2, 3...)
            const stepCount = steps.length;
            const dropdownOptions = Array.from({ length: stepCount }, (_, i) =>
                `<option value="${i + 1}">${i + 1}</option>`
            ).join('');

            const html = `
                <div class="test-question">
                    ${(q.imageData && q.imageData.startsWith('data:')) ? `<img src="${q.imageData}" loading="lazy" style="max-width: 100%; max-height: 400px; margin: 0 auto 20px auto; border-radius: 8px; border: 2px solid #ddd; display: block;" alt="Obraz do pytania">` : ''}
                    <div class="question-text">${sanitizeHTML(q.text)}</div>
                    <div class="ordering-test-item">
                        <p class="ordering-instruction">U≈Ç√≥≈º kroki w odpowiedniej kolejno≈õci:</p>
                        ${steps.map((step, i) => {
                // Zapisz odpowied≈∫ po shuffled index (0-based), ale wy≈õwietl jako 1-based
                const selectedValue = currentAnswer[i] || '';
                return `
                                <div class="ordering-test-row">
                                    <span class="ordering-step-number">${i + 1}.</span>
                                    <span class="ordering-test-step-text">${escapeHTML(step)}</span>
                                    <select onchange="window.selectOrderingOption(${i}, this.value)">
                                        <option value="">-- Wybierz --</option>
                                        ${dropdownOptions}
                                    </select>
                                </div>
                            `;
            }).join('')}
                    </div>
                </div>
            `;

            document.getElementById("test-question-container").innerHTML = html;
        }

        window.selectOrderingOption = function (shuffledIndex, position) {
            if (!userAnswers[currentQuestionIndex]) {
                userAnswers[currentQuestionIndex] = {};
            }
            // Zapisz po shuffled index (0-based)
            userAnswers[currentQuestionIndex][shuffledIndex] = position === '' ? null : parseInt(position);
        };

        function selectOption(idx, type) {
            const options = document.querySelectorAll(".test-option");
            const q = currentTestQuestions[currentQuestionIndex];

            // Je≈õli opcje sƒÖ pomieszane, zamie≈Ñ wybrany indeks na oryginalny
            let originalIdx = idx;
            if (q._shuffledToOriginal) {
                originalIdx = q._shuffledToOriginal[idx];
            }

            if (type === "single") {
                // Convert index (0, 1, 2...) to 1-based number (1, 2, 3...)
                userAnswers[currentQuestionIndex] = [originalIdx + 1];
                options.forEach((opt, i) => {
                    opt.classList.toggle("selected", i === idx);
                });
            } else {
                if (!userAnswers[currentQuestionIndex]) userAnswers[currentQuestionIndex] = [];

                // Convert index to 1-based number (using original index)
                const optionNumber = originalIdx + 1;
                if (userAnswers[currentQuestionIndex].includes(optionNumber)) {
                    userAnswers[currentQuestionIndex] = userAnswers[currentQuestionIndex].filter(i => i !== optionNumber);
                    options[idx].classList.remove("selected");
                } else {
                    userAnswers[currentQuestionIndex].push(optionNumber);
                    options[idx].classList.add("selected");
                }
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderCurrentQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentTestQuestions.length - 1) {
                currentQuestionIndex++;
                renderCurrentQuestion();
            }
        }

        function finishTest() {
            // Poka≈º bottom nav po zako≈Ñczeniu testu
            document.body.classList.remove('in-test');

            // Stop timer if running
            stopTestTimer();

            let correct = 0;
            let detailedAnswers = [];

            currentTestQuestions.forEach((q, i) => {
                let isCorrect = false;
                let ans = userAnswers[i] || [];
                let isSkipped = false;

                if (q.type === "ordering") {
                    // Dla ordering - sprawdz czy kolejno≈õƒá jest poprawna
                    // ans jest obiektem {shuffledIndex: position}
                    // correct to [1,2,3,4...] (kolejno≈õƒá krok√≥w w oryginalnej kolejno≈õci)

                    const steps = q._shuffledOptions || q.options || [];
                    let allCorrect = true;
                    let hasAnswer = false;

                    for (let shuffledIdx = 0; shuffledIdx < steps.length; shuffledIdx++) {
                        const position = ans[shuffledIdx];

                        if (position === undefined || position === null || position === '') {
                            allCorrect = false;
                        } else {
                            hasAnswer = true;
                            // Znajd≈∫ original index dla tego shuffled step
                            let originalIdx = shuffledIdx;
                            if (q._shuffledToOriginal) {
                                originalIdx = q._shuffledToOriginal[shuffledIdx];
                            }

                            // Sprawdz czy krok originalIdx jest na pozycji position
                            // czyli czy correct[originalIdx] == position
                            if (q.correct[originalIdx] !== position) {
                                allCorrect = false;
                            }
                        }
                    }

                    isCorrect = allCorrect && hasAnswer;
                    isSkipped = !hasAnswer;
                } else {
                    // Dla single/multiple
                    const sortedAns = [...ans].sort((a, b) => a - b);
                    const sortedCorrect = [...(q.correct || [])].sort((a, b) => a - b);
                    isCorrect = JSON.stringify(sortedAns) === JSON.stringify(sortedCorrect);
                    isSkipped = ans.length === 0;
                }

                if (isCorrect) correct++;

                // Zapisz szczeg√≥≈Çowe informacje o pytaniu i odpowiedzi
                detailedAnswers.push({
                    questionId: q.id,
                    questionText: q.text,
                    questionType: q.type,
                    options: q.options || [],
                    correctAnswers: q.correct || [],
                    userAnswers: ans,
                    isCorrect: isCorrect,
                    isSkipped: isSkipped,
                    explanation: q.explanation || "",
                    category: q.category || "",
                    tags: q.tags || []
                });
            });

            const pct = (correct / currentTestQuestions.length * 100).toFixed(1);

            if (currentUser && users[currentUser]) {
                if (!users[currentUser].testResults) users[currentUser].testResults = [];
                users[currentUser].testResults.push({
                    date: new Date().toISOString(),
                    score: pct,
                    correct: correct,
                    total: currentTestQuestions.length,
                    mode: "test",
                    detailedAnswers: detailedAnswers
                });
                safeSetItem("quizUsers", JSON.stringify(users));
            }

            alert(`Wynik: ${correct}/${currentTestQuestions.length} (${pct}%)`);

            document.getElementById("test-setup").classList.remove("hidden");
            document.getElementById("test-interface").classList.add("hidden");

            showSection("results");
        }

        // ========== TRYB NAUKI ==========
        function startPractice() {
            cleanQuestionsData();

            // Ukryj bottom nav na mobile podczas nauki
            document.body.classList.add('in-practice');

            if (questions.length === 0) {
                showToast("Brak pyta≈Ñ w bazie!", "error");
                return;
            }

            // Filtrowanie po kategorii
            const selectedCategory = document.getElementById("practiceCategory").value;
            let filteredQuestions = selectedCategory === "all" ?
                [...questions] :
                questions.filter(q => (q.category || "") === selectedCategory);

            if (filteredQuestions.length === 0) {
                showToast("Brak pyta≈Ñ w wybranej kategorii!", "error");
                return;
            }

            // Walidacja pyta≈Ñ - usu≈Ñ niekompletne
            const validQuestions = filteredQuestions.filter(q => {
                // Podstawowe pola wymagane
                if (!q || !q.text || !q.type) return false;
                if (!q.options || !Array.isArray(q.options) || q.options.length === 0) return false;
                if (!q.correct) return false;

                // Sprawd≈∫ czy options majƒÖ tre≈õƒá
                const hasValidOptions = q.options.every(opt => opt && opt.trim() !== "");
                if (!hasValidOptions) return false;

                return true;
            });

            // Zaloguj ostrze≈ºenie je≈õli wykryto nieprawid≈Çowe pytania
            if (validQuestions.length !== filteredQuestions.length) {
                console.warn(`Wyfiltrowano ${filteredQuestions.length - validQuestions.length} nieprawid≈Çowych pyta≈Ñ`);
            }

            filteredQuestions = validQuestions;

            const count = document.getElementById("practiceQuestionCount").value;

            // Priorytetowe pokazywanie oznaczonych do powt√≥rki
            const markedQuestions = filteredQuestions.filter(q => q.markedForReview);
            const otherQuestions = filteredQuestions.filter(q => !q.markedForReview);

            if (count === "all") {
                // Wszystkie pytania - oznaczone na poczƒÖtku
                practiceQuestions = [...markedQuestions, ...otherQuestions];
            } else {
                const limit = parseInt(count);

                // Je≈õli oznaczonych jest mniej ni≈º limit, dope≈Çnij resztƒÖ
                if (markedQuestions.length >= limit) {
                    practiceQuestions = markedQuestions.slice(0, limit);
                } else {
                    practiceQuestions = [...markedQuestions];
                    const remaining = limit - markedQuestions.length;
                    // Losuj z pozosta≈Çych
                    const shuffledOthers = [...otherQuestions].sort(() => Math.random() - 0.5);
                    practiceQuestions = [...practiceQuestions, ...shuffledOthers.slice(0, remaining)];
                }
            }

            // Losowanie kolejno≈õci odpowiedzi (je≈õli wybrano)
            const randomizeAnswers = document.getElementById("randomizeAnswersPractice").checked;
            practiceQuestions.forEach(q => {
                // Dla ordering - ZAWSZE losuj kolejno≈õƒá krok√≥w (inaczej pytanie nie ma sensu)
                // Dla single/multiple - losuj tylko je≈õli checkbox jest zaznaczony
                const shouldShuffle = (q.type === "ordering") || (randomizeAnswers && q.options && q.options.length > 1);

                if (shouldShuffle) {
                    // Stw√≥rz tablicƒô indeks√≥w [0, 1, 2, ...]
                    const indices = q.options.map((_, i) => i);
                    // Pomieszaj indeksy (Fisher-Yates shuffle)
                    for (let i = indices.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [indices[i], indices[j]] = [indices[j], indices[i]];
                    }
                    // Zapisz pomieszane opcje i mapowanie
                    q._shuffledOptions = indices.map(i => q.options[i]);
                    q._shuffledToOriginal = indices; // shuffled[i] = original[indices[i]]
                }
            });

            practiceQuestionIndex = 0;
            practiceCorrect = 0;
            practiceIncorrect = 0;
            practiceAnswered = false;
            practiceUserAnswers = []; // Reset user answers

            document.getElementById("practice-setup").classList.add("hidden");
            document.getElementById("practice-interface").classList.remove("hidden");
            document.getElementById("practiceTotalQuestions").textContent = practiceQuestions.length;

            renderPracticeQuestion();
        }

        function renderPracticeQuestion() {
            // Ochrona przed indeksem poza zakresem
            if (practiceQuestionIndex < 0 || practiceQuestionIndex >= practiceQuestions.length) {
                console.error("Nieprawid≈Çowy indeks pytania:", practiceQuestionIndex);
                finishPractice();
                return;
            }

            const q = practiceQuestions[practiceQuestionIndex];

            // Walidacja pytania
            if (!q || !q.text || !q.options) {
                console.error("Nieprawid≈Çowe dane pytania:", q);
                showToast("B≈ÇƒÖd danych pytania. Przechodzƒô do nastƒôpnego.", "error");
                nextPracticeQuestion();
                return;
            }

            practiceAnswered = false;
            practiceSelectedAnswers = []; // Reset selected answers

            // Dla ordering - reset do obiektu
            if (q.type === "ordering") {
                practiceSelectedAnswers = {};
            }

            document.getElementById("practiceCurrentNumber").textContent = practiceQuestionIndex + 1;
            document.getElementById("practiceCorrect").textContent = practiceCorrect;
            document.getElementById("practiceIncorrect").textContent = practiceIncorrect;

            // Bookmark button - show star icon if marked
            const isMarked = q.markedForReview || false;
            const notesCount = getQuestionNotes(q.id)?.length || 0;
            const bookmarkButton = `
                <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                    <button onclick="window.toggleBookmarkInPractice('${q.id}')" class="bookmark-btn ${isMarked ? 'active' : ''}" style="background: ${isMarked ? 'var(--warning-color)' : 'transparent'}; border: 2px solid ${isMarked ? 'var(--warning-color)' : 'var(--border-color)'}; color: ${isMarked ? 'white' : 'var(--text-light)'}; padding: 8px 16px; border-radius: var(--border-radius); cursor: pointer; display: inline-flex; align-items: center; gap: 6px; font-size: var(--text-sm); font-weight: var(--font-medium); transition: var(--transition-smooth);">
                        ${isMarked ? '‚≠ê' : '‚òÜ'} ${isMarked ? 'Oznaczone' : 'Oznacz do powt√≥rki'}
                    </button>
                    <button onclick="window.openNotesModal('${q.id}')" class="notes-btn" style="background: transparent; border: 2px solid var(--border-color); color: var(--text-light); padding: 8px 16px; border-radius: var(--border-radius); cursor: pointer; display: inline-flex; align-items: center; gap: 6px; font-size: var(--text-sm); font-weight: var(--font-medium); transition: var(--transition-smooth);">
                        üìù Notatki ${notesCount > 0 ? `(${notesCount})` : ''}
                    </button>
                </div>
            `;

            // U≈ºyj pomieszanych opcji lub oryginalnych
            const optionsToRender = q._shuffledOptions || q.options || [];

            // Dla ordering - u≈ºyj specjalnego renderera
            if (q.type === "ordering") {
                renderPracticeOrderingQuestion(q, optionsToRender, bookmarkButton);
            } else {
                document.getElementById("practice-question-container").innerHTML = `
                    ${bookmarkButton}
                    <div class="test-question">
                        ${(q.imageData && q.imageData.startsWith('data:')) ? `<img src="${q.imageData}" loading="lazy" style="max-width: 100%; max-height: 400px; margin: 0 auto 20px auto; border-radius: 8px; border: 2px solid #ddd; display: block;" alt="Obraz do pytania">` : ''}
                        <div class="question-text">${sanitizeHTML(q.question || q.text || "")}</div>
                        <div class="test-options">
                            ${optionsToRender.map((opt, i) => `
                                <div class="test-option" onclick="window.togglePracticeOption(${i})">${i + 1}. ${escapeHTML(opt)}</div>
                            `).join("")}
                        </div>
                    </div>
                `;
            }

            document.getElementById("practice-feedback").innerHTML = `
                <button class="btn-success" onclick="window.checkPracticeAnswer()" style="margin-top: 15px; width: 100%;">‚úÖ Sprawd≈∫ odpowied≈∫</button>
            `;
        }

        function renderPracticeOrderingQuestion(q, options, bookmarkButton) {
            // U≈ºyj pomieszanych opcji je≈õli dostƒôpne, w przeciwnym razie oryginalne
            const steps = q._shuffledOptions || q.options || [];
            const stepCount = steps.length;

            // Generuj dropdown options
            const dropdownOptions = Array.from({ length: stepCount }, (_, i) =>
                `<option value="${i + 1}">${i + 1}</option>`
            ).join('');

            const html = `
                ${bookmarkButton}
                <div class="test-question">
                    ${(q.imageData && q.imageData.startsWith('data:')) ? `<img src="${q.imageData}" loading="lazy" style="max-width: 100%; max-height: 400px; margin: 0 auto 20px auto; border-radius: 8px; border: 2px solid #ddd; display: block;" alt="Obraz do pytania">` : ''}
                    <div class="question-text">${sanitizeHTML(q.question || q.text || "")}</div>
                    <div class="ordering-test-item">
                        <p class="ordering-instruction">U≈Ç√≥≈º kroki w odpowiedniej kolejno≈õci:</p>
                        ${steps.map((step, i) => `
                            <div class="ordering-test-row">
                                <span class="ordering-step-number">${i + 1}.</span>
                                <span class="ordering-test-step-text">${escapeHTML(step)}</span>
                                <select onchange="window.selectPracticeOrderingOption(${i}, this.value)">
                                    <option value="">-- Wybierz --</option>
                                    ${dropdownOptions}
                                </select>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            document.getElementById("practice-question-container").innerHTML = html;
        }

        window.selectPracticeOrderingOption = function (shuffledIndex, position) {
            if (practiceAnswered) return;
            if (!practiceSelectedAnswers || typeof practiceSelectedAnswers !== 'object') {
                practiceSelectedAnswers = {};
            }
            // Zapisz po shuffled index (0-based)
            practiceSelectedAnswers[shuffledIndex] = position === '' ? null : parseInt(position);
        };

        function togglePracticeOption(idx) {
            if (practiceAnswered) return;

            const options = document.querySelectorAll("#practice-question-container .test-option");

            // Ochrona przed brakiem pytania
            if (practiceQuestionIndex < 0 || practiceQuestionIndex >= practiceQuestions.length) {
                console.error("Nieprawid≈Çowy indeks pytania w togglePracticeOption");
                return;
            }

            const q = practiceQuestions[practiceQuestionIndex];

            if (!q) {
                console.error("Brak danych pytania w togglePracticeOption");
                return;
            }

            // Je≈õli opcje sƒÖ pomieszane, zamie≈Ñ wybrany indeks na oryginalny
            let originalIdx = idx;
            if (q._shuffledToOriginal) {
                originalIdx = q._shuffledToOriginal[idx];
            }

            if (q.type === "single") {
                // Dla pyta≈Ñ jednokrotnego wyboru - usu≈Ñ poprzednie zaznaczenie
                practiceSelectedAnswers = [originalIdx + 1];
                options.forEach((opt, i) => {
                    opt.classList.toggle("selected", i === idx);
                });
            } else {
                // Dla pyta≈Ñ wielokrotnego wyboru - prze≈ÇƒÖcz zaznaczenie
                const optionNumber = originalIdx + 1;
                if (practiceSelectedAnswers.includes(optionNumber)) {
                    practiceSelectedAnswers = practiceSelectedAnswers.filter(i => i !== optionNumber);
                    options[idx].classList.remove("selected");
                } else {
                    practiceSelectedAnswers.push(optionNumber);
                    options[idx].classList.add("selected");
                }
            }
        }

        function checkPracticeAnswer() {
            if (practiceAnswered) return;

            // Ochrona przed brakiem pytania
            if (practiceQuestionIndex < 0 || practiceQuestionIndex >= practiceQuestions.length) {
                console.error("Nieprawid≈Çowy indeks pytania w checkPracticeAnswer");
                return;
            }

            const q = practiceQuestions[practiceQuestionIndex];

            if (!q || !q.type) {
                console.error("Brak danych pytania w checkPracticeAnswer");
                return;
            }

            // Dla ordering - inna walidacja
            if (q.type === "ordering") {
                checkPracticeOrderingAnswer(q);
                return;
            }

            // Sprawd≈∫ czy u≈ºytkownik wybra≈Ç jakƒÖ≈õ odpowied≈∫
            if (practiceSelectedAnswers.length === 0) {
                alert("Wybierz przynajmniej jednƒÖ odpowied≈∫!");
                return;
            }

            practiceAnswered = true;

            const options = document.querySelectorAll("#practice-question-container .test-option");

            // Sortuj odpowiedzi dla por√≥wnania
            const sortedSelected = [...practiceSelectedAnswers].sort((a, b) => a - b);
            const sortedCorrect = [...(q.correct || [])].sort((a, b) => a - b);

            // Sprawd≈∫ czy odpowiedzi sƒÖ poprawne
            const isCorrect = JSON.stringify(sortedSelected) === JSON.stringify(sortedCorrect);

            // Zablokuj wszystkie opcje
            options.forEach(opt => opt.classList.add("disabled"));

            // Stw√≥rz mapowanie original ‚Üí shuffled dla DOM (1-based original ‚Üí 0-based DOM)
            const originalToDOMIndex = {};
            if (q._shuffledToOriginal) {
                q._shuffledToOriginal.forEach((origIdx, shuffledIdx) => {
                    originalToDOMIndex[origIdx + 1] = shuffledIdx;
                });
            } else {
                // Bez shuffla - original indeks (1-based) ‚Üí DOM (0-based)
                for (let i = 1; i <= options.length; i++) {
                    originalToDOMIndex[i] = i - 1;
                }
            }

            // Poka≈º wynik
            if (isCorrect) {
                practiceCorrect++;
                // Zaznacz poprawne odpowiedzi na zielono
                practiceSelectedAnswers.forEach(idx => {
                    const domIdx = originalToDOMIndex[idx];
                    if (domIdx !== undefined && options[domIdx]) {
                        options[domIdx].classList.add("correct");
                    }
                });

                let feedbackHTML = `<div class="feedback-box feedback-correct">‚úÖ Poprawna odpowied≈∫!</div>`;

                feedbackHTML += `<button class="btn-primary" onclick="window.nextPracticeQuestion()" style="margin-top: 10px;">‚û°Ô∏è Nastƒôpne pytanie</button>`;

                if (q.explanation && q.explanation.trim()) {
                    feedbackHTML += `<div class="explanation-box"><strong>üí° Wyja≈õnienie:</strong><br>${makeLinksClickable(q.explanation)}</div>`;
                }

                document.getElementById("practice-feedback").innerHTML = feedbackHTML;
            } else {
                practiceIncorrect++;
                // Zaznacz b≈Çƒôdne odpowiedzi na czerwono
                practiceSelectedAnswers.forEach(idx => {
                    const domIdx = originalToDOMIndex[idx];
                    if (domIdx !== undefined && options[domIdx]) {
                        if ((q.correct || []).includes(idx)) {
                            options[domIdx].classList.add("correct");
                        } else {
                            options[domIdx].classList.add("incorrect");
                        }
                    }
                });

                // Pod≈õwietl wszystkie poprawne odpowiedzi
                (q.correct || []).forEach(correctIdx => {
                    const domIdx = originalToDOMIndex[correctIdx];
                    if (domIdx !== undefined && options[domIdx]) {
                        options[domIdx].classList.add("correct");
                    }
                });

                // Oblicz indeksy poprawnych odpowiedzi widoczne dla u≈ºytkownika (uwzglƒôdniajƒÖc shuffle)
                let visibleCorrectIndices = [];
                if (q._shuffledToOriginal) {
                    // Je≈õli opcje sƒÖ pomieszane, zamie≈Ñ oryginalne indeksy na widoczne
                    const originalToShuffled = {};
                    q._shuffledToOriginal.forEach((origIdx, shuffledIdx) => {
                        originalToShuffled[origIdx] = shuffledIdx;
                    });
                    visibleCorrectIndices = (q.correct || []).map(origIdx => originalToShuffled[origIdx - 1] + 1).sort((a, b) => a - b);
                } else {
                    // Je≈õli nie sƒÖ pomieszane, u≈ºyj oryginalnych indeks√≥w
                    visibleCorrectIndices = [...(q.correct || [])].sort((a, b) => a - b);
                }

                // Utw√≥rz tekst z poprawnymi odpowiedziami
                const correctText = q.type === "single"
                    ? `Poprawna odpowied≈∫: ${visibleCorrectIndices[0]}`
                    : `Poprawne odpowiedzi: ${visibleCorrectIndices.join(", ")}`;

                let feedbackHTML = `<div class="feedback-box feedback-incorrect">‚ùå Niestety, to nie jest poprawna odpowied≈∫.</div>`;
                feedbackHTML += `<div class="feedback-box feedback-info">‚úÖ ${correctText}</div>`;

                feedbackHTML += `<button class="btn-primary" onclick="window.nextPracticeQuestion()" style="margin-top: 10px;">‚û°Ô∏è Nastƒôpne pytanie</button>`;

                if (q.explanation && q.explanation.trim()) {
                    feedbackHTML += `<div class="explanation-box"><strong>üí° Wyja≈õnienie:</strong><br>${makeLinksClickable(q.explanation)}</div>`;
                }

                document.getElementById("practice-feedback").innerHTML = feedbackHTML;
            }

            document.getElementById("practiceCorrect").textContent = practiceCorrect;
        }

        function checkPracticeOrderingAnswer(q) {
            const ans = practiceSelectedAnswers || {};
            // U≈ºyj pomieszanych opcji je≈õli dostƒôpne, w przeciwnym razie oryginalne
            const steps = q._shuffledOptions || q.options || [];
            let allCorrect = true;
            let hasAnswer = false;

            // Sprawd≈∫ czy wszystkie kroki sƒÖ poprawnie przypisane
            for (let shuffledIdx = 0; shuffledIdx < steps.length; shuffledIdx++) {
                const position = ans[shuffledIdx];

                if (position === undefined || position === null || position === '') {
                    allCorrect = false;
                } else {
                    hasAnswer = true;
                    // Znajd≈∫ original index dla tego shuffled step
                    let originalIdx = shuffledIdx;
                    if (q._shuffledToOriginal) {
                        originalIdx = q._shuffledToOriginal[shuffledIdx];
                    }

                    // Sprawdz czy krok originalIdx jest na pozycji position
                    if (q.correct[originalIdx] !== position) {
                        allCorrect = false;
                    }
                }
            }

            if (!hasAnswer) {
                alert("Wybierz kolejno≈õƒá dla wszystkich krok√≥w!");
                return;
            }

            practiceAnswered = true;
            const isCorrect = allCorrect;

            // U≈ºyj oryginalnych opcji do wy≈õwietlania poprawnej kolejno≈õci
            const originalSteps = q.options || [];

            if (isCorrect) {
                practiceCorrect++;
                let feedbackHTML = `<div class="feedback-box feedback-correct">‚úÖ Poprawna odpowied≈∫!</div>`;
                feedbackHTML += `<div class="explanation-box"><strong>üí° Prawid≈Çowa kolejno≈õƒá:</strong><ol>`;
                originalSteps.forEach(step => {
                    feedbackHTML += `<li>${escapeHTML(step)}</li>`;
                });
                feedbackHTML += `</ol></div>`;

                feedbackHTML += `<button class="btn-primary" onclick="window.nextPracticeQuestion()" style="margin-top: 10px;">‚û°Ô∏è Nastƒôpne pytanie</button>`;

                if (q.explanation && q.explanation.trim()) {
                    feedbackHTML += `<div class="explanation-box"><strong>üí° Wyja≈õnienie:</strong><br>${makeLinksClickable(q.explanation)}</div>`;
                }

                document.getElementById("practice-feedback").innerHTML = feedbackHTML;
            } else {
                practiceIncorrect++;
                let feedbackHTML = `<div class="feedback-box feedback-incorrect">‚ùå Niestety, to nie jest poprawna kolejno≈õƒá.</div>`;
                feedbackHTML += `<div class="feedback-box feedback-info">‚úÖ <strong>Prawid≈Çowa kolejno≈õƒá:</strong><ol>`;
                originalSteps.forEach(step => {
                    feedbackHTML += `<li>${escapeHTML(step)}</li>`;
                });
                feedbackHTML += `</ol></div>`;

                feedbackHTML += `<button class="btn-primary" onclick="window.nextPracticeQuestion()" style="margin-top: 10px;">‚û°Ô∏è Nastƒôpne pytanie</button>`;

                if (q.explanation && q.explanation.trim()) {
                    feedbackHTML += `<div class="explanation-box"><strong>üí° Wyja≈õnienie:</strong><br>${makeLinksClickable(q.explanation)}</div>`;
                }
                document.getElementById("practice-feedback").innerHTML = feedbackHTML;
            }

            document.getElementById("practiceCorrect").textContent = practiceCorrect;
            document.getElementById("practiceIncorrect").textContent = practiceIncorrect;
        }

        function nextPracticeQuestion() {
            // Ochrona przed pustƒÖ tablicƒÖ pyta≈Ñ
            if (!practiceQuestions || practiceQuestions.length === 0) {
                console.error("Brak pyta≈Ñ w trybie nauki");
                finishPractice();
                return;
            }

            if (practiceQuestionIndex < practiceQuestions.length - 1) {
                practiceQuestionIndex++;
                renderPracticeQuestion();
            } else {
                finishPractice();
            }
        }

        function finishPractice() {
            // Poka≈º bottom nav po zako≈Ñczeniu nauki
            document.body.classList.remove('in-practice');

            // Ochrona przed dzieleniem przez zero
            const totalQuestions = practiceQuestions.length || 1;
            const pct = totalQuestions > 0 ? (practiceCorrect / totalQuestions * 100).toFixed(1) : "0.0";

            if (currentUser && users[currentUser]) {
                if (!users[currentUser].testResults) users[currentUser].testResults = [];
                users[currentUser].testResults.push({
                    date: new Date().toISOString(),
                    score: pct,
                    correct: practiceCorrect,
                    total: practiceQuestions.length,
                    mode: "practice"
                });
                safeSetItem("quizUsers", JSON.stringify(users));
            }

            document.getElementById("practice-feedback").innerHTML = `
                <div class="feedback-box" style="background: #e7f3ff; color: #004085; border: 1px solid #b8daff;">
                    <h3>üéâ Sesja nauki zako≈Ñczona!</h3>
                    <p><strong>Wynik:</strong> ${practiceCorrect}/${practiceQuestions.length} (${pct}%)</p>
                    <p><strong>Poprawne:</strong> ${practiceCorrect}</p>
                    <p><strong>B≈Çƒôdne:</strong> ${practiceIncorrect}</p>
                    <button class="btn-primary" onclick="window.exitPractice()">üè† Wr√≥ƒá do menu</button>
                </div>
            `;
        }

        window.endPracticeEarly = function () {
            const totalQuestions = practiceQuestions.length;
            const questionsAnswered = practiceCorrect + practiceIncorrect;

            // Potwierdzenie przed zako≈Ñczeniem
            if (questionsAnswered > 0) {
                const confirmed = confirm(
                    `Czy na pewno chcesz zako≈Ñczyƒá sesjƒô nauki przedwcze≈õnie?\n\n` +
                    `üìä Postƒôp:\n` +
                    `‚Ä¢ Odpowiedziane pytania: ${questionsAnswered}/${totalQuestions}\n` +
                    `‚Ä¢ Poprawne: ${practiceCorrect}\n` +
                    `‚Ä¢ B≈Çƒôdne: ${practiceIncorrect}\n\n` +
                    `Wynik zostanie zapisany.`
                );

                if (!confirmed) {
                    return;
                }
            } else {
                const confirmed = confirm(
                    `Czy na pewno chcesz zako≈Ñczyƒá sesjƒô nauki?\n\n` +
                    `Nie odpowiedzia≈Çe≈õ jeszcze na ≈ºadne pytanie.`
                );

                if (!confirmed) {
                    return;
                }
            }

            // Oblicz wynik tylko dla odpowiedzianych pyta≈Ñ
            let pct, total, correct, incorrect;

            if (questionsAnswered > 0) {
                total = questionsAnswered;
                correct = practiceCorrect;
                incorrect = practiceIncorrect;
                pct = (correct / total * 100).toFixed(1);

                // Zapisz wynik tylko je≈õli odpowiedziano na przynajmniej 1 pytanie
                if (currentUser && users[currentUser]) {
                    if (!users[currentUser].testResults) users[currentUser].testResults = [];
                    users[currentUser].testResults.push({
                        date: new Date().toISOString(),
                        score: pct,
                        correct: correct,
                        total: total,
                        mode: "practice",
                        earlyExit: true // Oznacza przedwczesne zako≈Ñczenie
                    });
                    safeSetItem("quizUsers", JSON.stringify(users));
                }
            }

            // Poka≈º podsumowanie
            let summaryHTML = '';

            if (questionsAnswered > 0) {
                summaryHTML = `
                    <div class="feedback-box" style="background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;">
                        <h3>‚èπÔ∏è Sesja nauki zako≈Ñczona przedwcze≈õnie</h3>
                        <p><strong>Wynik:</strong> ${correct}/${total} (${pct}%)</p>
                        <p><strong>Poprawne:</strong> ${correct}</p>
                        <p><strong>B≈Çƒôdne:</strong> ${incorrect}</p>
                        <p style="font-size: 0.9em; color: #666;">Odpowiedziano na ${questionsAnswered} z ${totalQuestions} pyta≈Ñ</p>
                        <button class="btn-primary" onclick="window.exitPractice()">üè† Wr√≥ƒá do menu</button>
                    </div>
                `;
            } else {
                summaryHTML = `
                    <div class="feedback-box" style="background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;">
                        <h3>‚èπÔ∏è Sesja nauki zako≈Ñczona</h3>
                        <p>Nie odpowiedzia≈Çe≈õ na ≈ºadne pytanie.</p>
                        <button class="btn-primary" onclick="window.exitPractice()">üè† Wr√≥ƒá do menu</button>
                    </div>
                `;
            }

            document.getElementById("practice-feedback").innerHTML = summaryHTML;
        };

        function exitPractice() {
            document.getElementById("practice-interface").classList.add("hidden");
            document.getElementById("practice-setup").classList.remove("hidden");
            showSection("results");
        }

        // ========== BOOKMARKING SYSTEM ==========
        window.toggleBookmarkInPractice = function (questionId) {
            // Znajd≈∫ pytanie w tablicy questions
            const qIdx = questions.findIndex(q => q.id === questionId);
            if (qIdx === -1) {
                showToast("B≈ÇƒÖd: nie znaleziono pytania", "error");
                return;
            }

            // Prze≈ÇƒÖcz stan markedForReview
            questions[qIdx].markedForReview = !questions[qIdx].markedForReview;

            // Zapisz do localStorage
            safeSetItem("quizQuestions", JSON.stringify(questions));

            // Aktualizuj r√≥wnie≈º w practiceQuestions
            const practiceQIdx = practiceQuestions.findIndex(q => q.id === questionId);
            if (practiceQIdx !== -1) {
                practiceQuestions[practiceQIdx].markedForReview = questions[qIdx].markedForReview;
            }

            // Od≈õwie≈º widok
            renderPracticeQuestion();

            // Poka≈º powiadomienie
            const isMarked = questions[qIdx].markedForReview;
            showToast(isMarked ? '‚≠ê Pytanie oznaczone do powt√≥rki!' : 'Pytanie usuniƒôte z powt√≥rek', isMarked ? 'success' : 'info', 2000);
        };

        window.toggleBookmarkInQuestions = function (questionId) {
            const qIdx = questions.findIndex(q => q.id === questionId);
            if (qIdx === -1) return;

            questions[qIdx].markedForReview = !questions[qIdx].markedForReview;
            safeSetItem("quizQuestions", JSON.stringify(questions));

            // Od≈õwie≈º listƒô pyta≈Ñ
            renderQuestionsList();

            const isMarked = questions[qIdx].markedForReview;
            showToast(isMarked ? '‚≠ê Oznaczone do powt√≥rki!' : 'Usuniƒôte z powt√≥rek', isMarked ? 'success' : 'info', 2000);
        };

        // Get marked questions count
        function getMarkedQuestionsCount() {
            return questions.filter(q => q.markedForReview).length;
        }

        // ========== NOTES SYSTEM ==========
        // Get notes for a question
        function getQuestionNotes(questionId) {
            if (!currentUser || !users[currentUser]) return [];

            const userData = users[currentUser];
            if (!userData.questionNotes) {
                userData.questionNotes = {};
            }

            return userData.questionNotes[questionId] || [];
        }

        // Save a note for a question
        function saveQuestionNote(questionId, content) {
            if (!currentUser || !users[currentUser]) {
                showToast("Musisz byƒá zalogowany, aby dodawaƒá notatki", "error");
                return null;
            }

            if (!content || content.trim() === "") {
                showToast("Notatka nie mo≈ºe byƒá pusta", "error");
                return null;
            }

            const userData = users[currentUser];
            if (!userData.questionNotes) {
                userData.questionNotes = {};
            }

            if (!userData.questionNotes[questionId]) {
                userData.questionNotes[questionId] = [];
            }

            const note = {
                id: Date.now().toString(),
                content: content.trim(),
                timestamp: new Date().toISOString()
            };

            userData.questionNotes[questionId].push(note);
            safeSetItem("quizUsers", JSON.stringify(users));

            showToast("‚úÖ Notatka zapisana!", "success", 1500);
            return note;
        }

        // Delete a note
        function deleteQuestionNote(questionId, noteId) {
            if (!currentUser || !users[currentUser]) return;

            const userData = users[currentUser];
            if (!userData.questionNotes || !userData.questionNotes[questionId]) return;

            userData.questionNotes[questionId] = userData.questionNotes[questionId].filter(
                note => note.id !== noteId
            );

            safeSetItem("quizUsers", JSON.stringify(users));
            showToast("üóëÔ∏è Notatka usuniƒôta", "info", 1500);
        }

        // Format timestamp for display
        function formatNoteDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return "Przed chwilƒÖ";
            if (diffMins < 60) return `${diffMins} min. temu`;
            if (diffHours < 24) return `${diffHours} godz. temu`;
            if (diffDays < 7) return `${diffDays} dni temu`;

            return date.toLocaleDateString('pl-PL', {
                day: 'numeric',
                month: 'short',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });
        }

        // Variable to track current question for notes modal
        let currentNotesQuestionId = null;

        // Open notes modal
        window.openNotesModal = function (questionId) {
            currentNotesQuestionId = questionId;

            const question = questions.find(q => q.id === questionId);
            if (!question) {
                showToast("B≈ÇƒÖd: nie znaleziono pytania", "error");
                return;
            }

            // Display question text
            const questionText = question.question || question.text || "";
            document.getElementById("notes-question-text").textContent =
                questionText.length > 150 ? questionText.substring(0, 150) + "..." : questionText;

            // Render existing notes
            renderNotesList(questionId);

            // Clear input
            document.getElementById("note-input").value = "";

            // Show modal
            document.getElementById("notes-modal").style.display = "flex";
            document.body.style.overflow = "hidden";
        };

        // Close notes modal
        window.closeNotesModal = function () {
            document.getElementById("notes-modal").style.display = "none";
            document.body.style.overflow = "";
            currentNotesQuestionId = null;

            // Refresh practice view if open
            if (!document.getElementById("practice-interface").classList.contains("hidden")) {
                renderPracticeQuestion();
            }
        };

        // Save note from modal
        window.saveNoteFromModal = function () {
            if (!currentNotesQuestionId) return;

            const input = document.getElementById("note-input");
            const content = input.value.trim();

            if (!content) {
                showToast("Wpisz tre≈õƒá notatki", "error");
                return;
            }

            const note = saveQuestionNote(currentNotesQuestionId, content);
            if (note) {
                input.value = "";
                renderNotesList(currentNotesQuestionId);
            }
        };

        // Render notes list in modal
        function renderNotesList(questionId) {
            const notes = getQuestionNotes(questionId);
            const container = document.getElementById("notes-list");

            if (notes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                        <p>Brak notatek</p>
                        <p style="font-size: var(--text-sm);">Dodaj pierwszƒÖ notatkƒô do tego pytania</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = notes.map(note => `
                <div class="note-item">
                    <div class="note-item-content">${escapeHTML(note.content)}</div>
                    <div class="note-item-date">${formatNoteDate(note.timestamp)}</div>
                    <div class="note-item-actions">
                        <button class="note-item-delete" onclick="window.deleteNoteFromModal('${note.id}')">
                            üóëÔ∏è Usu≈Ñ
                        </button>
                    </div>
                </div>
            `).join("");
        }

        // Delete note from modal
        window.deleteNoteFromModal = function (noteId) {
            if (!currentNotesQuestionId) return;

            if (confirm("Czy na pewno chcesz usunƒÖƒá tƒô notatkƒô?")) {
                deleteQuestionNote(currentNotesQuestionId, noteId);
                renderNotesList(currentNotesQuestionId);
            }
        };

        // ========== SPACED REPETITION SYSTEM (SM-2) ==========
        // Get question SRS data from user's flashcardData
        function getQuestionSRSData(questionId) {
            if (!currentUser || !users[currentUser]) return null;

            const userFlashcardData = users[currentUser].flashcardData || {};
            if (!userFlashcardData[questionId]) {
                // Initialize new card with default SM-2 values
                userFlashcardData[questionId] = {
                    easeFactor: 2.5,        // Starting E-Factor
                    interval: 0,             // Days until next review (0 = new)
                    repetitions: 0,          // Number of successful reviews
                    nextReview: null,       // Date of next review
                    lastReview: null         // Date of last review
                };
                safeSetItem("quizUsers", JSON.stringify(users));
            }

            return userFlashcardData[questionId];
        }

        // Check if question is due for review today
        function isQuestionDueForReview(questionId) {
            const data = getQuestionSRSData(questionId);
            if (!data) return true; // New cards are due immediately

            if (!data.nextReview) return true; // No next review date = due

            const now = new Date();
            const nextReview = new Date(data.nextReview);

            return now >= nextReview;
        }

        // SM-2 Algorithm: Calculate next interval based on user response
        function calculateNextSRS(questionId, quality) {
            // Quality: 0-5 rating
            // 0 = complete blackout (forgot entirely)
            // 1 = incorrect but familiar
            // 2 = incorrect but easy to recall
            // 3 = correct with difficulty
            // 4 = correct with hesitation
            // 5 = perfect recall

            const data = getQuestionSRSData(questionId);
            if (!data) return null;

            if (quality < 3) {
                // Failed - reset to start
                data.repetitions = 0;
                data.interval = 1; // Review again tomorrow
                data.easeFactor = Math.max(1.3, data.easeFactor - 0.2); // Decrease E-Factor
            } else {
                // Success - increase interval
                data.repetitions++;

                if (data.repetitions === 1) {
                    data.interval = 1;
                } else if (data.repetitions === 2) {
                    data.interval = 6;
                } else {
                    // SM-2 formula: I(1) = 1, I(2) = 6, for n>2: I(n) = I(n-1) * EF
                    data.interval = Math.round(data.interval * data.easeFactor);
                }

                // Update E-Factor based on quality
                data.easeFactor = data.easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                data.easeFactor = Math.max(1.3, Math.min(2.5, data.easeFactor)); // Clamp between 1.3 and 2.5
            }

            // Calculate next review date
            const now = new Date();
            data.lastReview = now.toISOString();
            data.nextReview = new Date(now.getTime() + data.interval * 24 * 60 * 60 * 1000).toISOString();

            // Save to user data
            users[currentUser].flashcardData = users[currentUser].flashcardData || {};
            users[currentUser].flashcardData[questionId] = data;
            safeSetItem("quizUsers", JSON.stringify(users));

            return data;
        }

        // Get SRS stats for dashboard
        function getSRSStats() {
            if (!currentUser || !users[currentUser]) {
                return { due: 0, learning: 0, reviewed: 0, newCards: 0 };
            }

            const userFlashcardData = users[currentUser].flashcardData || {};
            const now = new Date();

            let due = 0;
            let learning = 0; // Repetitions < 3
            let reviewed = 0; // Repetitions >= 3
            let newCards = 0; // Never reviewed

            questions.forEach(q => {
                const data = userFlashcardData[q.id];
                if (!data) {
                    newCards++;
                    return;
                }

                if (!data.nextReview || now >= new Date(data.nextReview)) {
                    due++;
                }

                if (data.repetitions < 3) {
                    learning++;
                } else {
                    reviewed++;
                }
            });

            return { due, learning, reviewed, newCards };
        }

        // Render SRS dashboard on main dashboard
        function renderSRSDashboard() {
            const container = document.getElementById("analytics-dashboard");
            if (!container) return;

            const stats = getSRSStats();

            // Create SRS dashboard card at the top
            let srsHTML = `
                <div class="srs-dashboard">
                    <h3>üß† Spaced Repetition System</h3>
                    ${stats.due > 0 ? `<div class="srs-due-cards">üìö ${stats.due} fiszek do powt√≥rki dzisiaj!</div>` : ''}
                    <div class="srs-grid">
                        <div class="srs-metric">
                            <div class="srs-metric-value">${stats.due}</div>
                            <div class="srs-metric-label">Do powt√≥rki</div>
                        </div>
                        <div class="srs-metric">
                            <div class="srs-metric-value">${stats.learning}</div>
                            <div class="srs-metric-label">W nauce</div>
                        </div>
                        <div class="srs-metric">
                            <div class="srs-metric-value">${stats.reviewed}</div>
                            <div class="srs-metric-label">Opanowane</div>
                        </div>
                        <div class="srs-metric">
                            <div class="srs-metric-value">${stats.newCards}</div>
                            <div class="srs-metric-label">Nowe</div>
                        </div>
                    </div>
                    <div class="srs-next-review">
                        üìÖ Karta opanowana: po ~${Math.round(stats.reviewed > 0 ? 30 : 1)} dniach
                    </div>
                </div>
            `;

            // Insert SRS dashboard at the beginning of analytics
            container.innerHTML = srsHTML + container.innerHTML;
        }

        // Update renderAnalyticsDashboard to include SRS
        const originalRenderAnalytics = renderAnalyticsDashboard;
        renderAnalyticsDashboard = function () {
            originalRenderAnalytics();
            renderSRSDashboard();
        };

        // ========== PANEL ADMINISTRATORA ==========
        function renderAdminPanel() {
            const container = document.getElementById("admin-users-list");
            container.innerHTML = "";

            if (!currentUser || !users[currentUser].isAdmin) {
                container.innerHTML = "<p>Brak uprawnie≈Ñ dostƒôpu.</p>";
                return;
            }

            // Sortuj u≈ºytkownik√≥w: admini na poczƒÖtku
            const sortedUsernames = Object.keys(users).sort((a, b) => {
                if (users[a].isAdmin && !users[b].isAdmin) return -1;
                if (!users[a].isAdmin && users[b].isAdmin) return 1;
                return a.localeCompare(b);
            });

            if (sortedUsernames.length === 0) {
                container.innerHTML = "<p>Brak u≈ºytkownik√≥w w systemie.</p>";
                return;
            }

            sortedUsernames.forEach(username => {
                const user = users[username];
                const div = document.createElement("div");
                div.className = "question-item";

                const isAdminBadget = user.isAdmin ?
                    '<span style="background: #ffd700; color: #000; padding: 4px 8px; border-radius: 4px; font-weight: bold;">üëë Administrator</span>' :
                    '<span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 4px;">üë§ U≈ºytkownik</span>';

                const isBlockedBadge = user.isBlocked ?
                    '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px;">üö´ Zablokowany</span>' :
                    '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px;">‚úÖ Aktywny</span>';

                const canEditBadge = user.canEditQuestions ?
                    '<span style="background: #007bff; color: white; padding: 4px 8px; border-radius: 4px;">‚úèÔ∏è Mo≈ºe edytowaƒá</span>' :
                    '<span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 4px;">‚ùå Bez edycji</span>';

                const isCurrentUser = username === currentUser;

                let actionsHTML = "";
                if (!isCurrentUser) {
                    // Przycisk nadania/odebrania uprawnie≈Ñ admina
                    if (user.isAdmin) {
                        actionsHTML += `
                            <button onclick="window.revokeAdmin('${username}')" class="btn-warning" style="margin-right: 5px; margin-top: 10px;">
                                ‚¨áÔ∏è Odbierz admina
                            </button>
                        `;
                    } else {
                        actionsHTML += `
                            <button onclick="window.grantAdmin('${username}')" class="btn-success" style="margin-right: 5px; margin-top: 10px;">
                                ‚¨ÜÔ∏è Promuj na admina
                            </button>
                        `;
                    }

                    if (!user.isAdmin) {
                        actionsHTML += `
                            <button onclick="window.blockUser('${username}')" class="btn-danger" style="margin-right: 5px; margin-top: 10px;">
                                ${user.isBlocked ? 'üîì Odblokuj' : 'üö´ Zablokuj'}
                            </button>
                            <button onclick="window.${user.canEditQuestions ? 'revokeEditPermission' : 'grantEditPermission'}('${username}')" class="btn-primary" style="margin-right: 5px; margin-top: 10px;">
                                ${user.canEditQuestions ? '‚ùå Odbierz edycjƒô' : '‚úÖ Nadaj edycjƒô'}
                            </button>
                        `;
                    }
                    actionsHTML += `
                        <button onclick="window.deleteUser('${username}')" class="btn-danger" style="margin-top: 10px;">üóëÔ∏è Usu≈Ñ</button>
                    `;
                } else {
                    actionsHTML = '<p style="color: #6c757d; margin-top: 10px;">To jest Twoje konto - nie mo≈ºesz go modyfikowaƒá</p>';
                }

                div.innerHTML = `
                    <h4>${escapeHTML(username)} ${isAdminBadget}</h4>
                    <p style="margin: 8px 0;">
                        ${isBlockedBadge} ${canEditBadge}
                    </p>
                    <p style="color: #666; font-size: 0.9em;">
                        Zarejestrowany: ${new Date(user.registeredAt || '').toLocaleString("pl-PL")}<br>
                        Ostatnie logowanie: ${new Date(user.lastLogin || '').toLocaleString("pl-PL")}
                    </p>
                    ${actionsHTML}
                `;
                container.appendChild(div);
            });
        }

        function blockUser(username) {
            if (!users[currentUser].isAdmin) {
                showToast("Brak uprawnie≈Ñ!", "error");
                return;
            }

            if (!users[username] || users[username].isAdmin) {
                showToast("Nie mo≈ºna zablokowaƒá administratora!", "error");
                return;
            }

            users[username].isBlocked = true;
            safeSetItem("quizUsers", JSON.stringify(users));
            showToast(`U≈ºytkownik "${username}" zosta≈Ç zablokowany.`, "success");
            renderAdminPanel();
        }

        function unblockUser(username) {
            if (!users[currentUser].isAdmin) {
                showToast("Brak uprawnie≈Ñ!", "error");
                return;
            }

            if (!users[username]) {
                showToast("U≈ºytkownik nie istnieje!", "error");
                return;
            }

            users[username].isBlocked = false;
            safeSetItem("quizUsers", JSON.stringify(users));
            showToast(`U≈ºytkownik "${username}" zosta≈Ç odblokowany.`, "success");
            renderAdminPanel();
        }

        function grantEditPermission(username) {
            if (!users[currentUser].isAdmin) {
                showToast("Brak uprawnie≈Ñ!", "error");
                return;
            }

            if (!users[username]) {
                showToast("U≈ºytkownik nie istnieje!", "error");
                return;
            }

            users[username].canEditQuestions = true;
            safeSetItem("quizUsers", JSON.stringify(users));
            showToast(`U≈ºytkownik "${username}" otrzyma≈Ç uprawnienia do edycji pyta≈Ñ.`, "success");
            renderAdminPanel();
        }

        function revokeEditPermission(username) {
            if (!users[currentUser].isAdmin) {
                showToast("Brak uprawnie≈Ñ!", "error");
                return;
            }

            if (!users[username]) {
                showToast("U≈ºytkownik nie istnieje!", "error");
                return;
            }

            if (username === currentUser) {
                showToast("Nie mo≈ºesz odebraƒá sobie uprawnie≈Ñ!", "error");
                return;
            }

            users[username].canEditQuestions = false;
            safeSetItem("quizUsers", JSON.stringify(users));
            showToast(`U≈ºytkownikowi "${username}" odebrano uprawnienia do edycji pyta≈Ñ.`, "success");
            renderAdminPanel();
        }

        function deleteUser(username) {
            if (!users[currentUser].isAdmin) {
                showToast("Brak uprawnie≈Ñ!", "error");
                return;
            }

            if (username === currentUser) {
                showToast("Nie mo≈ºesz usunƒÖƒá w≈Çasnego konta!", "error");
                return;
            }

            if (users[username].isAdmin) {
                showToast("Nie mo≈ºna usunƒÖƒá administratora!", "error");
                return;
            }

            if (!confirm(`Czy na pewno chcesz usunƒÖƒá u≈ºytkownika "${username}"?`)) {
                return;
            }

            delete users[username];
            safeSetItem("quizUsers", JSON.stringify(users));
            showToast(`U≈ºytkownik "${username}" zosta≈Ç usuniƒôty.`, "success");
            renderAdminPanel();
        }

        function grantAdmin(username) {
            if (!users[currentUser].isAdmin) {
                showToast("Brak uprawnie≈Ñ!", "error");
                return;
            }

            if (!users[username]) {
                showToast("U≈ºytkownik nie istnieje!", "error");
                return;
            }

            if (users[username].isAdmin) {
                showToast("U≈ºytkownik jest ju≈º administratorem!", "warning");
                return;
            }

            if (!confirm(`Czy na pewno chcesz nadaƒá uprawnienia administratora u≈ºytkownikowi "${username}"?`)) {
                return;
            }

            users[username].isAdmin = true;
            safeSetItem("quizUsers", JSON.stringify(users));
            showToast(`U≈ºytkownik "${username}" zosta≈Ç promowany na administratora!`, "success");
            renderAdminPanel();
        }

        function revokeAdmin(username) {
            if (!users[currentUser].isAdmin) {
                showToast("Brak uprawnie≈Ñ!", "error");
                return;
            }

            if (username === currentUser) {
                showToast("Nie mo≈ºesz odbiƒá sobie uprawnie≈Ñ administratora!", "error");
                return;
            }

            if (!users[username]) {
                showToast("U≈ºytkownik nie istnieje!", "error");
                return;
            }

            if (!users[username].isAdmin) {
                showToast("U≈ºytkownik nie jest administratorem!", "warning");
                return;
            }

            // Sprawd≈∫ czy to nie jest ostatni admin
            const adminCount = Object.values(users).filter(u => u.isAdmin).length;
            if (adminCount <= 1) {
                showToast("Nie mo≈ºesz odbiƒá uprawnie≈Ñ - to jest ostatni administrator!", "error");
                return;
            }

            if (!confirm(`Czy na pewno chcesz odebraƒá uprawnienia administratora u≈ºytkownikowi "${username}"?`)) {
                return;
            }

            users[username].isAdmin = false;
            safeSetItem("quizUsers", JSON.stringify(users));
            showToast(`U≈ºytkownik "${username}" przesta≈Ç byƒá administratorem.`, "success");
            renderAdminPanel();
        }

        // ========== WYNIKI ==========
        function exportResults() {
            const results = users[currentUser].testResults || [];

            if (results.length === 0) {
                showToast("Brak wynik√≥w do eksportu!", "warning");
                return;
            }

            // Nag≈Ç√≥wek CSV
            let csv = "Data,Tryb,Wynik,Poprawne,≈ÅƒÖcznie,Kategoria\n";

            // Dodaj wyniki
            results.forEach(r => {
                const date = new Date(r.date).toLocaleString("pl-PL");
                const mode = r.mode === "practice" ? "Nauka" : "Test";
                const category = r.category ? r.category.replace(/"/g, '""') : 'Wszystkie';
                const score = r.score;
                const correct = r.correct;
                const total = r.total;

                // Format CSV z quoted strings (dla obs≈Çugi przecink√≥w i cudzys≈Çow√≥w)
                csv += `"${date}","${mode}",${score},${correct},${total},"${category}"\n`;
            });

            // Utw√≥rz Blob i pobierz plik
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);

            link.setAttribute("href", url);
            link.setAttribute("download", `wyniki_${currentUser}_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Zwolnij URL
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }

        // ========== PE≈ÅNY BACKUP ==========
        function fullBackup() {
            // Zbierz wszystkie dane do backupu
            const backupData = {
                version: "1.0",
                timestamp: new Date().toISOString(),
                data: {
                    users: users,  // Wszyscy u≈ºytkownicy z hashowanymi has≈Çami i wynikami
                    questions: questions,  // Wszystkie pytania z obrazami (Base64)
                    settings: {
                        currentTheme: localStorage.getItem("quizTheme") || "light"
                    }
                }
            };

            // Konwertuj na JSON
            const json = JSON.stringify(backupData, null, 2);

            // Utw√≥rz Blob i pobierz plik
            const blob = new Blob([json], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);

            link.setAttribute("href", url);
            // Nazwa pliku z datƒÖ: quiz_backup_2025-01-06_14-30-45.json
            const date = new Date();
            const dateStr = date.toISOString().slice(0, 10);  // 2025-01-06
            const timeStr = date.toTimeString().slice(0, 8).replace(/:/g, "-");  // 14-30-45
            link.setAttribute("download", `quiz_backup_${dateStr}_${timeStr}.json`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Zwolnij URL
            setTimeout(() => URL.revokeObjectURL(url), 100);

            showToast("Pƒôkny backup zosta≈Ç utworzony i pobrany!", "success");
        }

        // ========== IMPORT BACKUPU ==========
        function importBackup() {
            const fileInput = document.getElementById("backupFileInput");

            if (!fileInput.files || fileInput.files.length === 0) {
                showToast("Wybierz plik backupu!", "error");
                return;
            }

            const file = fileInput.files[0];

            // Walidacja rozszerzenia
            if (!file.name.endsWith('.json')) {
                showToast("Plik musi mieƒá rozszerzenie .json!", "error");
                return;
            }

            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const backupData = JSON.parse(e.target.result);

                    // Walidacja struktury
                    if (!backupData.version || !backupData.data || !backupData.data.users || !backupData.data.questions) {
                        showToast("Nieprawid≈Çowy format pliku backupu!", "error");
                        return;
                    }

                    // Potwierdzenie importu
                    if (!confirm("Czy na pewno chcesz przywr√≥ciƒá dane z backupu?\n\nWszystkie obecne dane zostanƒÖ nadpisane!\n\nU≈ºytkownicy: " + Object.keys(backupData.data.users).length + "\nPytania: " + backupData.data.questions.length)) {
                        return;
                    }

                    // Przywr√≥ƒá dane
                    safeSetItem("quizUsers", JSON.stringify(backupData.data.users));
                    safeSetItem("quizQuestions", JSON.stringify(backupData.data.questions));

                    // Przywr√≥ƒá motyw je≈õli istnieje
                    if (backupData.data.settings && backupData.data.settings.currentTheme) {
                        safeSetItem("quizTheme", backupData.data.settings.currentTheme);
                    }

                    showToast("Dane zosta≈Çy pomy≈õlnie przywr√≥cone! Strona zostanie od≈õwie≈ºona...", "success");

                    // Od≈õwie≈º stronƒô po 2 sekundach
                    setTimeout(() => {
                        location.reload();
                    }, 2000);

                } catch (error) {
                    console.error("B≈ÇƒÖd importu:", error);
                    showToast("B≈ÇƒÖd podczas importu pliku: " + error.message, "error");
                }
            };

            reader.onerror = function () {
                showToast("B≈ÇƒÖd podczas czytania pliku!", "error");
            };

            reader.readAsText(file);
        }

        function renderResults() {
            const container = document.getElementById("results-list");
            container.innerHTML = "";

            if (!currentUser || !users[currentUser] || !users[currentUser].testResults) {
                container.innerHTML = "<p>Brak wynik√≥w.</p>";
                return;
            }

            (users[currentUser].testResults || []).forEach((r, i) => {
                const div = document.createElement("div");
                div.className = "question-item";

                const modeLabel = r.mode === "practice" ? "üìö Nauka" : "üìù Test";
                const hasDetails = r.detailedAnswers && r.detailedAnswers.length > 0;

                div.innerHTML = `
                    <h4>${modeLabel} #${i + 1}</h4>
                    <p>Data: ${new Date(r.date).toLocaleString("pl-PL")}</p>
                    <p>Wynik: ${r.correct}/${r.total} (${r.score}%)</p>
                    ${hasDetails ? `<button onclick="window.showDetailedResults(${i})" class="btn-primary" style="margin-top: 10px;">üìã Szczeg√≥≈Çy</button>` : ''}
                `;
                container.appendChild(div);
            });
        }

        // ========== SZCZEG√ì≈ÅOWE WYNIKI ==========
        let currentDetailedResultIndex = null;

        function showDetailedResults(index) {
            currentDetailedResultIndex = index;
            showSection("detailed-results");
        }

        // ========== OZNACZANIE DO POWT√ìRKI ==========
        function toggleMarkForReview(questionIndex) {
            const result = users[currentUser].testResults[currentDetailedResultIndex];
            if (!result || !result.detailedAnswers) return;

            const answer = result.detailedAnswers[questionIndex];
            if (!answer || !answer.questionId) return;

            // Znajd≈∫ pytanie w bazie
            const qIdx = questions.findIndex(q => q.id === answer.questionId);
            if (qIdx === -1) return;

            // Prze≈ÇƒÖcz stan markedForReview
            questions[qIdx].markedForReview = !questions[qIdx].markedForReview;

            // Zapisz
            safeSetItem("quizQuestions", JSON.stringify(questions));

            // Od≈õwie≈º widok
            renderDetailedResults();

            // Poka≈º powiadomienie
            const isMarked = questions[qIdx].markedForReview;
            showToast(isMarked ? '‚≠ê Pytanie oznaczone do powt√≥rki!' : 'Pytanie usuniƒôte z powt√≥rek', isMarked ? 'success' : 'info', 2000);
        }

        function isQuestionMarkedForReview(questionId) {
            const question = questions.find(q => q.id === questionId);
            return question && question.markedForReview;
        }

        function renderDetailedResults() {
            const container = document.getElementById("detailed-results-content");
            container.innerHTML = "";

            if (!currentUser || !users[currentUser] || currentDetailedResultIndex === null) {
                container.innerHTML = "<p>B≈ÇƒÖd: brak danych.</p>";
                return;
            }

            const result = users[currentUser].testResults[currentDetailedResultIndex];

            if (!result || !result.detailedAnswers || result.detailedAnswers.length === 0) {
                container.innerHTML = "<p>Brak szczeg√≥≈Çowych danych dla tego testu.</p>";
                return;
            }

            // Oblicz statystyki
            let correctCount = 0;
            let incorrectCount = 0;
            let skippedCount = 0;

            result.detailedAnswers.forEach(a => {
                if (a.isSkipped) skippedCount++;
                else if (a.isCorrect) correctCount++;
                else incorrectCount++;
            });

            // Nag≈Ç√≥wek z podsumowaniem
            const summaryHTML = `
                <div class="detailed-result-summary">
                    <h3>üìã Szczeg√≥≈Çowe wyniki - ${result.mode === "practice" ? "Sesja nauki" : "Test"}</h3>
                    <p>Data: ${new Date(result.date).toLocaleString("pl-PL")}</p>
                    <br>
                    <div class="result-badge score">${result.score}%</div>
                    <br><br>
                    <div class="result-badge correct">‚úÖ Poprawne: ${correctCount}</div>
                    <div class="result-badge incorrect">‚ùå B≈Çƒôdne: ${incorrectCount}</div>
                    ${skippedCount > 0 ? `<div class="result-badge skipped">‚è≠Ô∏è Pominiƒôte: ${skippedCount}</div>` : ''}
                    <br><br>
                    <button onclick="window.showSection('results')" class="btn-secondary back-btn">‚¨ÖÔ∏è Wr√≥ƒá do listy wynik√≥w</button>
                </div>
            `;

            container.innerHTML = summaryHTML;

            // Wy≈õwietl pytania
            result.detailedAnswers.forEach((answer, qIndex) => {
                const questionDiv = document.createElement("div");

                let statusClass = "";
                let statusBadge = "";

                if (answer.isSkipped) {
                    statusClass = "skipped-answer";
                    statusBadge = `<span class="review-status" style="background: #ffc107; color: #333;">‚è≠Ô∏è Pominiƒôte</span>`;
                } else if (answer.isCorrect) {
                    statusClass = "correct-answer";
                    statusBadge = `<span class="review-status" style="background: #28a745; color: white;">‚úÖ Poprawne</span>`;
                } else {
                    statusClass = "incorrect-answer";
                    statusBadge = `<span class="review-status" style="background: #dc3545; color: white;">‚ùå B≈Çƒôdne</span>`;
                }

                questionDiv.className = `question-review-item ${statusClass}`;

                // Dla ordering - inne renderowanie
                if (answer.questionType === "ordering") {
                    const userOrdering = answer.userAnswers || {};
                    const steps = answer.options || [];

                    // Poka≈º kolejno≈õƒá jakƒÖ wybra≈Ç u≈ºytkownik vs poprawna
                    let userSequenceHTML = "";
                    let correctSequenceHTML = "";

                    steps.forEach((step, stepIndex) => {
                        const stepNum = stepIndex + 1;
                        const userPos = userOrdering[stepNum];

                        userSequenceHTML += `<div style="padding: 5px; margin: 2px 0; background: #f8f9fa;">${stepNum}. ‚Üí ${userPos ? 'pozycja ' + userPos : '<span style="color: #dc3545;">brak</span>'}: ${escapeHTML(step)}</div>`;
                        correctSequenceHTML += `<div style="padding: 5px; margin: 2px 0; background: #d4edda;">${stepNum}. ‚Üí pozycja ${stepNum}: ${escapeHTML(step)}</div>`;
                    });

                    questionDiv.innerHTML = `
                        <h4>Pytanie ${qIndex + 1} ${statusBadge}</h4>
                        ${answer.category ? `<span class="category-badge">üìÅ ${escapeHTML(answer.category)}</span>` : ""}
                        ${answer.tags && answer.tags.length > 0 ? (answer.tags || []).map(tag => `<span class="tag">üè∑Ô∏è ${escapeHTML(tag)}</span>`).join("") : ""}
                        <div style="font-size: 1em; margin: 10px 0; white-space: pre-wrap; word-wrap: break-word; line-height: 1.6;">${sanitizeHTML(answer.questionText)}</div>

                        <div style="margin: 15px 0;">
                            <h5>Twoja odpowied≈∫:</h5>
                            ${userSequenceHTML}

                            <h5 style="margin-top: 15px;">Poprawna kolejno≈õƒá:</h5>
                            ${correctSequenceHTML}
                        </div>

                        ${answer.explanation ? `
                            <div class="explanation-box">
                                <strong>üí° Wyja≈õnienie:</strong><br>
                                <div style="white-space: pre-wrap; word-wrap: break-word; line-height: 1.6;">${sanitizeHTML(answer.explanation)}</div>
                            </div>
                        ` : ""}
                    `;

                    container.appendChild(questionDiv);
                    return; // Skip the rest for ordering
                }

                // Renderowanie opcji (dla single/multiple)
                const optionsHTML = (answer.options || []).map((opt, i) => {
                    const optionNumber = i + 1;
                    const isCorrectAnswer = (answer.correctAnswers || []).includes(optionNumber);
                    const isUserSelected = (answer.userAnswers || []).includes(optionNumber);
                    const isIncorrectSelection = isUserSelected && !isCorrectAnswer;

                    let optionClass = "review-option";
                    if (isIncorrectSelection) {
                        optionClass += " incorrect-selection";
                    } else if (isUserSelected && isCorrectAnswer) {
                        optionClass += " user-selected";
                    } else if (isCorrectAnswer) {
                        optionClass += " correct-answer";
                    }

                    let icons = "";
                    if (isIncorrectSelection) {
                        icons = " ‚ùå";
                    } else if (isUserSelected && isCorrectAnswer) {
                        icons = " ‚úÖ";
                    } else if (isCorrectAnswer) {
                        icons = " ‚úì";
                    } else if (isUserSelected) {
                        icons = " ‚Üí";
                    }

                    return `<div class="${optionClass}">${optionNumber}. ${escapeHTML(opt)}${icons}</div>`;
                }).join("");

                questionDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                        <h4 style="margin: 0;">Pytanie ${qIndex + 1} ${statusBadge}</h4>
                        <button onclick="window.toggleMarkForReview(${qIndex})" class="btn-secondary" style="padding: 5px 10px; font-size: 14px; white-space: nowrap; flex-shrink: 0;">
                            ${isQuestionMarkedForReview(answer.questionId) ? '‚≠ê Usu≈Ñ z powt√≥rek' : '‚≠ê Oznacz do powt√≥rki'}
                        </button>
                    </div>
                    ${answer.category ? `<span class="category-badge">üìÅ ${escapeHTML(answer.category)}</span>` : ""}
                    ${answer.tags && answer.tags.length > 0 ? (answer.tags || []).map(tag => `<span class="tag">üè∑Ô∏è ${escapeHTML(tag)}</span>`).join("") : ""}
                    ${(() => {
                        const question = questions.find(q => q.id === answer.questionId);
                        return question && question.imageData && question.imageData.startsWith('data:') ? `<img src="${question.imageData}" loading="lazy" style="max-width: 100%; max-height: 400px; margin: 10px 0; border-radius: 8px; border: 2px solid #ddd; display: block;" alt="Obraz do pytania">` : '';
                    })()}
                    <div style="font-size: 1em; margin: 10px 0; white-space: pre-wrap; word-wrap: break-word; line-height: 1.6;">${sanitizeHTML(answer.questionText)}</div>
                    <div style="margin: 15px 0;">
                        ${optionsHTML}
                    </div>
                    ${answer.explanation ? `
                        <div class="explanation-box">
                            <strong>üí° Wyja≈õnienie:</strong><br>
                            <div style="white-space: pre-wrap; word-wrap: break-word; line-height: 1.6;">${sanitizeHTML(answer.explanation)}</div>
                        </div>
                    ` : ""}
                    ${!answer.isSkipped && !answer.isCorrect ? `
                        <p style="color: #666; margin-top: 10px;">
                            <strong>Twoja odpowied≈∫:</strong> ${(answer.userAnswers || []).sort((a, b) => a - b).join(", ")}<br>
                            <strong>Poprawna odpowied≈∫:</strong> ${(answer.correctAnswers || []).sort((a, b) => a - b).join(", ")}
                        </p>
                    ` : ""}
                `;

                container.appendChild(questionDiv);
            });

            // Przycisk powrotu na ko≈Ñcu
            const backBtn = document.createElement("button");
            backBtn.className = "btn-primary back-btn";
            backBtn.style.width = "100%";
            backBtn.style.marginBottom = "20px";
            backBtn.textContent = "‚¨ÖÔ∏è Wr√≥ƒá do listy wynik√≥w";
            backBtn.onclick = () => showSection("results");
            container.appendChild(backBtn);
        }

        // EKSPORT FUNKCJI
        window.showSection = showSection;
        window.showAddQuestionForm = showAddQuestionForm;
        window.hideAddQuestionForm = hideAddQuestionForm;
        window.editQuestion = editQuestion;
        window.deleteQuestion = deleteQuestion;
        window.exportQuestions = exportQuestions;
        window.exportQuestionsJSON = exportQuestionsJSON;
        window.importQuestions = importQuestions;
        window.importQuestionsJSON = importQuestionsJSON;
        window.startTest = startTest;
        window.startFlashcards = startFlashcards;
        window.flipCard = flipCard;
        window.rateFlashcard = rateFlashcard;
        window.rateFlashcardSRS = rateFlashcardSRS;
        window.exitFlashcards = exitFlashcards;
        window.startPractice = startPractice;
        window.togglePracticeOption = togglePracticeOption;
        window.checkPracticeAnswer = checkPracticeAnswer;
        window.nextPracticeQuestion = nextPracticeQuestion;
        window.exitPractice = exitPractice;

        window.previousQuestion = previousQuestion;
        window.nextQuestion = nextQuestion;
        window.finishTest = finishTest;
        window.selectOption = selectOption;
        window.logout = logout;
        window.showRegisterForm = showRegisterForm;
        window.showLoginForm = showLoginForm;
        window.showDetailedResults = showDetailedResults;
        window.toggleMarkForReview = toggleMarkForReview;
        window.exportResults = exportResults;
        window.fullBackup = fullBackup;
        window.importBackup = importBackup;

        // Bottom navigation functions
        window.toggleBottomNavMore = toggleBottomNavMore;
        window.updateBottomNavActive = updateBottomNavActive;


        // Funkcje kategorii i tag√≥w
        window.addTag = addTag;
        window.removeTag = removeTag;

        // NOWE: Funkcje wyszukiwarki i filtr√≥w
        window.filterQuestions = filterQuestions;
        window.clearFilters = clearFilters;
        window.toggleSection = toggleSection;
        window.toggleDarkMode = toggleDarkMode;
        window.setTheme = setTheme;

        // Loading spinner functions
        window.showLoading = showLoading;
        window.hideLoading = hideLoading;

        // Validation functions
        window.validateUsername = validateUsername;


        // Funkcje zarzƒÖdzania odpowiedziami
        window.addOption = addOption;
        window.removeOption = removeOption;
        window.handleQuestionTypeChange = handleQuestionTypeChange;
        window.handleCorrectSelection = handleCorrectSelection;
        window.updateLivePreview = updateLivePreview;

        // Funkcje administratora
        window.blockUser = blockUser;
        window.unblockUser = unblockUser;
        window.grantEditPermission = grantEditPermission;
        window.revokeEditPermission = revokeEditPermission;
        window.deleteUser = deleteUser;
        window.grantAdmin = grantAdmin;
        window.revokeAdmin = revokeAdmin;
        window.showToast = showToast;

        // ========== OBS≈ÅUGA OBRAZ√ìW W PYTANIACH ==========
        let currentImageData = null;  // Przechowuje Base64 obrazu

        // ========== IMAGE COMPRESSION FUNCTION ==========
        /**
         * Kompresuje obraz do mniejszego rozmiaru
         * @param {string} base64String - Obraz w formacie Base64
         * @param {number} maxWidth - Maksymalna szeroko≈õƒá (domy≈õlnie 800px)
         * @param {number} quality - Jako≈õƒá kompresji 0.0-1.0 (domy≈õlnie 0.7)
         * @returns {Promise<string>} Skompresowany obraz w Base64
         */
        function compressImage(base64String, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const img = new Image();

                img.onload = function () {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Oblicz nowe wymiary (zachowaj proporcje)
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        // Rysuj obraz na canvas
                        ctx.drawImage(img, 0, 0, width, height);

                        // Konwertuj na Base64 z kompresjƒÖ
                        const compressedBase64 = canvas.toDataURL('image/jpeg', quality);

                        // Oblicz oszczƒôdno≈õƒá rozmiaru
                        const originalSize = Math.round(base64String.length * 0.75);
                        const compressedSize = Math.round(compressedBase64.length * 0.75);
                        const savings = Math.round((1 - compressedSize / originalSize) * 100);

                        console.log(`Kompresja obrazu: ${formatFileSize(originalSize)} ‚Üí ${formatFileSize(compressedSize)} (oszczƒôdno≈õƒá ${savings}%)`);

                        resolve(compressedBase64);
                    } catch (error) {
                        console.error('B≈ÇƒÖd kompresji obrazu:', error);
                        reject(error);
                    }
                };

                img.onerror = function () {
                    reject(new Error('Nie uda≈Ço siƒô za≈Çadowaƒá obrazu do kompresji'));
                };

                img.src = base64String;
            });
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Sprawd≈∫ czy to obraz
            if (!file.type.startsWith('image/')) {
                showToast('‚ö†Ô∏è Wybrany plik nie jest obrazem!', 'error');
                event.target.value = '';
                return;
            }

            // Sprawd≈∫ rozmiar (max 5MB przed kompresjƒÖ)
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                showToast('‚ö†Ô∏è Obraz jest za du≈ºy! Maksymalny rozmiar: 5MB', 'error');
                event.target.value = '';
                return;
            }

            // Poka≈º loading overlay
            showLoading('Kompresowanie obrazu...');

            // Wczytaj obraz i przekonwertuj na Base64
            const reader = new FileReader();
            reader.onload = async function (e) {
                try {
                    const originalBase64 = e.target.result;

                    // Kompresuj obraz
                    const compressedBase64 = await compressImage(originalBase64, 800, 0.7);
                    currentImageData = compressedBase64;

                    // Oblicz rozmiary
                    const originalSize = Math.round(originalBase64.length * 0.75);
                    const compressedSize = Math.round(compressedBase64.length * 0.75);
                    const savings = Math.round((1 - compressedSize / originalSize) * 100);

                    // Poka≈º podglƒÖd
                    const preview = document.getElementById("imagePreview");
                    const container = document.getElementById("imagePreviewContainer");
                    const sizeInfo = document.getElementById("imageSizeInfo");

                    preview.src = currentImageData;
                    container.style.display = "block";
                    sizeInfo.textContent = `Przed: ${formatFileSize(originalSize)} ‚Üí Po: ${formatFileSize(compressedSize)} (oszczƒôdno≈õƒá ${savings}%)`;

                    // Aktualizuj podglƒÖd na ≈ºywo
                    updateLivePreview();

                    showToast(`‚úÖ Obraz skompresowany! Oszczƒôdno≈õƒá: ${savings}%`, 'success', 3000);
                } catch (error) {
                    console.error('B≈ÇƒÖd przetwarzania obrazu:', error);
                    showToast('‚ùå B≈ÇƒÖd podczas przetwarzania obrazu', 'error');
                    event.target.value = '';
                } finally {
                    hideLoading();
                }
            };
            reader.onerror = function () {
                hideLoading();
                showToast(t('alertImageError'), 'error');
                event.target.value = '';
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            currentImageData = null;

            // Wyczy≈õƒá input i podglƒÖd
            document.getElementById("questionImage").value = "";
            document.getElementById("imagePreviewContainer").style.display = "none";
            document.getElementById("imagePreview").src = "";
            document.getElementById("imageSizeInfo").textContent = "";

            // Aktualizuj podglƒÖd na ≈ºywo
            updateLivePreview();

            showToast('Obraz usuniƒôty', 'info', 2000);
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Eksport funkcji obraz√≥w
        window.handleImageUpload = handleImageUpload;
        window.removeImage = removeImage;
    </script>

    <!-- Bottom Navigation (Mobile only) -->
    <div class="bottom-nav" id="bottomNav">
        <button class="bottom-nav-item" data-section="dashboard" onclick="window.showSection('dashboard')">
            <span class="nav-icon">üìä</span>
            <span class="nav-label">Dashboard</span>
        </button>
        <button class="bottom-nav-item" data-section="practice" onclick="window.showSection('practice')">
            <span class="nav-icon">üìö</span>
            <span class="nav-label">Nauka</span>
        </button>
        <button class="bottom-nav-item" data-section="flashcards" onclick="window.showSection('flashcards')">
            <span class="nav-icon">üé¥</span>
            <span class="nav-label">Fiszki</span>
        </button>
        <button class="bottom-nav-item" data-section="test" onclick="window.showSection('test')">
            <span class="nav-icon">üìù</span>
            <span class="nav-label">Test</span>
        </button>
        <button class="bottom-nav-item" data-section="questions" onclick="window.showSection('questions')">
            <span class="nav-icon">‚ùì</span>
            <span class="nav-label">Pytania</span>
        </button>
        <button class="bottom-nav-item" data-section="results" onclick="window.showSection('results')">
            <span class="nav-icon">üèÜ</span>
            <span class="nav-label">Wyniki</span>
        </button>
        <button class="bottom-nav-item" id="bottomNavMoreBtn" onclick="window.toggleBottomNavMore()">
            <span class="nav-icon">‚ãØ</span>
            <span class="nav-label">Wiƒôcej</span>
        </button>
    </div>

    <!-- Bottom Nav More Menu -->
    <div class="bottom-nav-more" id="bottomNavMoreMenu">
        <button onclick="window.showSection('admin')" class="admin-only" id="bottomNavAdmin">
            üîê Panel Administratora
        </button>
        <button onclick="window.logout()">
            üö™ Wyloguj
        </button>
    </div>
</body>

</html>
